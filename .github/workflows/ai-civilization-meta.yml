# AI Civilization Meta Agent
# Weekly self-improvement engine - evolves agents within constitutional bounds

name: AI Civilization Meta Agent

on:
  schedule:
    # Weekly on Sunday at 3 AM CST (9 AM UTC)
    - cron: '0 9 * * 0'
  repository_dispatch:
    types: [meta_dispatch]
  workflow_dispatch:
    inputs:
      focus:
        description: 'Specific area to improve (optional)'
        required: false
        type: string

jobs:
  meta-agent:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    if: ${{ vars.AI_COMPANY_ENABLED == 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for trend analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Meta Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          claude-code --print "
          You are the Quoted Meta Agent - the self-improvement engine.

          Read your specification from .ai-company/agents/meta/AGENT.md
          Read your current state from .ai-company/agents/meta/state.md
          Analyze last week's performance from .ai-company/state/weekly/

          Your responsibilities:
          1. Review all agent performance metrics from the past week
          2. Identify patterns in failures, escalations, and successes
          3. Propose improvements to agent specifications (within constitutional limits)
          4. Update shared knowledge in .ai-company/shared/knowledge/
          5. Draft weekly summary for Eddie

          Constitutional Limits:
          - Can PROPOSE spec changes, never directly modify agent cores
          - Cannot expand any agent's blast radius
          - Cannot add new external API access
          - Cannot modify constitutional limits of other agents
          - All spec changes go to .ai-company/pending/spec-changes/ for approval

          Focus on: efficiency, accuracy, user satisfaction trends.

          Update your state file with analysis.
          "

      - name: Commit State Changes
        if: success()
        run: |
          git config --local user.email "ai-company@quoted.it.com"
          git config --local user.name "Quoted Meta Agent"
          git add .ai-company/agents/meta/ .ai-company/state/weekly/ .ai-company/pending/
          git diff --cached --quiet || git commit -m "Meta Agent: Weekly analysis $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push || echo "No changes to push"

      - name: Self-Dispatch Check
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check for emergency stop
          if [ -f ".ai-company/EMERGENCY_STOP" ]; then
            echo "ðŸ›‘ EMERGENCY_STOP detected. Halting self-dispatch."
            exit 0
          fi

          # Read iteration count
          ITERATION_FILE=".ai-company/agents/meta/iteration.md"
          if [ -f "$ITERATION_FILE" ]; then
            ITERATION=$(grep -oP 'iteration: \K\d+' "$ITERATION_FILE" || echo 0)
          else
            ITERATION=0
          fi
          MAX_ITERATIONS=2

          # Check if completion promise was output
          STATE_FILE=".ai-company/agents/meta/state.md"
          if grep -q "WEEKLY ANALYSIS COMPLETE" "$STATE_FILE" 2>/dev/null; then
            echo "âœ… Completion promise found. Work complete."
            # Reset iteration counter
            echo -e "---\niteration: 0\nlast_reset: $(date -u +%Y-%m-%dT%H:%M:%SZ)\n---" > "$ITERATION_FILE"
            git add "$ITERATION_FILE" && git commit -m "Meta: Reset iteration counter" && git push || true
            exit 0
          fi

          # Check iteration limit
          if [ "$ITERATION" -ge "$MAX_ITERATIONS" ]; then
            echo "âš ï¸ Max iterations ($MAX_ITERATIONS) reached. Manual review required."
            exit 0
          fi

          # Increment and self-dispatch
          NEW_ITERATION=$((ITERATION + 1))
          echo -e "---\niteration: $NEW_ITERATION\nlast_run: $(date -u +%Y-%m-%dT%H:%M:%SZ)\n---" > "$ITERATION_FILE"
          git add "$ITERATION_FILE" && git commit -m "Meta: Iteration $NEW_ITERATION" && git push || true

          echo "ðŸ”„ Self-dispatching iteration $NEW_ITERATION of $MAX_ITERATIONS..."
          sleep 60  # Cooldown
          gh workflow run ai-civilization-meta.yml

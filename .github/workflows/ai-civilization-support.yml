# AI Civilization Support Agent
# Handles customer emails, support tickets, and FAQ management

name: AI Civilization Support Agent

on:
  repository_dispatch:
    types: [support_dispatch]
  workflow_dispatch:
    inputs:
      task:
        description: 'Specific support task to run'
        required: false
        type: string

jobs:
  support-agent:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    if: ${{ vars.AI_COMPANY_ENABLED == 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Support Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          QUOTED_API_URL: ${{ vars.QUOTED_API_URL }}
        run: |
          claude-code --print "
          You are the Quoted Support Agent.

          Read your specification from .ai-company/agents/support/AGENT.md
          Read your current state from .ai-company/agents/support/state.md
          Read the event payload from the dispatch if available.

          Your responsibilities:
          1. Process incoming customer emails (via Resend webhooks)
          2. Draft responses using templates from your knowledge base
          3. Categorize and prioritize tickets
          4. Update FAQ when patterns emerge
          5. Escalate complex issues to Eddie

          Constitutional Limits:
          - Draft emails only, never send without approval for first-time templates
          - After 5 successful uses of a template, you may send autonomously
          - Never promise refunds or make commitments exceeding your authority
          - Always maintain professional, helpful tone

          Update your state file when done.
          "

      - name: Commit State Changes
        if: success()
        run: |
          git config --local user.email "ai-company@quoted.it.com"
          git config --local user.name "Quoted Support Agent"
          git add .ai-company/agents/support/
          git diff --cached --quiet || git commit -m "Support Agent: Update $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push || echo "No changes to push"

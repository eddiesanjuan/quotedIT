<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>quoted.it - Voice to Quote</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-card: #1a1a1a;
            --bg-elevated: #222222;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --accent: #ffffff;
            --accent-hover: #e0e0e0;
            --border: rgba(255, 255, 255, 0.1);
            --border-hover: rgba(255, 255, 255, 0.2);
            --success: #4ade80;
            --warning: #fbbf24;
            --error: #f87171;
            --font-serif: 'Playfair Display', Georgia, serif;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .animate-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .animate-in-delayed {
            animation: fadeIn 0.6s ease-out 0.2s forwards;
            opacity: 0;
        }

        /* Layout */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 24px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, var(--bg-primary) 0%, transparent 100%);
        }

        .logo {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 500;
            letter-spacing: -0.02em;
            color: var(--text-primary);
            text-decoration: none;
        }

        .logo span {
            font-style: italic;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .nav-user {
            text-align: right;
        }

        .nav-user .business-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .nav-user .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            font-family: var(--font-sans);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: color 0.3s ease;
            margin-top: 4px;
        }

        .nav-user .logout-btn:hover {
            color: var(--text-primary);
        }

        /* Main Content */
        main {
            min-height: 100vh;
            padding-top: 120px;
            padding-bottom: 80px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            transition: border-color 0.3s ease;
        }

        .card:hover {
            border-color: var(--border-hover);
        }

        .card-title {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            font-weight: 500;
            margin-bottom: 24px;
            letter-spacing: -0.02em;
        }

        /* Typography */
        h1 {
            font-family: var(--font-serif);
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            font-weight: 400;
            line-height: 1.1;
            letter-spacing: -0.03em;
        }

        h2 {
            font-family: var(--font-serif);
            font-size: 2rem;
            font-weight: 400;
            letter-spacing: -0.02em;
        }

        h3 {
            font-family: var(--font-sans);
            font-size: 1.125rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .hero-text {
            font-family: var(--font-serif);
            font-size: clamp(2rem, 6vw, 3.5rem);
            font-weight: 400;
            line-height: 1.2;
            letter-spacing: -0.02em;
            margin-bottom: 48px;
        }

        .hero-text em {
            font-style: italic;
        }

        /* Auth Forms */
        .auth-container {
            max-width: 440px;
            margin: 0 auto;
            padding-top: 60px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .auth-header h1 {
            margin-bottom: 16px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 32px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .auth-tab {
            flex: 1;
            padding: 14px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.8125rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: var(--font-sans);
            transition: all 0.3s ease;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--text-primary);
            background: var(--bg-elevated);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 32px;
            border-radius: 8px;
            border: none;
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-elevated);
            border-color: var(--border-hover);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 10px 16px;
        }

        .btn-ghost:hover {
            color: var(--text-primary);
        }

        .btn-block {
            display: flex;
            width: 100%;
        }

        /* Voice Input */
        .voice-section {
            text-align: center;
            padding: 60px 40px;
        }

        .record-btn {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 2px solid var(--text-primary);
            background: transparent;
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .record-btn::before {
            content: '';
            position: absolute;
            inset: 4px;
            border-radius: 50%;
            background: transparent;
            transition: all 0.4s ease;
        }

        .record-btn:hover {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .record-btn.recording {
            background: var(--text-primary);
            color: var(--bg-primary);
            animation: pulse 2s infinite;
        }

        .record-btn.recording::before {
            background: var(--error);
            inset: 50px;
        }

        .record-instructions {
            margin-top: 24px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .text-divider {
            display: flex;
            align-items: center;
            gap: 24px;
            margin: 48px 0;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .text-divider::before,
        .text-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 80px 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 2px solid var(--border);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        .loading-text {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Quote Result */
        .quote-result {
            display: none;
        }

        .quote-result.active {
            display: block;
        }

        .quote-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .quote-header h2 {
            font-family: var(--font-serif);
            font-size: 2rem;
        }

        .confidence-badge {
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .confidence-high {
            background: rgba(74, 222, 128, 0.15);
            color: var(--success);
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        .confidence-medium {
            background: rgba(251, 191, 36, 0.15);
            color: var(--warning);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .confidence-low {
            background: rgba(248, 113, 113, 0.15);
            color: var(--error);
            border: 1px solid rgba(248, 113, 113, 0.3);
        }

        .job-description {
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 32px;
            line-height: 1.7;
            color: var(--text-secondary);
            border-left: 3px solid var(--text-primary);
        }

        /* Line Items */
        .line-items {
            margin-bottom: 32px;
        }

        .line-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
        }

        .line-item:last-child {
            border-bottom: none;
        }

        .line-item-info {
            flex: 1;
        }

        .line-item-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .line-item-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .line-item-amount {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-weight: 500;
            margin-left: 24px;
        }

        /* Total */
        .quote-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 32px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-top: 32px;
        }

        .total-label {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }

        .total-amount {
            font-family: var(--font-serif);
            font-size: 3rem;
            font-weight: 500;
            letter-spacing: -0.02em;
        }

        /* Notes */
        .quote-notes {
            margin-top: 32px;
            padding: 24px;
            background: rgba(251, 191, 36, 0.08);
            border-radius: 12px;
            border-left: 3px solid var(--warning);
        }

        .quote-notes h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--warning);
            margin-bottom: 12px;
        }

        .quote-notes p {
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Transcription */
        .transcription {
            margin-top: 32px;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
            font-style: italic;
            color: var(--text-muted);
            font-size: 0.875rem;
            line-height: 1.7;
        }

        .transcription::before {
            content: '"';
            font-family: var(--font-serif);
            font-size: 2rem;
            color: var(--text-muted);
            display: block;
            margin-bottom: 8px;
        }

        /* Quote Actions */
        .quote-actions {
            display: flex;
            gap: 12px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        /* Messages */
        .message {
            display: none;
            padding: 16px 20px;
            border-radius: 8px;
            margin-top: 24px;
            font-size: 0.875rem;
        }

        .message.active {
            display: block;
        }

        .message.error {
            background: rgba(248, 113, 113, 0.1);
            color: var(--error);
            border: 1px solid rgba(248, 113, 113, 0.2);
        }

        .message.success {
            background: rgba(74, 222, 128, 0.1);
            color: var(--success);
            border: 1px solid rgba(74, 222, 128, 0.2);
        }

        /* Onboarding */
        .onboarding-notice {
            text-align: center;
        }

        .onboarding-intro {
            max-width: 500px;
            margin: 0 auto;
        }

        .onboarding-intro h3 {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            font-weight: 400;
            margin-bottom: 16px;
        }

        .onboarding-intro p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.7;
        }

        .onboarding-intro ul {
            text-align: left;
            margin: 24px 0 40px;
            padding-left: 0;
            list-style: none;
        }

        .onboarding-intro li {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .onboarding-intro li strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 4px;
        }

        .onboarding-options {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Quick Setup Form */
        #quickSetupForm {
            max-width: 400px;
            margin: 0 auto;
        }

        #quickSetupForm h3 {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 8px;
        }

        #quickSetupForm > p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 32px;
        }

        /* Onboarding Chat */
        .onboarding-chat {
            display: none;
            max-width: 600px;
            margin: 0 auto;
        }

        .onboarding-chat.active {
            display: block;
        }

        .chat-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .chat-header h3 {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .chat-header p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .chat-message {
            margin-bottom: 16px;
            padding: 16px 20px;
            border-radius: 12px;
            max-width: 85%;
            animation: fadeIn 0.3s ease-out;
        }

        .chat-message.assistant {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            margin-right: auto;
        }

        .chat-message.user {
            background: var(--text-primary);
            color: var(--bg-primary);
            margin-left: auto;
        }

        .chat-message .role {
            font-size: 0.625rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .chat-message.user .role {
            color: var(--text-muted);
        }

        .chat-input-area {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input-area textarea {
            flex: 1;
            min-height: 56px;
            max-height: 120px;
            resize: none;
            padding: 16px;
        }

        .chat-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .chat-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--border-hover);
        }

        .chat-btn.send {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .chat-btn.send:hover {
            background: var(--accent-hover);
        }

        .chat-btn.send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-btn.recording {
            background: var(--error);
            border-color: var(--error);
            animation: pulse 1.5s infinite;
        }

        .chat-footer {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
        }

        .chat-btn-text {
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chat-btn-text:hover {
            background: var(--bg-elevated);
        }

        .chat-btn-text.done {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .chat-btn-text.done:hover {
            background: var(--accent-hover);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-6px); opacity: 1; }
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Issue Reporter */
        .issue-fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .issue-fab:hover {
            background: var(--bg-elevated);
            border-color: var(--border-hover);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .issue-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            padding: 24px;
        }

        .issue-modal.active {
            display: flex;
        }

        .issue-modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            animation: fadeIn 0.3s ease-out;
        }

        .issue-modal h3 {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .issue-modal .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
        }

        .issue-modal .close-btn:hover {
            color: var(--text-primary);
        }

        .issue-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .issue-success {
            text-align: center;
            padding: 40px 20px;
        }

        .issue-success .checkmark {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(74, 222, 128, 0.15);
            color: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 24px;
        }

        .issue-success h3 {
            justify-content: center;
            margin-bottom: 12px;
        }

        .issue-success p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        /* Footer */
        .footer {
            padding: 40px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        /* Responsive */
        @media (max-width: 640px) {
            nav {
                padding: 16px 20px;
            }

            .container {
                padding: 0 16px;
            }

            main {
                padding-top: 100px;
            }

            .card {
                padding: 24px;
            }

            .voice-section {
                padding: 40px 24px;
            }

            .record-btn {
                width: 120px;
                height: 120px;
            }

            .quote-total {
                padding: 24px;
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }

            .total-amount {
                font-size: 2.5rem;
            }

            .quote-actions {
                flex-direction: column;
            }

            .quote-actions .btn {
                width: 100%;
            }

            .issue-form .form-row {
                grid-template-columns: 1fr;
            }

            .onboarding-options {
                flex-direction: column;
            }

            .onboarding-options .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <a href="/" class="logo">quoted<span>.it</span></a>
        <div class="nav-right" id="navRight" style="display: none;">
            <div class="nav-user">
                <div class="business-name" id="businessNameDisplay"></div>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </div>
    </nav>

    <main class="container">
        <!-- Auth View -->
        <div class="view auth-container" id="authView">
            <div class="auth-header animate-in">
                <h1>Voice to quote<br>in seconds.</h1>
                <p class="subtitle" style="margin-top: 16px;">Turn job site visits into professional estimates instantly.</p>
            </div>

            <div class="card animate-in-delayed">
                <div class="auth-tabs">
                    <button class="auth-tab active" id="loginTab" onclick="showAuthTab('login')">Sign In</button>
                    <button class="auth-tab" id="registerTab" onclick="showAuthTab('register')">Create Account</button>
                </div>

                <!-- Login Form -->
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="you@company.com" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" id="loginBtn">Sign In</button>
                </form>

                <!-- Register Form -->
                <form id="registerForm" style="display: none;" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" id="registerBusiness" placeholder="Your Company Name" required>
                    </div>
                    <div class="form-group">
                        <label>Your Name</label>
                        <input type="text" id="registerName" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="registerEmail" placeholder="you@company.com" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="registerPhone" placeholder="(555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" placeholder="Create a password" required minlength="8">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" id="registerBtn">Create Account</button>
                </form>

                <div class="message" id="authMessage"></div>
            </div>
        </div>

        <!-- Main App View -->
        <div class="view" id="appView">
            <!-- Onboarding Notice -->
            <div class="card onboarding-notice" id="onboardingNotice" style="display: none;">
                <!-- Intro Screen -->
                <div id="onboardingIntro" class="onboarding-intro">
                    <h3>Let's learn how you price.</h3>
                    <p>Before generating quotes, I need to understand your pricing model. Choose how you'd like to set this up.</p>

                    <ul>
                        <li>
                            <strong>Voice Interview</strong>
                            Have a quick conversation where I'll ask about your rates, materials, and typical pricing. Takes 2-5 minutes.
                        </li>
                        <li>
                            <strong>Quick Setup</strong>
                            Enter your basic rates manually. You can always teach me more later.
                        </li>
                    </ul>

                    <div class="onboarding-options">
                        <button class="btn btn-primary" onclick="startOnboardingInterview()">Start Voice Interview</button>
                        <button class="btn btn-secondary" onclick="showQuickSetup()">Quick Setup</button>
                    </div>
                </div>

                <!-- Quick Setup Form -->
                <div id="quickSetupForm" style="display: none;">
                    <h3>Quick Setup</h3>
                    <p>Enter your basic rates. You can refine these through quotes over time.</p>

                    <div class="form-group">
                        <label>Primary Trade</label>
                        <select id="primaryTrade">
                            <option value="deck_builder">Deck Builder</option>
                            <option value="general_contractor">General Contractor</option>
                            <option value="painter">Painter</option>
                            <option value="landscaper">Landscaper</option>
                            <option value="roofer">Roofer</option>
                            <option value="electrician">Electrician</option>
                            <option value="plumber">Plumber</option>
                            <option value="hvac">HVAC</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Hourly Labor Rate ($)</label>
                        <input type="number" id="hourlyRate" placeholder="85" value="85">
                    </div>
                    <div class="form-group">
                        <label>Minimum Job Amount ($)</label>
                        <input type="number" id="minimumJob" placeholder="500" value="500">
                    </div>
                    <div class="form-group">
                        <label>Deposit Percentage (%)</label>
                        <input type="number" id="depositPercent" placeholder="50" value="50">
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button class="btn btn-secondary" onclick="showOnboardingIntro()">Back</button>
                        <button class="btn btn-primary" style="flex: 1;" onclick="completeQuickSetup()">Save & Start</button>
                    </div>
                </div>

                <!-- Interview Chat -->
                <div id="onboardingChat" class="onboarding-chat">
                    <div class="chat-header">
                        <h3>Pricing Interview</h3>
                        <p>Tell me about how you price your work. Type or use voice.</p>
                    </div>

                    <div class="chat-messages" id="chatMessages"></div>

                    <div class="chat-input-area">
                        <textarea
                            id="chatInput"
                            placeholder="Type your response..."
                            onkeydown="handleChatKeydown(event)"
                        ></textarea>
                        <div class="chat-actions">
                            <button class="chat-btn" id="chatVoiceBtn" onclick="toggleChatVoice()" title="Voice input">
                                <span>ðŸŽ¤</span>
                            </button>
                            <button class="chat-btn send" id="chatSendBtn" onclick="sendChatMessage()" title="Send">
                                <span>â†’</span>
                            </button>
                        </div>
                    </div>

                    <div class="chat-footer">
                        <button class="chat-btn-text" onclick="showOnboardingIntro()">Cancel</button>
                        <button class="chat-btn-text done" id="finishInterviewBtn" onclick="finishInterview()" style="display: none;">
                            Finish & Save
                        </button>
                    </div>
                </div>
            </div>

            <!-- Input Section -->
            <div class="card voice-section" id="inputSection">
                <h2 class="card-title" style="font-family: var(--font-serif); font-weight: 400;">Describe the job.</h2>

                <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
                    <span id="recordBtnText">Record</span>
                </button>
                <p class="record-instructions" id="recordInstructions">
                    Click to start recording your voice note
                </p>

                <div class="text-divider">or type it out</div>

                <div style="text-align: left;">
                    <textarea
                        id="jobDescription"
                        placeholder="It's a 20 by 16 composite deck, Trex Select in Pebble Grey. Need to demo the old wood deck first. Standard aluminum railing, about 40 linear feet. Three steps down to the yard..."
                    ></textarea>
                    <button class="btn btn-primary" onclick="generateQuote()" style="margin-top: 16px;">Generate Quote</button>
                </div>
            </div>

            <!-- Loading State -->
            <div class="card loading" id="loadingSection">
                <div class="spinner"></div>
                <p class="loading-text">Generating your quote...</p>
            </div>

            <!-- Error Message -->
            <div class="message error" id="errorMessage"></div>

            <!-- Quote Result -->
            <div class="card quote-result" id="quoteResult">
                <div class="quote-header">
                    <h2>Budgetary Estimate</h2>
                    <span class="confidence-badge" id="confidenceBadge">High Confidence</span>
                </div>

                <div class="job-description" id="jobDescriptionDisplay"></div>

                <div class="line-items" id="lineItems"></div>

                <div class="quote-total">
                    <span class="total-label">Estimated Total</span>
                    <span class="total-amount" id="totalAmount">$0</span>
                </div>

                <div class="quote-notes" id="quoteNotes" style="display: none;">
                    <h4>Notes</h4>
                    <p id="notesContent"></p>
                </div>

                <div class="transcription" id="transcriptionDisplay" style="display: none;"></div>

                <div class="quote-actions">
                    <button class="btn btn-primary" onclick="downloadPdf()">Download PDF</button>
                    <button class="btn btn-secondary" onclick="newQuote()">New Quote</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Issue Reporter FAB -->
    <button class="issue-fab" onclick="openIssueModal()" title="Report an issue">?</button>

    <!-- Issue Reporter Modal -->
    <div class="issue-modal" id="issueModal">
        <div class="issue-modal-content">
            <div id="issueFormView">
                <h3>
                    Report an Issue
                    <button class="close-btn" onclick="closeIssueModal()">&times;</button>
                </h3>
                <form class="issue-form" onsubmit="submitIssue(event)">
                    <div class="form-group">
                        <label>What's the problem?</label>
                        <input type="text" id="issueTitle" placeholder="Brief description" required>
                    </div>

                    <div class="form-group">
                        <label>Tell us more</label>
                        <textarea id="issueDescription" placeholder="What happened? What did you expect?" required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Category</label>
                            <select id="issueCategory">
                                <option value="bug">Bug</option>
                                <option value="ui_issue">Display Issue</option>
                                <option value="pricing_issue">Pricing Issue</option>
                                <option value="feature_request">Feature Request</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Severity</label>
                            <select id="issueSeverity">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Steps to reproduce (optional)</label>
                        <textarea id="issueSteps" placeholder="1. Go to...&#10;2. Click on...&#10;3. See error"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">Submit</button>
                </form>
            </div>

            <div id="issueSuccessView" class="issue-success" style="display: none;">
                <div class="checkmark">âœ“</div>
                <h3>Thanks for reporting!</h3>
                <p>
                    We'll look into this.<br>
                    Issue ID: <strong id="submittedIssueId"></strong>
                </p>
                <button class="btn btn-secondary" onclick="closeIssueModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:8000/api'
            : window.location.origin + '/api';

        // State
        let authToken = localStorage.getItem('quoted_token');
        let currentUser = JSON.parse(localStorage.getItem('quoted_user') || 'null');
        let currentQuoteId = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken && currentUser) {
                showAppView();
            } else {
                showAuthView();
            }
        });

        // Auth tab switching
        function showAuthTab(tab) {
            document.getElementById('loginTab').classList.toggle('active', tab === 'login');
            document.getElementById('registerTab').classList.toggle('active', tab === 'register');
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
            hideAuthMessage();
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');

            btn.disabled = true;
            btn.textContent = 'Signing in...';

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Login failed');
                }

                authToken = data.access_token;
                localStorage.setItem('quoted_token', authToken);

                await fetchUserInfo();
                showAppView();

            } catch (err) {
                showAuthMessage(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        }

        // Handle registration
        async function handleRegister(e) {
            e.preventDefault();
            const btn = document.getElementById('registerBtn');

            const data = {
                email: document.getElementById('registerEmail').value,
                password: document.getElementById('registerPassword').value,
                business_name: document.getElementById('registerBusiness').value,
                owner_name: document.getElementById('registerName').value || null,
                phone: document.getElementById('registerPhone').value || null,
            };

            btn.disabled = true;
            btn.textContent = 'Creating account...';

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Registration failed');
                }

                authToken = result.access_token;
                localStorage.setItem('quoted_token', authToken);

                await fetchUserInfo();
                showAppView();

            } catch (err) {
                showAuthMessage(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        }

        // Fetch user info
        async function fetchUserInfo() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` },
                });

                if (response.ok) {
                    currentUser = await response.json();
                    localStorage.setItem('quoted_user', JSON.stringify(currentUser));
                } else {
                    console.error('fetchUserInfo failed:', response.status);
                    // Clear invalid auth state
                    if (response.status === 401) {
                        logout();
                    }
                    throw new Error('Failed to fetch user info');
                }
            } catch (err) {
                console.error('fetchUserInfo error:', err);
                throw err;
            }
        }

        // Logout
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('quoted_token');
            localStorage.removeItem('quoted_user');
            showAuthView();
        }

        // View switching
        function showAuthView() {
            document.getElementById('authView').classList.add('active');
            document.getElementById('appView').classList.remove('active');
            document.getElementById('navRight').style.display = 'none';
        }

        async function showAppView() {
            document.getElementById('authView').classList.remove('active');
            document.getElementById('appView').classList.add('active');
            document.getElementById('navRight').style.display = 'flex';

            // Ensure we have user info
            if (!currentUser) {
                try {
                    await fetchUserInfo();
                } catch (err) {
                    console.error('Failed to fetch user info:', err);
                    showAuthView();
                    return;
                }
            }

            if (currentUser) {
                document.getElementById('businessNameDisplay').textContent = currentUser.business_name || currentUser.email;
            }

            // Check pricing model
            try {
                if (!currentUser?.contractor_id) {
                    throw new Error('No contractor ID');
                }

                const response = await fetch(`${API_BASE}/contractors/${currentUser.contractor_id}/pricing`, {
                    headers: { 'Authorization': `Bearer ${authToken}` },
                });

                if (response.ok) {
                    const pricing = await response.json();
                    const hasPricing = pricing && pricing.pricing_knowledge && Object.keys(pricing.pricing_knowledge).length > 0;
                    document.getElementById('onboardingNotice').style.display = hasPricing ? 'none' : 'block';
                    document.getElementById('inputSection').style.display = hasPricing ? 'block' : 'none';
                } else {
                    document.getElementById('onboardingNotice').style.display = 'block';
                    document.getElementById('inputSection').style.display = 'none';
                }
            } catch (err) {
                console.error('Error checking pricing model:', err);
                document.getElementById('onboardingNotice').style.display = 'block';
                document.getElementById('inputSection').style.display = 'none';
            }
        }

        // Auth message
        function showAuthMessage(message, type) {
            const el = document.getElementById('authMessage');
            el.textContent = message;
            el.className = 'message active ' + type;
        }

        function hideAuthMessage() {
            document.getElementById('authMessage').classList.remove('active');
        }

        // Recording
        async function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            const btnText = document.getElementById('recordBtnText');
            const instructions = document.getElementById('recordInstructions');

            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                btn.classList.remove('recording');
                btnText.textContent = 'Record';
                instructions.textContent = 'Processing...';
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (e) => {
                        audioChunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await sendAudioForQuote(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    btn.classList.add('recording');
                    btnText.textContent = 'Stop';
                    instructions.textContent = 'Recording... Click again when done';
                } catch (err) {
                    console.error('Microphone error:', err);
                    showError('Could not access microphone. Please allow access and try again.');
                }
            }
        }

        // Send audio
        async function sendAudioForQuote(audioBlob) {
            showLoading(true);

            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                formData.append('contractor_id', currentUser?.contractor_id || 'default');

                const response = await fetch(`${API_BASE}/quotes/generate-from-audio`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData,
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate quote');
                }

                const quote = await response.json();
                displayQuote(quote);
            } catch (err) {
                console.error('Error:', err);
                showError(err.message);
            } finally {
                showLoading(false);
                document.getElementById('recordInstructions').textContent = 'Click to start recording your voice note';
            }
        }

        // Generate quote from text
        async function generateQuote() {
            const transcription = document.getElementById('jobDescription').value.trim();

            if (!transcription) {
                showError('Please enter a job description');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/quotes/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({
                        transcription: transcription,
                        contractor_id: currentUser?.contractor_id || 'default',
                    }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate quote');
                }

                const quote = await response.json();
                displayQuote(quote);
            } catch (err) {
                console.error('Error:', err);
                showError(err.message);
            } finally {
                showLoading(false);
            }
        }

        // Create line item element
        function createLineItemElement(item) {
            const itemEl = document.createElement('div');
            itemEl.className = 'line-item';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'line-item-info';

            const nameDiv = document.createElement('div');
            nameDiv.className = 'line-item-name';
            nameDiv.textContent = item.name || '';

            const descDiv = document.createElement('div');
            descDiv.className = 'line-item-desc';
            descDiv.textContent = item.description || '';

            infoDiv.appendChild(nameDiv);
            infoDiv.appendChild(descDiv);

            const amountDiv = document.createElement('div');
            amountDiv.className = 'line-item-amount';
            amountDiv.textContent = '$' + (item.amount || 0).toLocaleString();

            itemEl.appendChild(infoDiv);
            itemEl.appendChild(amountDiv);

            return itemEl;
        }

        // Display quote
        function displayQuote(quote) {
            currentQuoteId = quote.id;

            document.getElementById('jobDescriptionDisplay').textContent =
                quote.job_description || 'No description provided';

            const badge = document.getElementById('confidenceBadge');
            const confidence = quote.confidence || 'medium';
            badge.textContent = confidence.charAt(0).toUpperCase() + confidence.slice(1) + ' Confidence';
            badge.className = 'confidence-badge confidence-' + confidence;

            const lineItemsContainer = document.getElementById('lineItems');
            lineItemsContainer.textContent = '';

            if (quote.line_items && quote.line_items.length > 0) {
                quote.line_items.forEach(item => {
                    const itemEl = createLineItemElement(item);
                    lineItemsContainer.appendChild(itemEl);
                });
            }

            document.getElementById('totalAmount').textContent =
                '$' + (quote.subtotal || 0).toLocaleString();

            if (quote.notes) {
                document.getElementById('notesContent').textContent = quote.notes;
                document.getElementById('quoteNotes').style.display = 'block';
            } else {
                document.getElementById('quoteNotes').style.display = 'none';
            }

            if (quote.transcription) {
                document.getElementById('transcriptionDisplay').textContent = quote.transcription;
                document.getElementById('transcriptionDisplay').style.display = 'block';
            } else {
                document.getElementById('transcriptionDisplay').style.display = 'none';
            }

            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('quoteResult').classList.add('active');
            hideError();
        }

        // Download PDF
        async function downloadPdf() {
            if (!currentQuoteId) {
                showError('No quote to download');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/quotes/${currentQuoteId}/pdf`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                });

                if (!response.ok) {
                    throw new Error('Failed to generate PDF');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'quote_' + currentQuoteId + '.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (err) {
                console.error('Error:', err);
                showError(err.message);
            }
        }

        // New quote
        function newQuote() {
            currentQuoteId = null;
            document.getElementById('jobDescription').value = '';
            document.getElementById('inputSection').style.display = 'block';
            document.getElementById('quoteResult').classList.remove('active');
            hideError();
        }

        // ========== ONBOARDING ==========

        let onboardingSessionId = null;
        let chatMediaRecorder = null;
        let chatAudioChunks = [];
        let messageCount = 0;

        function showOnboardingIntro() {
            document.getElementById('onboardingIntro').style.display = 'block';
            document.getElementById('quickSetupForm').style.display = 'none';
            document.getElementById('onboardingChat').classList.remove('active');
        }

        function showQuickSetup() {
            document.getElementById('onboardingIntro').style.display = 'none';
            document.getElementById('quickSetupForm').style.display = 'block';
            document.getElementById('onboardingChat').classList.remove('active');
        }

        async function startOnboardingInterview() {
            document.getElementById('onboardingIntro').style.display = 'none';
            document.getElementById('quickSetupForm').style.display = 'none';
            document.getElementById('onboardingChat').classList.add('active');

            document.getElementById('chatMessages').innerHTML = '';
            messageCount = 0;

            addTypingIndicator();

            try {
                // Ensure we have user info before proceeding
                if (!currentUser) {
                    await fetchUserInfo();
                }

                const contractorName = currentUser?.business_name || currentUser?.email || 'Contractor';

                const response = await fetch(`${API_BASE}/onboarding/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({
                        contractor_name: contractorName,
                        primary_trade: 'general',
                    }),
                });

                if (!response.ok) {
                    throw new Error('Failed to start interview');
                }

                const session = await response.json();
                onboardingSessionId = session.session_id;

                removeTypingIndicator();
                addChatMessage('assistant', session.initial_message);

            } catch (err) {
                console.error('Interview error:', err);
                removeTypingIndicator();
                addChatMessage('assistant', "Having trouble starting. Please try again or use Quick Setup.");
            }
        }

        function addChatMessage(role, content) {
            const container = document.getElementById('chatMessages');
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message ' + role;

            const roleLabel = document.createElement('div');
            roleLabel.className = 'role';
            roleLabel.textContent = role === 'assistant' ? 'quoted.it' : 'You';

            const contentEl = document.createElement('div');
            contentEl.textContent = content;

            msgEl.appendChild(roleLabel);
            msgEl.appendChild(contentEl);
            container.appendChild(msgEl);

            container.scrollTop = container.scrollHeight;

            if (role === 'user') {
                messageCount++;
                if (messageCount >= 2) {
                    document.getElementById('finishInterviewBtn').style.display = 'inline-block';
                }
            }

            return msgEl;
        }

        function addTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const indicator = document.createElement('div');
            indicator.className = 'chat-message assistant';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || !onboardingSessionId) return;

            input.value = '';
            document.getElementById('chatSendBtn').disabled = true;

            addChatMessage('user', message);
            addTypingIndicator();

            try {
                const response = await fetch(`${API_BASE}/onboarding/${onboardingSessionId}/continue`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({ message }),
                });

                if (!response.ok) {
                    throw new Error('Failed to continue');
                }

                const session = await response.json();
                const messages = session.messages;
                const lastMessage = messages[messages.length - 1];

                removeTypingIndicator();

                if (lastMessage && lastMessage.role === 'assistant') {
                    addChatMessage('assistant', lastMessage.content);
                }

            } catch (err) {
                console.error('Chat error:', err);
                removeTypingIndicator();
                addChatMessage('assistant', "Having trouble. Please try again.");
            } finally {
                document.getElementById('chatSendBtn').disabled = false;
            }
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function toggleChatVoice() {
            const btn = document.getElementById('chatVoiceBtn');

            if (chatMediaRecorder && chatMediaRecorder.state === 'recording') {
                chatMediaRecorder.stop();
                btn.classList.remove('recording');
                btn.innerHTML = '<span>ðŸŽ¤</span>';
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    chatMediaRecorder = new MediaRecorder(stream);
                    chatAudioChunks = [];

                    chatMediaRecorder.ondataavailable = (e) => {
                        chatAudioChunks.push(e.data);
                    };

                    chatMediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(chatAudioChunks, { type: 'audio/webm' });
                        stream.getTracks().forEach(track => track.stop());

                        // Show placeholder while transcribing
                        const placeholderMsg = addChatMessage('user', '[Transcribing voice message...]');

                        try {
                            // Send audio for transcription
                            const formData = new FormData();
                            formData.append('audio', audioBlob, 'voice.webm');

                            const response = await fetch(`${API_BASE}/quotes/transcribe`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${authToken}`,
                                },
                                body: formData,
                            });

                            if (!response.ok) {
                                throw new Error('Transcription failed');
                            }

                            const result = await response.json();
                            const transcribedText = result.text;

                            // Update placeholder with actual text
                            if (placeholderMsg) {
                                placeholderMsg.querySelector('div:last-child').textContent = transcribedText;
                            }

                            // Send transcribed message to interview
                            if (onboardingSessionId && transcribedText) {
                                addTypingIndicator();

                                const continueResponse = await fetch(`${API_BASE}/onboarding/${onboardingSessionId}/continue`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${authToken}`,
                                    },
                                    body: JSON.stringify({ message: transcribedText }),
                                });

                                if (continueResponse.ok) {
                                    const session = await continueResponse.json();
                                    const messages = session.messages;
                                    const lastMessage = messages[messages.length - 1];

                                    removeTypingIndicator();

                                    if (lastMessage && lastMessage.role === 'assistant') {
                                        addChatMessage('assistant', lastMessage.content);
                                    }
                                } else {
                                    removeTypingIndicator();
                                }
                            }
                        } catch (err) {
                            console.error('Voice transcription error:', err);
                            if (placeholderMsg) {
                                placeholderMsg.querySelector('div:last-child').textContent = '[Voice transcription failed - please type your message]';
                            }
                        }
                    };

                    chatMediaRecorder.start();
                    btn.classList.add('recording');
                    btn.innerHTML = '<span>â¹</span>';
                } catch (err) {
                    console.error('Microphone error:', err);
                    showError('Could not access microphone');
                }
            }
        }

        async function finishInterview() {
            if (!onboardingSessionId) return;

            document.getElementById('finishInterviewBtn').disabled = true;
            document.getElementById('finishInterviewBtn').textContent = 'Saving...';

            addTypingIndicator();

            try {
                const response = await fetch(`${API_BASE}/onboarding/${onboardingSessionId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                    },
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to complete');
                }

                const pricingModel = await response.json();

                removeTypingIndicator();
                addChatMessage('assistant', "Your pricing is saved. You're ready to start quoting!");

                setTimeout(async () => {
                    await savePricingToContractor(pricingModel);
                    document.getElementById('onboardingNotice').style.display = 'none';
                    document.getElementById('inputSection').style.display = 'block';
                }, 2000);

            } catch (err) {
                console.error('Complete error:', err);
                removeTypingIndicator();
                addChatMessage('assistant', "Need more info. Tell me about your hourly rate or typical pricing.");
                document.getElementById('finishInterviewBtn').disabled = false;
                document.getElementById('finishInterviewBtn').textContent = 'Finish & Save';
            }
        }

        async function savePricingToContractor(pricingModel) {
            // Pricing model is saved by the /complete endpoint on the backend
            // This function is kept for logging and potential future enhancements
            console.log('Pricing model saved by backend:', pricingModel);
        }

        async function completeQuickSetup() {
            const primaryTrade = document.getElementById('primaryTrade').value;
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 85;
            const minimumJob = parseFloat(document.getElementById('minimumJob').value) || 500;
            const depositPercent = parseFloat(document.getElementById('depositPercent').value) || 50;

            try {
                // Ensure we have user info before proceeding
                if (!currentUser) {
                    await fetchUserInfo();
                }

                // Get contractor name with safe fallback
                const contractorName = currentUser?.business_name || currentUser?.email || 'Contractor';

                const response = await fetch(`${API_BASE}/onboarding/quick`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({
                        contractor_name: contractorName,
                        primary_trade: primaryTrade,
                        labor_rate: hourlyRate,
                        minimum_job: minimumJob,
                        pricing_notes: `Deposit: ${depositPercent}%`,
                    }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Setup failed');
                }

                await fetchUserInfo();
                document.getElementById('onboardingNotice').style.display = 'none';
                document.getElementById('inputSection').style.display = 'block';

            } catch (err) {
                console.error('Quick setup error:', err);
                showError('Setup failed: ' + err.message);
            }
        }

        // UI helpers
        function showLoading(show) {
            document.getElementById('inputSection').style.display = show ? 'none' : 'block';
            document.getElementById('loadingSection').classList.toggle('active', show);
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('active');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('active');
        }

        // Issue Reporter
        function openIssueModal() {
            document.getElementById('issueModal').classList.add('active');
            document.getElementById('issueFormView').style.display = 'block';
            document.getElementById('issueSuccessView').style.display = 'none';
            window.currentIssuePageUrl = window.location.href;
        }

        function closeIssueModal() {
            document.getElementById('issueModal').classList.remove('active');
            document.getElementById('issueTitle').value = '';
            document.getElementById('issueDescription').value = '';
            document.getElementById('issueSteps').value = '';
            document.getElementById('issueCategory').value = 'bug';
            document.getElementById('issueSeverity').value = 'medium';
        }

        async function submitIssue(event) {
            event.preventDefault();

            const issueData = {
                title: document.getElementById('issueTitle').value,
                description: document.getElementById('issueDescription').value,
                category: document.getElementById('issueCategory').value,
                severity: document.getElementById('issueSeverity').value,
                steps_to_reproduce: document.getElementById('issueSteps').value || null,
                page_url: window.currentIssuePageUrl || window.location.href,
                browser_info: navigator.userAgent,
                error_message: window.lastJsError || null
            };

            try {
                const response = await fetch(`${API_BASE}/issues/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(issueData)
                });

                if (!response.ok) {
                    throw new Error('Failed to submit');
                }

                const result = await response.json();

                document.getElementById('issueFormView').style.display = 'none';
                document.getElementById('issueSuccessView').style.display = 'block';
                document.getElementById('submittedIssueId').textContent = result.id.substring(0, 8);

            } catch (err) {
                console.error('Issue submit error:', err);
                alert('Failed to submit. Please try again.');
            }
        }

        // Error capture
        window.lastJsError = null;
        window.onerror = function(message, source, lineno, colno, error) {
            window.lastJsError = `${message} at ${source}:${lineno}:${colno}`;
        };

        // Close modal on outside click
        document.getElementById('issueModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeIssueModal();
            }
        });
    </script>
</body>
</html>

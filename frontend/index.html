<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>quoted.it - Voice to Quote</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230a0a0a'/%3E%3Ctext x='16' y='23' font-family='serif' font-size='20' font-weight='600' fill='white' text-anchor='middle'%3EQ%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%230a0a0a'/%3E%3Ctext x='90' y='125' font-family='serif' font-size='110' font-weight='600' fill='white' text-anchor='middle'%3EQ%3C/text%3E%3C/svg%3E">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- PostHog Analytics -->
    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        {% if posthog_api_key %}
        posthog.init('{{ posthog_api_key }}', {api_host: 'https://us.i.posthog.com'});
        {% endif %}
    </script>

    <!-- Sentry Error Tracking -->
    <script src="https://browser.sentry-cdn.com/8.38.0/bundle.tracing.min.js" crossorigin="anonymous"></script>
    <script>
        {% if sentry_dsn %}
        Sentry.init({
            dsn: '{{ sentry_dsn }}',
            environment: '{{ environment }}' || 'development',
            tracesSampleRate: 0.1,
        });
        {% endif %}
    </script>

    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-card: #1a1a1a;
            --bg-elevated: #222222;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --accent: #ffffff;
            --accent-hover: #e0e0e0;
            --border: rgba(255, 255, 255, 0.1);
            --border-hover: rgba(255, 255, 255, 0.2);
            --success: #4ade80;
            --warning: #fbbf24;
            --error: #f87171;
            --font-serif: 'Playfair Display', Georgia, serif;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .animate-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .animate-in-delayed {
            animation: fadeIn 0.6s ease-out 0.2s forwards;
            opacity: 0;
        }

        /* Layout */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 24px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, var(--bg-primary) 0%, transparent 100%);
        }

        .logo {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 500;
            letter-spacing: -0.02em;
            color: var(--text-primary);
            text-decoration: none;
        }

        .logo span {
            font-style: italic;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .nav-user {
            text-align: right;
        }

        .nav-user .business-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .nav-user .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            font-family: var(--font-sans);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: color 0.3s ease;
            margin-top: 4px;
        }

        .nav-user .logout-btn:hover {
            color: var(--text-primary);
        }

        /* App Navigation Tabs */
        .app-nav {
            display: flex;
            gap: 8px;
            margin-right: 24px;
        }

        .app-nav-btn {
            padding: 12px 20px;
            min-height: 44px;
            border-radius: 100px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-family: var(--font-sans);
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .app-nav-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .app-nav-btn.active {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        /* Main Content */
        main {
            min-height: 100vh;
            padding-top: 120px;
            padding-bottom: 80px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            transition: border-color 0.3s ease;
        }

        .card:hover {
            border-color: var(--border-hover);
        }

        .card-title {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            font-weight: 500;
            margin-bottom: 24px;
            letter-spacing: -0.02em;
        }

        /* Typography */
        h1 {
            font-family: var(--font-serif);
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            font-weight: 400;
            line-height: 1.1;
            letter-spacing: -0.03em;
        }

        h2 {
            font-family: var(--font-serif);
            font-size: 2rem;
            font-weight: 400;
            letter-spacing: -0.02em;
        }

        h3 {
            font-family: var(--font-sans);
            font-size: 1.125rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .hero-text {
            font-family: var(--font-serif);
            font-size: clamp(2rem, 6vw, 3.5rem);
            font-weight: 400;
            line-height: 1.2;
            letter-spacing: -0.02em;
            margin-bottom: 48px;
        }

        .hero-text em {
            font-style: italic;
        }

        /* Auth Forms */
        .auth-container {
            max-width: 440px;
            margin: 0 auto;
            padding-top: 60px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .auth-header h1 {
            margin-bottom: 16px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 32px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .auth-tab {
            flex: 1;
            padding: 14px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.8125rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: var(--font-sans);
            transition: all 0.3s ease;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--text-primary);
            background: var(--bg-elevated);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }

        /* Customer Autocomplete Dropdown (DISC-022) */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s ease;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: var(--bg-card);
        }

        .autocomplete-item-name {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .autocomplete-item-details {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .autocomplete-empty {
            padding: 12px 16px;
            color: var(--text-muted);
            font-size: 0.875rem;
            text-align: center;
        }

        /* Job Description Textarea - styled to match design */
        #jobDescription {
            width: 100%;
            max-width: 500px;
            min-height: 140px;
            padding: 18px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: var(--font-sans);
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s ease;
        }

        #jobDescription::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        #jobDescription:focus {
            outline: none;
            border-color: var(--text-primary);
            background: var(--bg-elevated);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
        }

        .job-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        /* Transcription Preview */
        .transcription-preview {
            text-align: center;
            padding: 40px;
        }

        .preview-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 24px;
        }

        .transcription-textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: var(--font-sans);
            font-size: 1rem;
            line-height: 1.6;
            background: var(--bg-elevated);
            color: var(--text-primary);
            resize: vertical;
            margin-bottom: 24px;
        }

        .transcription-textarea:focus {
            outline: none;
            border-color: var(--text-primary);
        }

        .preview-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-icon {
            font-size: 1rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 32px;
            min-height: 44px;
            border-radius: 8px;
            border: none;
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-elevated);
            border-color: var(--border-hover);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 10px 16px;
        }

        .btn-ghost:hover {
            color: var(--text-primary);
        }

        .btn-block {
            display: flex;
            width: 100%;
        }

        /* Voice Input */
        .voice-section {
            text-align: center;
            padding: 60px 40px;
        }

        .record-btn {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 2px solid var(--text-primary);
            background: transparent;
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .record-btn::before {
            content: '';
            position: absolute;
            inset: 4px;
            border-radius: 50%;
            background: transparent;
            transition: all 0.4s ease;
        }

        .record-btn:hover {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .record-btn.recording {
            background: var(--text-primary);
            color: var(--bg-primary);
            animation: pulse 2s infinite;
        }

        .record-btn.recording::before {
            background: var(--error);
            inset: 50px;
        }

        .record-instructions {
            margin-top: 24px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .text-divider {
            display: flex;
            align-items: center;
            gap: 24px;
            margin: 48px 0;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .text-divider::before,
        .text-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* Voice Fallback UI */
        .voice-warning {
            display: none;
            padding: 16px 20px;
            margin-bottom: 24px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            color: var(--warning);
            font-size: 0.875rem;
            line-height: 1.5;
            text-align: left;
        }

        .voice-warning.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .voice-fallback-link {
            display: none;
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 0.8125rem;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .voice-fallback-link:hover {
            color: var(--text-primary);
        }

        .voice-fallback-link.active {
            display: inline-block;
            animation: fadeIn 0.3s ease;
        }

        .voice-fallback-link.prominent {
            color: var(--warning);
            font-weight: 500;
        }

        .browser-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            margin-left: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 100px;
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .browser-badge.compatible {
            background: rgba(74, 222, 128, 0.1);
            border-color: rgba(74, 222, 128, 0.3);
            color: var(--success);
        }

        .browser-badge.limited {
            background: rgba(251, 191, 36, 0.1);
            border-color: rgba(251, 191, 36, 0.3);
            color: var(--warning);
        }

        .browser-badge-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 80px 40px;
        }

        .loading.active {
            display: block;
        }

        /* Animated Quote Marks Loading */
        .loading-animation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 32px;
            height: 80px;
        }

        .quote-mark {
            font-family: var(--font-serif);
            font-size: 4rem;
            font-weight: 600;
            color: var(--text-primary);
            opacity: 0.2;
            animation: quotePulse 2s ease-in-out infinite;
        }

        .quote-mark.left {
            animation-delay: 0s;
        }

        .quote-mark.right {
            animation-delay: 0.3s;
        }

        .loading-dots {
            display: flex;
            gap: 6px;
            padding: 0 12px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: var(--text-primary);
            border-radius: 50%;
            opacity: 0.2;
            animation: dotPulse 1.4s ease-in-out infinite;
        }

        .loading-dot:nth-child(1) { animation-delay: 0s; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes quotePulse {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        @keyframes dotPulse {
            0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1); }
        }

        .loading-text {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-style: italic;
            color: var(--text-secondary);
            min-height: 1.5em;
        }

        .loading-subtext {
            font-family: var(--font-sans);
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 12px;
            opacity: 0;
            animation: fadeIn 0.5s ease-out 2s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* Quote Result */
        .quote-result {
            display: none;
            scroll-margin-top: 140px; /* Account for fixed nav (120px) + extra padding */
        }

        .quote-result.active {
            display: block;
        }

        .quote-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
            position: relative;
            z-index: 1;
            scroll-margin-top: 140px; /* Account for fixed nav (120px) + extra padding */
        }

        .quote-header h2 {
            font-family: var(--font-serif);
            font-size: 2rem;
        }

        .confidence-badge {
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            flex-shrink: 0;
            letter-spacing: 0.08em;
        }

        .confidence-high {
            background: rgba(74, 222, 128, 0.15);
            color: var(--success);
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        .confidence-good {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        .confidence-medium {
            background: rgba(251, 191, 36, 0.15);
            color: var(--warning);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .confidence-low {
            background: rgba(248, 113, 113, 0.15);
            color: var(--error);
            border: 1px solid rgba(248, 113, 113, 0.3);
        }

        .job-description {
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 32px;
            line-height: 1.7;
            color: var(--text-secondary);
            border-left: 3px solid var(--text-primary);
        }

        /* Customer Info Section */
        .customer-info-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .customer-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .customer-info-header h3 {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-weight: 500;
            margin: 0;
        }

        .btn-icon {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .customer-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .customer-info-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .customer-info-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .customer-info-value {
            font-size: 1rem;
            color: var(--text-primary);
        }

        /* Line Items */
        .line-items {
            margin-bottom: 32px;
        }

        .line-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
        }

        .line-item:last-child {
            border-bottom: none;
        }

        .line-item-info {
            flex: 1;
        }

        .line-item-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .line-item-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .line-item-amount {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-weight: 500;
            margin-left: 24px;
        }

        /* Total */
        .quote-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 32px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-top: 32px;
        }

        .total-label {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }

        .total-amount {
            font-family: var(--font-serif);
            font-size: 3rem;
            font-weight: 500;
            letter-spacing: -0.02em;
        }

        /* Notes */
        .quote-notes {
            margin-top: 32px;
            padding: 24px;
            background: rgba(251, 191, 36, 0.08);
            border-radius: 12px;
            border-left: 3px solid var(--warning);
        }

        .quote-notes h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--warning);
            margin-bottom: 12px;
        }

        .quote-notes p {
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Transcription */
        .transcription {
            margin-top: 32px;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
            font-style: italic;
            color: var(--text-muted);
            font-size: 0.875rem;
            line-height: 1.7;
        }

        .transcription::before {
            content: '"';
            font-family: var(--font-serif);
            font-size: 2rem;
            color: var(--text-muted);
            display: block;
            margin-bottom: 8px;
        }

        /* Quote Actions */
        .quote-actions {
            display: flex;
            gap: 12px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        /* Feedback Section (Enhancement 4) */
        .feedback-section {
            margin-top: 32px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: background 0.2s;
        }

        .feedback-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .feedback-header h4 {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin: 0;
        }

        .feedback-toggle {
            font-size: 1.25rem;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .feedback-toggle.open {
            transform: rotate(45deg);
        }

        .feedback-content {
            padding: 24px;
            background: var(--bg-primary);
        }

        .feedback-group {
            margin-bottom: 24px;
        }

        .feedback-group label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 8px;
        }

        .star-rating .star {
            font-size: 1.75rem;
            color: var(--border-color);
            cursor: pointer;
            transition: color 0.15s, transform 0.15s;
        }

        .star-rating .star:hover,
        .star-rating .star.active {
            color: var(--warning);
        }

        .star-rating .star:hover {
            transform: scale(1.1);
        }

        /* Testimonial Stars (DISC-010) */
        #starRating .star {
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        #starRating .star:hover {
            transform: scale(1.15);
            opacity: 0.8;
        }

        /* Pricing Buttons */
        .pricing-buttons {
            display: flex;
            gap: 8px;
        }

        .pricing-btn {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pricing-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--text-muted);
        }

        .pricing-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }

        /* Issue Checkboxes */
        .issue-checkboxes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            accent-color: var(--accent);
        }

        /* Feedback Textarea */
        .feedback-content textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 0.875rem;
            resize: vertical;
        }

        .feedback-content textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Feedback Actions */
        .feedback-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .feedback-status {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-left: 12px;
        }

        .feedback-status.success {
            color: var(--success);
        }

        .feedback-status.error {
            color: var(--error);
        }

        .feedback-status.info {
            color: var(--primary);
        }

        /* Quote Branding */
        .quote-branding {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
            text-align: center;
        }

        .quote-branding a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            color: var(--text-muted);
            font-size: 0.75rem;
            transition: color 0.3s ease;
        }

        .quote-branding a:hover {
            color: var(--text-secondary);
        }

        .branding-text {
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .branding-logo {
            font-family: var(--font-serif);
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: -0.02em;
        }

        .branding-logo-it {
            font-style: italic;
        }

        /* Messages */
        .message {
            display: none;
            padding: 16px 20px;
            border-radius: 8px;
            margin-top: 24px;
            font-size: 0.875rem;
        }

        .message.active {
            display: block;
        }

        .message.error {
            background: rgba(248, 113, 113, 0.1);
            color: var(--error);
            border: 1px solid rgba(248, 113, 113, 0.2);
        }

        .message.success {
            background: rgba(74, 222, 128, 0.1);
            color: var(--success);
            border: 1px solid rgba(74, 222, 128, 0.2);
        }

        /* Onboarding */
        .onboarding-notice {
            text-align: center;
        }

        .onboarding-intro {
            max-width: 500px;
            margin: 0 auto;
        }

        .onboarding-intro h3 {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            font-weight: 400;
            margin-bottom: 16px;
        }

        .onboarding-intro p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.7;
        }

        .onboarding-intro ul {
            text-align: left;
            margin: 24px 0 40px;
            padding-left: 0;
            list-style: none;
        }

        .onboarding-intro li {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
            transition: all 0.2s;
        }

        .onboarding-intro li.onboarding-option-recommended {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid rgba(102, 126, 234, 0.3);
            padding: 20px 24px;
        }

        .onboarding-intro li.onboarding-option-manual {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .onboarding-intro li strong {
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 1.05rem;
        }

        .recommended-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 3px 8px;
            background: rgba(102, 126, 234, 0.2);
            color: #a5b4fc;
            border-radius: 4px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .onboarding-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .btn-large {
            padding: 16px 32px;
            font-size: 1.05rem;
            font-weight: 600;
            width: 100%;
            max-width: 320px;
        }

        .btn-link {
            background: none;
            color: var(--text-muted);
            padding: 8px 16px;
            font-size: 0.875rem;
            text-decoration: underline;
            text-underline-offset: 3px;
        }

        .btn-link:hover {
            background: none;
            color: var(--text-secondary);
            text-decoration: underline;
        }

        /* Industry Selection */
        #industrySelection {
            max-width: 700px;
            margin: 0 auto;
        }

        #industrySelection h3 {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            font-weight: 400;
            margin-bottom: 12px;
        }

        #industrySelection > p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.7;
        }

        .industry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 24px;
        }

        .industry-card {
            padding: 1.5rem;
            text-align: center;
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .industry-card:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
        }

        .industry-card.selected {
            border-color: #667eea;
            background: rgba(102,126,234,0.15);
        }

        .industry-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .industry-name {
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .industry-other-input {
            margin-top: 16px;
            display: none;
        }

        .industry-other-input.active {
            display: block;
        }

        .industry-other-input input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .industry-continue-btn {
            margin-top: 24px;
            text-align: center;
        }

        .industry-continue-btn .btn {
            min-width: 200px;
        }

        /* Quick Setup Form */
        #quickSetupForm {
            max-width: 400px;
            margin: 0 auto;
        }

        #quickSetupForm h3 {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 8px;
        }

        #quickSetupForm > p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 32px;
        }

        /* Onboarding Chat */
        .onboarding-chat {
            display: none;
            max-width: 600px;
            margin: 0 auto;
        }

        .onboarding-chat.active {
            display: block;
        }

        .chat-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .chat-header h3 {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .chat-header p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .chat-message {
            margin-bottom: 16px;
            padding: 16px 20px;
            border-radius: 12px;
            max-width: 85%;
            animation: fadeIn 0.3s ease-out;
        }

        .chat-message.assistant {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            margin-right: auto;
        }

        .chat-message.user {
            background: var(--text-primary);
            color: var(--bg-primary);
            margin-left: auto;
        }

        .chat-message .role {
            font-size: 0.625rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .chat-message.user .role {
            color: var(--text-muted);
        }

        .chat-input-area {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input-area textarea {
            flex: 1;
            min-height: 56px;
            max-height: 120px;
            resize: none;
            padding: 16px;
        }

        .chat-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .chat-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--border-hover);
        }

        .chat-btn.send {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .chat-btn.send:hover {
            background: var(--accent-hover);
        }

        .chat-btn.send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-btn.recording {
            background: var(--error);
            border-color: var(--error);
            animation: pulse 1.5s infinite;
        }

        .chat-footer {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
        }

        .chat-btn-text {
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chat-btn-text:hover {
            background: var(--bg-elevated);
        }

        .chat-btn-text.done {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .chat-btn-text.done:hover {
            background: var(--accent-hover);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-6px); opacity: 1; }
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Quote History Styles */
        .quote-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .quote-history-header h2 {
            font-family: var(--font-serif);
            font-size: 2rem;
            font-weight: 400;
        }

        .quote-history-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .quote-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .quote-list-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quote-list-item:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .quote-list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .quote-list-item-title {
            font-weight: 500;
            font-size: 1.125rem;
            color: var(--text-primary);
        }

        .quote-list-item-amount {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .quote-list-item-meta {
            display: flex;
            gap: 16px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .quote-list-item-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .quote-empty {
            text-align: center;
            padding: 80px 40px;
            color: var(--text-secondary);
        }

        .quote-empty h3 {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        /* Editable Line Items */
        .line-item.editable {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: start;
            padding: 20px 0;
        }

        .line-item-edit-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .line-item-name-input,
        .line-item-desc-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .line-item-name-input {
            font-weight: 500;
        }

        .line-item-desc-input {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .line-item-name-input:focus,
        .line-item-desc-input:focus {
            outline: none;
            border-color: var(--text-primary);
        }

        .line-item-amount-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            color: var(--text-primary);
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-weight: 500;
            width: 140px;
            text-align: right;
        }

        .line-item-amount-input:focus {
            outline: none;
            border-color: var(--text-primary);
        }

        /* Edit Mode Indicator */
        .edit-mode-banner {
            display: none;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 24px;
            color: var(--warning);
            font-size: 0.875rem;
            align-items: center;
            gap: 12px;
        }

        .edit-mode-banner.active {
            display: flex;
        }

        .edit-mode-banner .icon {
            font-size: 1.25rem;
        }

        /* Save Changes Button */
        .save-changes-section {
            display: none;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .save-changes-section.active {
            display: flex;
        }

        .correction-notes-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 0.875rem;
            resize: none;
            min-height: 60px;
        }

        .correction-notes-input:focus {
            outline: none;
            border-color: var(--text-primary);
        }

        .correction-notes-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .save-actions {
            display: flex;
            gap: 12px;
        }

        .changes-summary {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        /* Issue Reporter */
        .issue-fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .issue-fab:hover {
            background: var(--bg-elevated);
            border-color: var(--border-hover);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .issue-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            padding: 24px;
        }

        .issue-modal.active {
            display: flex;
        }

        .issue-modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            animation: fadeIn 0.3s ease-out;
        }

        .issue-modal h3 {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .issue-modal .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
        }

        .issue-modal .close-btn:hover {
            color: var(--text-primary);
        }

        .issue-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .issue-success {
            text-align: center;
            padding: 40px 20px;
        }

        .issue-success .checkmark {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(74, 222, 128, 0.15);
            color: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 24px;
        }

        .issue-success h3 {
            justify-content: center;
            margin-bottom: 12px;
        }

        .issue-success p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        /* Footer */
        .footer {
            padding: 40px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        /* Mobile Bottom Navigation - hidden by default, shown on mobile */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 8px 16px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 100;
            justify-content: space-around;
        }

        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
            min-width: 64px;
        }

        .mobile-nav-btn:hover,
        .mobile-nav-btn.active {
            color: var(--text-primary);
        }

        .mobile-nav-icon {
            font-size: 1.25rem;
        }

        .mobile-nav-label {
            font-size: 0.625rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Responsive */
        @media (max-width: 640px) {
            nav {
                padding: 16px 20px;
                background: var(--bg-primary); /* Solid background on mobile to prevent content showing through */
            }

            .container {
                padding: 0 16px;
            }

            main {
                padding-top: 100px; /* Keep buffer for nav height */
            }

            .card {
                padding: 24px;
            }

            .voice-section {
                padding: 40px 24px;
            }

            .record-btn {
                width: 120px;
                height: 120px;
            }

            .quote-total {
                padding: 24px;
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }

            .total-amount {
                font-size: 2.5rem;
            }

            .quote-actions {
                flex-direction: column;
            }

            .quote-actions .btn {
                width: 100%;
            }

            /* Quote header: stack vertically on mobile so confidence badge is visible below nav */
            .quote-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .quote-header h2 {
                font-size: 1.5rem;
            }

            /* Line item editing: stack vertically on mobile for better alignment */
            .line-item.editable {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .line-item-edit-group {
                width: 100%;
            }

            .line-item-name-input,
            .line-item-desc-input {
                width: 100%;
            }

            .line-item-amount-input {
                width: 100%;
                text-align: left;
            }

            .issue-form .form-row {
                grid-template-columns: 1fr;
            }

            .onboarding-options {
                flex-direction: column;
            }

            .onboarding-options .btn {
                width: 100%;
                max-width: 100%;
            }

            .btn-large {
                padding: 14px 24px;
                font-size: 1rem;
            }

            /* Hide navigation tabs on mobile - !important overrides inline JS styles */
            .app-nav {
                display: none !important;
            }

            /* Show mobile bottom navigation */
            .mobile-nav.active {
                display: flex !important;
            }

            /* Add padding for mobile nav bar */
            main {
                padding-bottom: 100px;
            }

            /* Extra padding on cards for mobile nav clearance */
            .quote-result {
                padding-bottom: 80px;
            }

            /* Make modal fit iPhone SE and small screens */
            .modal-content {
                max-width: 95%;
                width: 95%;
                padding: 24px 20px;
                max-height: 85vh;
            }

            /* Account tabs - horizontal scroll on mobile */
            .account-tabs {
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;  /* Firefox */
                -ms-overflow-style: none;  /* IE/Edge */
                margin: 16px -16px 24px -16px;  /* Extend to card edges */
                padding: 0 16px;
            }

            .account-tabs::-webkit-scrollbar {
                display: none;  /* Chrome/Safari */
            }

            .account-tab-btn {
                padding: 10px 16px;
                font-size: 0.8125rem;
                flex-shrink: 0;
            }
        }

        /* Responsive - Tablet (641px - 768px) */
        @media (min-width: 641px) and (max-width: 768px) {
            .modal-content {
                max-width: 90%;
                padding: 32px 24px;
            }

            .app-nav {
                gap: 6px;
            }

            .app-nav-btn {
                padding: 10px 16px;
                font-size: 0.75rem;
            }
        }

        /* Responsive - Extra Small Mobile (iPhone SE - 375px and below) */
        @media (max-width: 375px) {
            nav {
                padding: 12px 16px;
            }

            .logo {
                font-size: 1.25rem;
            }

            .container {
                padding: 0 12px;
            }

            .card {
                padding: 20px 16px;
            }

            .voice-section {
                padding: 32px 16px;
            }

            .record-btn {
                width: 100px;
                height: 100px;
                font-size: 0.625rem;
            }

            .modal-content {
                padding: 20px 16px;
            }

            .total-amount {
                font-size: 1.75rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .card-title {
                font-size: 1.25rem;
            }

            .btn {
                padding: 12px 24px;
                font-size: 0.8125rem;
            }

            .transcription-preview {
                padding: 24px 16px;
            }

            .preview-actions {
                flex-direction: column;
                gap: 12px;
            }

            .preview-actions .btn {
                width: 100%;
            }
        }

        /* Billing & Pricing Styles */
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }

        .pricing-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .pricing-card.featured {
            border-color: var(--text-primary);
            background: var(--bg-elevated);
        }

        .pricing-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-4px);
        }

        .pricing-card.featured:hover {
            border-color: var(--text-primary);
        }

        .plan-name {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .plan-price {
            font-size: 3rem;
            font-weight: 400;
            margin-bottom: 4px;
            font-family: var(--font-sans);
        }

        .plan-price .currency {
            font-size: 1.5rem;
            color: var(--text-secondary);
        }

        .plan-price .period {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .plan-annual-note {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .plan-features {
            list-style: none;
            margin: 24px 0;
            flex-grow: 1;
        }

        .plan-features li {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9375rem;
            color: var(--text-secondary);
        }

        .plan-features li:last-child {
            border-bottom: none;
        }

        .plan-features li strong {
            color: var(--text-primary);
        }

        .billing-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
            font-size: 0.875rem;
        }

        .billing-toggle button {
            padding: 8px 20px;
            border-radius: 100px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-family: var(--font-sans);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .billing-toggle button.active {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .billing-toggle button:hover:not(.active) {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .discount-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--success);
            color: var(--bg-primary);
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 100px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .usage-widget {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .usage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .usage-plan {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .usage-stats {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .usage-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 100px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .usage-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning));
            border-radius: 100px;
            transition: width 0.6s ease;
        }

        .usage-bar-fill.warning {
            background: var(--warning);
        }

        .usage-bar-fill.critical {
            background: var(--error);
        }

        .usage-details {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .trial-banner {
            background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
            color: var(--bg-primary);
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trial-banner strong {
            font-weight: 600;
        }

        .trial-banner .btn {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 10px 20px;
        }

        .trial-banner .btn:hover {
            background: var(--bg-card);
        }

        /* DISC-018: Trial warning banners */
        .trial-warning-banner {
            padding: 14px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 12px;
            font-size: 0.9375rem;
        }

        .trial-warning-banner.active {
            display: flex;
        }

        .trial-warning-banner.soft {
            background: rgba(251, 191, 36, 0.08);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

        .trial-warning-banner.urgent {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .trial-warning-banner.grace {
            background: rgba(239, 68, 68, 0.12);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
            font-weight: 500;
        }

        .trial-warning-banner .icon {
            font-size: 1.25rem;
        }

        .trial-warning-banner .message {
            flex: 1;
        }

        .trial-warning-banner .btn-small {
            padding: 8px 16px;
            font-size: 0.8125rem;
            background: var(--text-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
        }

        .trial-warning-banner .btn-small:hover {
            background: var(--accent-hover);
        }

        .billing-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .billing-info-item {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .billing-info-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }

        .billing-info-value {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Upgrade Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            padding: 40px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            min-width: 44px;
            min-height: 44px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .modal-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-family: var(--font-serif);
            font-size: 2rem;
            font-weight: 500;
            text-align: center;
            margin-bottom: 16px;
            letter-spacing: -0.02em;
        }

        .modal-subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.6;
        }

        /* Celebration Modal */
        .celebration-content {
            max-width: 600px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .celebration-confetti {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
        }

        .celebration-icon {
            font-size: 5rem;
            margin-bottom: 16px;
            animation: celebration-bounce 0.8s ease-out;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 4px 12px rgba(124, 58, 237, 0.3));
        }

        @keyframes celebration-bounce {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        .celebration-social-proof {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(124, 58, 237, 0.08));
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 20px;
            padding: 8px 16px;
            margin: 16px 0;
            font-size: 0.875rem;
            color: var(--text-primary);
            animation: celebration-pulse 2s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }

        @keyframes celebration-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(124, 58, 237, 0); }
        }

        .celebration-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
            position: relative;
            z-index: 1;
        }

        .celebration-progress-icon {
            font-size: 1.5rem;
        }

        .celebration-progress-text {
            text-align: left;
        }

        .celebration-progress-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .celebration-progress-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .celebration-primary-cta {
            width: 100%;
            margin: 24px 0 16px 0;
            position: relative;
            z-index: 1;
        }

        .celebration-referral-section {
            position: relative;
            z-index: 1;
        }

        .celebration-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
            position: relative;
            z-index: 1;
        }

        .celebration-actions .btn {
            flex: 1;
            max-width: 200px;
        }

        @media (max-width: 768px) {
            .celebration-icon {
                font-size: 4rem;
            }
            .celebration-actions {
                flex-direction: column;
            }
            .celebration-actions .btn {
                max-width: 100%;
            }
        }

        /* Confetti Animation */
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100%) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti-piece {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            opacity: 0.8;
            animation: confetti-fall 3s linear infinite;
        }

        /* Account Tabs */
        .account-tabs {
            display: flex;
            gap: 8px;
            margin: 24px 0 32px 0;
            border-bottom: 1px solid var(--border);
        }

        .account-tab-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: var(--font-sans);
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .account-tab-btn:hover {
            color: var(--text-primary);
        }

        .account-tab-btn.active {
            color: var(--text-primary);
            border-bottom-color: var(--text-primary);
        }

        .account-tab-content {
            display: none;
        }

        .account-tab-content.active {
            display: block;
        }

        /* Pricing Brain Styles */
        .pricing-brain-section {
            margin-bottom: 48px;
        }

        .section-title {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }

        .section-subtitle {
            color: var(--text-secondary);
            margin-bottom: 24px;
            font-size: 0.9375rem;
        }

        .global-settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .global-setting-item {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .global-setting-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }

        .global-setting-value {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .category-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .category-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .category-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .category-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .category-name {
            font-family: var(--font-serif);
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 100px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .category-badge.high-confidence {
            background: var(--success);
            color: var(--bg-primary);
        }

        .category-badge.medium-confidence {
            background: var(--warning);
            color: var(--bg-primary);
        }

        .category-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        .category-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .category-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
        }

        .category-rules-preview {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .category-rules-preview p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 4px 0;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            background: rgba(255,255,255,0.02);
            border-radius: 12px;
            border: 1px dashed rgba(255,255,255,0.1);
            max-width: 400px;
            margin: 2rem auto;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .empty-state h3 {
            color: #fff;
            margin-bottom: 0.5rem;
            font-family: var(--font-serif);
        }

        .empty-state h4 {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state p {
            color: rgba(255,255,255,0.7);
            line-height: 1.5;
            font-size: 0.9375rem;
        }

        .empty-state .tip {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.5);
            margin-top: 1rem;
        }

        .empty-state .subtext {
            color: rgba(255,255,255,0.6);
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .empty-state .cta-button {
            margin-top: 1.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .empty-state .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Learning Progress Styles (DISC-008) */
        .learning-progress-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .progress-title {
            font-family: var(--font-serif);
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }

        .progress-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .progress-percentage {
            font-size: 2rem;
            font-weight: 600;
            color: var(--accent);
        }

        .progress-bar-container {
            width: 100%;
            height: 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .learning-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .learning-stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .top-categories-section {
            margin-top: 24px;
        }

        .subsection-title {
            font-family: var(--font-serif);
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .top-categories-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .category-progress-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-progress-info {
            flex: 1;
        }

        .category-progress-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .category-progress-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .category-confidence-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-elevated);
            border-radius: 20px;
        }

        .confidence-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .confidence-bar-mini {
            width: 60px;
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            overflow: hidden;
        }

        .confidence-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
        }

        @media (max-width: 640px) {
            .pricing-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 32px 24px;
            }

            .billing-info-grid {
                grid-template-columns: 1fr;
            }

            .category-cards-grid {
                grid-template-columns: 1fr;
            }

            .global-settings-grid {
                grid-template-columns: 1fr;
            }

            .learning-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .progress-percentage {
                font-size: 1.5rem;
            }
        }

        /* First Quote Activation Modal */
        .first-quote-modal-content {
            max-width: 480px;
            text-align: center;
            padding: 48px 40px;
        }

        .first-quote-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .first-quote-modal-content h2 {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            margin-bottom: 12px;
        }

        .first-quote-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 32px;
        }

        .first-quote-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .first-quote-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .first-quote-option:hover {
            background: var(--bg-elevated);
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .option-icon {
            font-size: 1.5rem;
            min-width: 40px;
            text-align: center;
        }

        .option-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .option-text strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .option-text small {
            color: var(--text-secondary);
            font-size: 0.8125rem;
        }

        .first-quote-skip {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.875rem;
            cursor: pointer;
            padding: 8px 16px;
            transition: color 0.2s ease;
        }

        .first-quote-skip:hover {
            color: var(--text-secondary);
        }

        /* Mobile adjustments for first quote modal */
        @media (max-width: 480px) {
            .first-quote-modal-content {
                padding: 32px 24px;
            }

            .first-quote-option {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <a href="/" class="logo">quoted<span>.it</span></a>
        <div class="nav-right" id="navRight" style="display: none;">
            <div class="app-nav" id="appNav" style="display: none;">
                <button class="app-nav-btn active" id="newQuoteNavBtn" onclick="showAppSection('newQuote')">New Quote</button>
                <button class="app-nav-btn" id="myQuotesNavBtn" onclick="showAppSection('myQuotes')">My Quotes</button>
                <button class="app-nav-btn" id="accountNavBtn" onclick="showAppSection('account')">Account</button>
                <a href="/help" class="app-nav-btn" style="text-decoration: none;">Help</a>
            </div>
            <div class="nav-user">
                <div class="business-name" id="businessNameDisplay"></div>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </div>
    </nav>

    <main class="container">
        <!-- Auth View -->
        <div class="view auth-container" id="authView">
            <div class="auth-header animate-in">
                <h1>Voice to quote<br>in seconds.</h1>
                <p class="subtitle" style="margin-top: 16px;">Turn job site visits into professional estimates instantly.</p>
            </div>

            <div class="card animate-in-delayed">
                <div class="auth-tabs">
                    <button class="auth-tab active" id="loginTab" onclick="showAuthTab('login')">Sign In</button>
                    <button class="auth-tab" id="registerTab" onclick="showAuthTab('register')">Create Account</button>
                </div>

                <!-- Login Form -->
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="you@company.com" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" id="loginBtn">Sign In</button>
                </form>

                <!-- Register Form -->
                <form id="registerForm" style="display: none;" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" id="registerBusiness" placeholder="Your Company Name" required>
                    </div>
                    <div class="form-group">
                        <label>Your Name</label>
                        <input type="text" id="registerName" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="registerEmail" placeholder="you@company.com" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="registerPhone" placeholder="(555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" placeholder="Create a password" required minlength="8">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" id="registerBtn">Create Account</button>
                </form>

                <div class="message" id="authMessage"></div>
            </div>
        </div>

        <!-- Main App View -->
        <div class="view" id="appView">
            <!-- Onboarding Notice -->
            <div class="card onboarding-notice" id="onboardingNotice" style="display: none;">
                <!-- Industry Selection -->
                <div id="industrySelection" style="display: none;">
                    <h3>What type of work do you do?</h3>
                    <p>This helps us customize your pricing setup</p>

                    <div class="industry-grid" id="industryGrid">
                        <!-- Industry cards will be inserted here by JavaScript -->
                    </div>

                    <div class="industry-other-input" id="industryOtherInput">
                        <input type="text" id="industryOtherText" placeholder="Enter your trade or industry...">
                    </div>

                    <div class="industry-continue-btn">
                        <button class="btn btn-primary" id="industryContinueBtn" onclick="continueFromIndustrySelection()" disabled>Continue</button>
                    </div>
                </div>

                <!-- Intro Screen -->
                <div id="onboardingIntro" class="onboarding-intro" style="display: none;">
                    <h3>Ready to create quotes?</h3>
                    <p>Choose how you'd like to get started. You can always customize your pricing later.</p>

                    <ul>
                        <li class="onboarding-option-recommended" onclick="handleTryFirst()" style="cursor: pointer;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <strong>Try a Quote Now</strong>
                                <span class="recommended-badge">Fastest</span>
                            </div>
                            Generate your first quote in 2 minutes using industry defaults. Perfect for testing Quoted.
                        </li>
                        <li onclick="startOnboardingInterview()" style="cursor: pointer;">
                            <strong>Quick Chat Setup</strong>
                            ~3 minutes  Voice OR text  We'll build your pricing profile together
                        </li>
                        <li class="onboarding-option-manual" onclick="showQuickSetup()" style="cursor: pointer;">
                            <strong>Manual Setup</strong>
                            Enter your exact rates if you know them. Most customizable option.
                        </li>
                    </ul>

                    <div class="onboarding-options">
                        <button class="btn btn-primary btn-large" onclick="handleTryFirst()">
                            <span style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                                Try a Quote Now
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14"></path>
                                    <path d="M12 5l7 7-7 7"></path>
                                </svg>
                            </span>
                        </button>
                        <div style="display: flex; gap: 12px; width: 100%;">
                            <button class="btn btn-link" onclick="startOnboardingInterview()" style="flex: 1;">Quick Chat</button>
                            <button class="btn btn-link" onclick="showQuickSetup()" style="flex: 1;">Manual Setup</button>
                        </div>
                    </div>
                </div>

                <!-- Quick Setup Form -->
                <div id="quickSetupForm" style="display: none;">
                    <h3>Manual Setup</h3>
                    <p id="quickSetupDescription">Enter your rates directly. You can always refine these through the guided setup or quotes over time.</p>

                    <!-- Template Guidance -->
                    <div id="templateGuidance" style="display: none; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; margin-top: 2px; color: var(--accent);">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 16v-4"></path>
                                <path d="M12 8h.01"></path>
                            </svg>
                            <div style="flex: 1;">
                                <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 4px;">Recommended Approach</h4>
                                <p id="templateApproach" style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5; margin: 0;"></p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Primary Trade</label>
                        <select id="primaryTrade" onchange="onPrimaryTradeChange()">
                            <option value="deck_builder">Deck Builder</option>
                            <option value="general_contractor">General Contractor</option>
                            <option value="painter">Painter</option>
                            <option value="landscaper">Landscaper</option>
                            <option value="roofer">Roofer</option>
                            <option value="electrician">Electrician</option>
                            <option value="plumber">Plumber</option>
                            <option value="hvac">HVAC</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <!-- Dynamic form fields will be rendered here based on industry template -->
                    <div id="dynamicFormFields">
                        <!-- Default fallback fields (shown for industries without templates) -->
                        <div class="form-group">
                            <label>Hourly Labor Rate ($)</label>
                            <input type="number" id="hourlyRate" placeholder="85" value="85">
                            <small id="hourlyRateHint" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px; display: none;"></small>
                        </div>
                        <div class="form-group">
                            <label>Material Markup (%)</label>
                            <input type="number" id="materialMarkup" placeholder="20" value="20">
                            <small id="materialMarkupHint" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px; display: none;"></small>
                        </div>
                        <div class="form-group">
                            <label>Minimum Job Amount ($)</label>
                            <input type="number" id="minimumJob" placeholder="500" value="500">
                            <small id="minimumJobHint" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px; display: none;"></small>
                        </div>
                    </div>

                    <!-- Pricing Tips -->
                    <div id="pricingTipsSection" style="display: none; margin-top: 24px;">
                        <button onclick="togglePricingTips()" type="button" style="background: none; border: none; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 0; font-size: 0.9rem; font-weight: 600; width: 100%; text-align: left;">
                            <svg id="tipsChevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            Pricing Tips for Your Industry
                        </button>
                        <div id="pricingTipsContent" style="display: none; margin-top: 12px; padding-left: 24px;">
                            <ul id="pricingTipsList" style="color: var(--text-secondary); font-size: 0.875rem; line-height: 1.6; margin: 0; padding-left: 20px;">
                            </ul>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button class="btn btn-secondary" onclick="showOnboardingIntro()">Back</button>
                        <button class="btn btn-primary" style="flex: 1;" onclick="completeQuickSetup()">Save & Start</button>
                    </div>
                </div>

                <!-- Interview Chat -->
                <div id="onboardingChat" class="onboarding-chat">
                    <div class="chat-header">
                        <h3>Pricing Interview</h3>
                        <p>Tell me about how you price your work. Type or use voice.</p>
                    </div>

                    <div class="chat-messages" id="chatMessages"></div>

                    <div class="chat-input-area">
                        <textarea
                            id="chatInput"
                            placeholder="Type your response..."
                            onkeydown="handleChatKeydown(event)"
                        ></textarea>
                        <div class="chat-actions">
                            <button class="chat-btn" id="chatVoiceBtn" onclick="toggleChatVoice()" title="Voice input">
                                <span></span>
                            </button>
                            <button class="chat-btn send" id="chatSendBtn" onclick="sendChatMessage()" title="Send">
                                <span></span>
                            </button>
                        </div>
                    </div>

                    <div class="chat-footer">
                        <button class="chat-btn-text" onclick="showOnboardingIntro()">Cancel</button>
                        <button class="chat-btn-text done" id="finishInterviewBtn" onclick="finishInterview()" style="display: none;">
                            Finish & Save
                        </button>
                    </div>
                </div>
            </div>

            <!-- DISC-018: Trial Warning Banner -->
            <div class="trial-warning-banner" id="trialWarningBanner">
                <span class="icon" id="trialWarningIcon"></span>
                <div class="message" id="trialWarningMessage"></div>
                <button class="btn-small" onclick="showAccountView(); showAccountTab('billing')">Upgrade</button>
            </div>

            <!-- Input Section -->
            <div class="card voice-section" id="inputSection">
                <h2 class="card-title" style="font-family: var(--font-serif); font-weight: 400;">
                    Describe the job.
                    <span class="browser-badge" id="browserBadge" style="display: none;">
                        <span class="browser-badge-dot"></span>
                        <span id="browserBadgeText">Voice Ready</span>
                    </span>
                </h2>

                <!-- Voice not supported warning -->
                <div class="voice-warning" id="voiceWarning">
                    Voice recording works best on Chrome or Edge. You can also type your job description below.
                </div>

                <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
                    <span id="recordBtnText">Record</span>
                </button>
                <p class="record-instructions" id="recordInstructions">
                    Click to start recording your voice note
                </p>

                <!-- Fallback link for voice issues -->
                <a class="voice-fallback-link" id="voiceFallbackLink" onclick="switchToTextInput()">
                    Having trouble? Type instead 
                </a>

                <div class="text-divider">or type it out</div>

                <div class="job-input-container">
                    <textarea
                        id="jobDescription"
                        placeholder="Quote for Mrs. Johnson at 123 Oak Street - painting the living room and hallway, about 400 square feet total, she wants Benjamin Moore paint in eggshell finish, standard prep work and two coats..."
                    ></textarea>
                    <button class="btn btn-primary" onclick="generateQuote()">Generate Quote</button>
                </div>
            </div>

            <!-- Loading State -->
            <div class="card loading" id="loadingSection">
                <div class="loading-animation">
                    <span class="quote-mark left">"</span>
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                    <span class="quote-mark right">"</span>
                </div>
                <p class="loading-text" id="loadingText">Generating your quote...</p>
                <p class="loading-subtext" id="loadingSubtext">Analyzing your pricing model</p>
            </div>

            <!-- Transcription Preview Section -->
            <div class="card transcription-preview" id="transcriptionPreview" style="display: none;">
                <h2 class="card-title" style="font-family: var(--font-serif); font-weight: 400;">Review your transcription</h2>
                <p class="preview-subtitle">Edit any mistakes before generating your quote</p>

                <textarea
                    id="transcriptionText"
                    class="transcription-textarea"
                    placeholder="Your transcription will appear here..."
                ></textarea>

                <div class="preview-actions">
                    <button class="btn btn-secondary" onclick="reRecord()">
                        <span class="btn-icon"></span> Re-record
                    </button>
                    <button class="btn btn-primary" onclick="generateFromTranscription()">
                        Generate Quote
                    </button>
                </div>
            </div>

            <!-- Error Message -->
            <div class="message error" id="errorMessage"></div>

            <!-- Quote Result -->
            <div class="card quote-result" id="quoteResult">
                <div class="quote-header">
                    <h2>Budgetary Estimate</h2>
                    <span class="confidence-badge" id="confidenceBadge">High Confidence</span>
                </div>

                <div class="job-description" id="jobDescriptionDisplay"></div>

                <div class="line-items" id="lineItems"></div>

                <div class="quote-total">
                    <span class="total-label">Estimated Total</span>
                    <span class="total-amount" id="totalAmount">$0</span>
                </div>

                <div class="quote-notes" id="quoteNotes" style="display: none;">
                    <h4>Notes</h4>
                    <p id="notesContent"></p>
                </div>

                <div class="transcription" id="transcriptionDisplay" style="display: none;"></div>

                <div class="quote-actions">
                    <button class="btn btn-primary" onclick="downloadPdf()">Download PDF</button>
                    <button class="btn btn-secondary" onclick="editCurrentQuote()">Edit Quote</button>
                    <button class="btn btn-secondary" onclick="newQuote()">New Quote</button>
                </div>

                <!-- Feedback Section (Enhancement 4) -->
                <div class="feedback-section" id="feedbackSection">
                    <div class="feedback-header" onclick="toggleFeedback()">
                        <h4>Rate this quote</h4>
                        <span class="feedback-toggle" id="feedbackToggle">+</span>
                    </div>

                    <div class="feedback-content" id="feedbackContent" style="display: none;">
                        <!-- Star Rating -->
                        <div class="feedback-group">
                            <label>Overall Rating</label>
                            <div class="star-rating" id="starRating">
                                <span class="star" data-rating="1"></span>
                                <span class="star" data-rating="2"></span>
                                <span class="star" data-rating="3"></span>
                                <span class="star" data-rating="4"></span>
                                <span class="star" data-rating="5"></span>
                            </div>
                        </div>

                        <!-- Quick Pricing Feedback -->
                        <div class="feedback-group">
                            <label>How was the pricing?</label>
                            <div class="pricing-buttons">
                                <button type="button" class="pricing-btn" data-direction="too_low" onclick="setPricingDirection('too_low')">
                                    Too Low
                                </button>
                                <button type="button" class="pricing-btn active" data-direction="about_right" onclick="setPricingDirection('about_right')">
                                    About Right
                                </button>
                                <button type="button" class="pricing-btn" data-direction="too_high" onclick="setPricingDirection('too_high')">
                                    Too High
                                </button>
                            </div>
                        </div>

                        <!-- Issues Checkboxes -->
                        <div class="feedback-group">
                            <label>Any issues?</label>
                            <div class="issue-checkboxes">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="missing_items" onchange="updateIssues(this)">
                                    Missing items
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="wrong_quantities" onchange="updateIssues(this)">
                                    Wrong quantities
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="unclear_description" onchange="updateIssues(this)">
                                    Unclear description
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="timeline_unrealistic" onchange="updateIssues(this)">
                                    Timeline unrealistic
                                </label>
                            </div>
                        </div>

                        <!-- Optional Text Feedback -->
                        <div class="feedback-group">
                            <label>Comments (optional)</label>
                            <textarea id="feedbackText" placeholder="What could be improved?"></textarea>
                        </div>

                        <div class="feedback-actions">
                            <button class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
                            <span class="feedback-status" id="feedbackStatus"></span>
                        </div>
                    </div>
                </div>

                <!-- Powered by Quoted Branding -->
                <div class="quote-branding">
                    <a href="https://quoted.it" target="_blank" rel="noopener noreferrer">
                        <span class="branding-text">Powered by</span>
                        <span class="branding-logo">quoted<span class="branding-logo-it">.it</span></span>
                    </a>
                </div>
            </div>

            <!-- My Quotes Section (Quote History) -->
            <div class="card" id="myQuotesSection" style="display: none;">
                <div class="quote-history-header">
                    <h2>My Quotes</h2>
                    <span class="quote-history-count" id="quoteCount">0 quotes</span>
                </div>

                <div class="quote-list" id="quoteList">
                    <!-- Quote list items will be populated via JavaScript -->
                </div>

                <div class="empty-state" id="quoteEmpty" style="display: none;">
                    <div class="empty-icon"></div>
                    <h3>No quotes yet</h3>
                    <p>Create your first quote in under 2 minutes.<br>Just describe the job - voice or text.</p>
                    <button class="cta-button" onclick="showAppSection('newQuote')">Generate Your First Quote</button>
                    <p class="tip"> Tip: Try the voice recorder - just describe the job like you would to a customer</p>
                </div>

                <div id="quoteLoadingState" style="display: none; text-align: center; padding: 40px;">
                    <div class="spinner" style="display: inline-block;"></div>
                    <p style="margin-top: 16px; color: var(--text-secondary);">Loading your quotes...</p>
                </div>
            </div>

            <!-- Quote Detail View (for viewing/editing a specific quote) -->
            <div class="card quote-result" id="quoteDetailView" style="display: none;">
                <div class="edit-mode-banner" id="editModeBanner">
                    <span class="icon"></span>
                    <span>Edit mode active  Changes will train the AI on your pricing preferences</span>
                </div>

                <div class="quote-header">
                    <h2 id="detailQuoteTitle">Quote Details</h2>
                    <span class="confidence-badge" id="detailConfidenceBadge">High Confidence</span>
                </div>

                <!-- Customer Info Section -->
                <div class="customer-info-section" id="customerInfoSection">
                    <div class="customer-info-header">
                        <h3>Customer Information</h3>
                        <button class="btn-icon" onclick="openEditCustomerModal()" title="Edit customer info">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M11.333 2.00004C11.5081 1.82494 11.716 1.68605 11.9447 1.59129C12.1735 1.49653 12.4187 1.44775 12.6663 1.44775C12.914 1.44775 13.1592 1.49653 13.3879 1.59129C13.6167 1.68605 13.8246 1.82494 13.9997 2.00004C14.1748 2.17513 14.3137 2.383 14.4084 2.61178C14.5032 2.84055 14.552 3.08575 14.552 3.33337C14.552 3.58099 14.5032 3.82619 14.4084 4.05497C14.3137 4.28374 14.1748 4.49161 13.9997 4.66671L5.33301 13.3334L1.66634 14.3334L2.66634 10.6667L11.333 2.00004Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="customer-info-grid">
                        <div class="customer-info-item">
                            <div class="customer-info-label">Name</div>
                            <div class="customer-info-value" id="customerNameDisplay"></div>
                        </div>
                        <div class="customer-info-item">
                            <div class="customer-info-label">Address</div>
                            <div class="customer-info-value" id="customerAddressDisplay"></div>
                        </div>
                        <div class="customer-info-item">
                            <div class="customer-info-label">Phone</div>
                            <div class="customer-info-value" id="customerPhoneDisplay"></div>
                        </div>
                    </div>
                </div>

                <div class="job-description" id="detailJobDescription"></div>

                <div class="line-items" id="detailLineItems">
                    <!-- Editable line items will be populated via JavaScript -->
                </div>

                <div class="quote-total">
                    <span class="total-label">Estimated Total</span>
                    <span class="total-amount" id="detailTotalAmount">$0</span>
                </div>

                <div class="quote-notes" id="detailQuoteNotes" style="display: none;">
                    <h4>Notes</h4>
                    <p id="detailNotesContent"></p>
                </div>

                <!-- Save Changes Section -->
                <div class="save-changes-section" id="saveChangesSection">
                    <div class="changes-summary" id="changesSummary">
                        No changes made
                    </div>
                    <div>
                        <label class="correction-notes-label">Why did you make these changes? (helps AI learn)</label>
                        <textarea class="correction-notes-input" id="correctionNotes" placeholder="e.g., 'Labor costs are higher in this area' or 'Customer wants premium materials'"></textarea>
                    </div>
                    <div class="save-actions">
                        <button class="btn btn-secondary" onclick="cancelQuoteEdit()">Cancel</button>
                        <button class="btn btn-primary" id="saveChangesBtn" onclick="saveQuoteChanges()" disabled>Save Changes</button>
                    </div>
                </div>

                <div class="quote-actions" id="detailQuoteActions">
                    <button class="btn btn-primary" onclick="downloadDetailPdf()">Download PDF</button>
                    <button class="btn btn-primary" onclick="openShareModal()"> Share</button>
                    <button class="btn btn-secondary" onclick="duplicateQuote()"> Duplicate</button>
                    <button class="btn btn-secondary" onclick="backToQuoteList()">Back to My Quotes</button>
                </div>
            </div>

            <!-- Account/Billing Section -->
            <div class="card" id="accountSection" style="display: none;">
                <h2 class="card-title">Account & Billing</h2>

                <!-- Account Tabs -->
                <div class="account-tabs">
                    <button class="account-tab-btn active" id="billingTabBtn" onclick="showAccountTab('billing')">Billing</button>
                    <button class="account-tab-btn" id="referralTabBtn" onclick="showAccountTab('referral')">Referral</button>
                    <button class="account-tab-btn" id="logoTabBtn" onclick="showAccountTab('logo')">Business Logo</button>
                    <button class="account-tab-btn" id="pricingBrainTabBtn" onclick="showAccountTab('pricingBrain')">Pricing Brain</button>
                </div>

                <!-- Billing Tab Content -->
                <div id="billingTabContent" class="account-tab-content active">
                <!-- Trial Banner (shown during trial) -->
                <div class="trial-banner" id="trialBanner" style="display: none;">
                    <div>
                        <strong>Free Trial</strong>  <span id="trialDaysLeft"></span>
                    </div>
                    <button class="btn" onclick="showUpgradeSection()">Upgrade Now</button>
                </div>

                <!-- Usage Widget -->
                <div class="usage-widget">
                    <div class="usage-header">
                        <div class="usage-plan" id="currentPlan">Starter Plan</div>
                        <div class="usage-stats" id="usageStats">0 / 75</div>
                    </div>
                    <div class="usage-bar">
                        <div class="usage-bar-fill" id="usageBarFill" style="width: 0%"></div>
                    </div>
                    <div class="usage-details" id="usageDetails">
                        0 quotes remaining this month
                    </div>
                </div>

                <!-- Billing Info -->
                <div class="billing-info-grid" id="billingInfoGrid" style="display: none;">
                    <div class="billing-info-item">
                        <div class="billing-info-label">Next Billing Date</div>
                        <div class="billing-info-value" id="nextBillingDate"></div>
                    </div>
                    <div class="billing-info-item">
                        <div class="billing-info-label">Plan Type</div>
                        <div class="billing-info-value" id="planType"></div>
                    </div>
                    <div class="billing-info-item">
                        <div class="billing-info-label">Current Period</div>
                        <div class="billing-info-value" id="currentPeriod"></div>
                    </div>
                </div>

                <!-- Pricing Section -->
                <div id="pricingSection" style="margin-top: 40px;">
                    <h3 style="margin-bottom: 16px; font-family: var(--font-serif); font-size: 1.75rem;">Choose Your Plan</h3>
                    <p class="subtitle" style="margin-bottom: 32px;">Upgrade anytime. Cancel anytime. No contracts.</p>

                    <div class="billing-toggle">
                        <button id="monthlyBtn" class="active" onclick="toggleBillingPeriod('monthly')">Monthly</button>
                        <button id="annualBtn" onclick="toggleBillingPeriod('annual')">Annual <span class="discount-badge" style="margin-left: 8px;">Save 17%</span></button>
                    </div>

                    <div class="pricing-grid" id="pricingGrid">
                        <!-- Pricing cards will be populated via JavaScript -->
                    </div>
                </div>

                <!-- Manage Subscription (shown for paid users) -->
                <div id="manageSubscription" style="display: none; margin-top: 40px; text-align: center; padding: 40px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 16px; font-family: var(--font-serif);">Manage Your Subscription</h3>
                    <p class="subtitle" style="margin-bottom: 24px;">Update billing info, change plan, or cancel subscription</p>
                    <button class="btn btn-primary" onclick="openCustomerPortal()">Open Billing Portal</button>
                </div>
                </div> <!-- End Billing Tab Content -->

                <!-- Referral Tab Content -->
                <div id="referralTabContent" class="account-tab-content">
                    <!-- Referral Section -->
                    <div class="referral-section" style="background: var(--bg-card); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 1.25rem; font-family: var(--font-serif);">Refer & Earn</h3>
                        <p style="color: var(--text-secondary); margin: 0 0 16px 0; font-size: 0.9rem;">
                            Earn 1 free month for every friend who subscribes. They get 14 days free (instead of 7).
                        </p>

                        <!-- Stats -->
                        <div style="display: flex; gap: 24px; margin-bottom: 16px; flex-wrap: wrap;">
                            <div>
                                <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="referral-count">0</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Referrals</div>
                            </div>
                            <div>
                                <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="referral-credits">0</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Months Earned</div>
                            </div>
                        </div>

                        <!-- Referral Link -->
                        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="referral-link" readonly
                                   style="flex: 1; min-width: 200px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; color: var(--text-primary); font-family: monospace; font-size: 0.9rem;"
                                   value="Loading...">
                            <button onclick="copyReferralLink()"
                                    style="background: var(--accent); color: var(--bg-primary); border: none; border-radius: 8px; padding: 12px 16px; cursor: pointer; font-weight: 600; white-space: nowrap; font-family: var(--font-sans);">
                                Copy Link
                            </button>
                        </div>

                        <!-- Share Buttons -->
                        <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                            <button onclick="shareViaEmail()" style="background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; padding: 8px 16px; cursor: pointer; font-size: 0.85rem; color: var(--text-primary); font-family: var(--font-sans);">
                                 Email
                            </button>
                            <button onclick="shareViaSMS()" style="background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; padding: 8px 16px; cursor: pointer; font-size: 0.85rem; color: var(--text-primary); font-family: var(--font-sans);">
                                 SMS
                            </button>
                        </div>
                    </div>

                    <!-- Email Signature Referral Hack (DISC-021) -->
                    <div class="referral-signature-section" style="background: var(--bg-card); border-radius: 12px; padding: 24px; margin-bottom: 24px; border: 1px solid var(--accent);">
                        <h3 style="margin: 0 0 8px 0; font-size: 1.25rem; font-family: var(--font-serif);">Boost Your Referrals</h3>
                        <p style="color: var(--text-secondary); margin: 0 0 16px 0; font-size: 0.9rem;">
                            Add this to your email signature and turn every quote you send into a referral opportunity. Most contractors send 5-20 emails/day  that's 25-100 free impressions per week.
                        </p>

                        <!-- Projected Earnings -->
                        <div style="background: rgba(0, 255, 136, 0.1); border-left: 3px solid var(--accent); padding: 12px 16px; margin-bottom: 16px; border-radius: 6px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">Projected Monthly Earnings</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--accent);">$114/month in credits</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Based on 20 emails/day  10% conversion  $19/referral</div>
                        </div>

                        <!-- Email Signature Text -->
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500;">Your Email Signature</label>
                            <textarea id="email-signature-text" readonly
                                      style="width: 100%; min-height: 80px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; color: var(--text-primary); font-family: var(--font-sans); font-size: 0.9rem; resize: vertical; line-height: 1.5;"
                            >Loading...</textarea>
                        </div>

                        <!-- Copy Button -->
                        <button onclick="copyEmailSignature()"
                                style="background: var(--accent); color: var(--bg-primary); border: none; border-radius: 8px; padding: 12px 24px; cursor: pointer; font-weight: 600; width: 100%; font-family: var(--font-sans); font-size: 0.95rem;">
                             Copy Signature to Clipboard
                        </button>

                        <!-- Instructions -->
                        <div style="margin-top: 16px; padding: 12px; background: var(--bg-elevated); border-radius: 6px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                                <strong style="color: var(--text-primary);">How to add to your email:</strong><br>
                                1. Click "Copy Signature to Clipboard" above<br>
                                2. Go to your email settings (Gmail, Outlook, etc.)<br>
                                3. Paste into your signature section<br>
                                4. Save and watch the referrals roll in!
                            </div>
                        </div>
                    </div>
                </div> <!-- End Referral Tab Content -->

                <!-- Logo Tab Content (DISC-016) -->
                <div id="logoTabContent" class="account-tab-content">
                    <div style="background: var(--bg-card); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 1.25rem; font-family: var(--font-serif);">Business Logo</h3>
                        <p style="color: var(--text-secondary); margin: 0 0 24px 0; font-size: 0.9rem;">
                            Upload your business logo to appear on all PDF quotes. Supports PNG and JPG (max 2MB).
                        </p>

                        <!-- Current Logo Preview -->
                        <div id="logoPreviewSection" style="margin-bottom: 24px; display: none;">
                            <p style="color: var(--text-secondary); margin: 0 0 12px 0; font-size: 0.875rem; font-weight: 500;">Current Logo</p>
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 24px; text-align: center; position: relative;">
                                <img id="logoPreview" src="" alt="Business Logo" style="max-width: 200px; max-height: 100px; border-radius: 4px;">
                                <button class="btn" onclick="removeLogo()" style="margin-top: 16px; background: var(--bg-primary); color: var(--text-secondary);">Remove Logo</button>
                            </div>
                        </div>

                        <!-- No Logo Message -->
                        <div id="noLogoMessage" style="margin-bottom: 24px;">
                            <p style="color: var(--text-secondary); margin: 0 0 12px 0; font-size: 0.875rem;">
                                No logo uploaded. Your quotes will use a placeholder with your business initial.
                            </p>
                        </div>

                        <!-- Upload Section -->
                        <div>
                            <label for="logoFileInput" class="btn btn-primary" style="display: inline-block; cursor: pointer; margin-bottom: 8px;">
                                Choose Logo File
                            </label>
                            <input type="file" id="logoFileInput" accept="image/png,image/jpeg" style="display: none;" onchange="handleLogoFileSelect(event)">
                            <p id="logoFileName" style="color: var(--text-secondary); margin: 8px 0 0 0; font-size: 0.875rem;"></p>
                            <div id="logoUploadError" style="color: #ef4444; margin-top: 8px; font-size: 0.875rem; display: none;"></div>
                            <div id="logoUploadSuccess" style="color: #10b981; margin-top: 8px; font-size: 0.875rem; display: none;"></div>
                        </div>
                    </div>
                </div> <!-- End Logo Tab Content -->

                <!-- Pricing Brain Tab Content -->
                <div id="pricingBrainTabContent" class="account-tab-content">
                    <!-- Global Settings Panel -->
                    <div class="pricing-brain-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3 class="section-title" style="margin-bottom: 0;">Global Pricing Settings</h3>
                            <button class="icon-button" onclick="openEditGlobalSettingsModal()" title="Edit global settings">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                        <p class="section-subtitle">Base rates you configured during onboarding</p>
                        <div class="global-settings-grid" id="globalSettingsGrid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Learning Progress Section (DISC-008) -->
                    <div class="pricing-brain-section" id="learningProgressSection" style="display: none;">
                        <h3 class="section-title">Your AI Learning Progress</h3>
                        <p class="section-subtitle">See how your AI is getting smarter with each quote</p>

                        <!-- Overall Progress Bar -->
                        <div class="learning-progress-card">
                            <div class="progress-header">
                                <div>
                                    <h4 class="progress-title">AI Knowledge</h4>
                                    <p class="progress-subtitle" id="learningProgressSubtitle">Loading...</p>
                                </div>
                                <div class="progress-percentage" id="learningProgressPercent">0%</div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="learningProgressBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Learning Stats Grid -->
                        <div class="learning-stats-grid">
                            <div class="learning-stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-value" id="totalQuotesStat">0</div>
                                <div class="stat-label">Quotes Generated</div>
                            </div>
                            <div class="learning-stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-value" id="totalCorrectionsStat">0</div>
                                <div class="stat-label">Corrections Made</div>
                            </div>
                            <div class="learning-stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-value" id="categoriesLearnedStat">0</div>
                                <div class="stat-label">Categories Learned</div>
                            </div>
                            <div class="learning-stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-value" id="learningVelocityStat">-</div>
                                <div class="stat-label">Learning Speed</div>
                            </div>
                        </div>

                        <!-- Top Categories -->
                        <div class="top-categories-section">
                            <h4 class="subsection-title">Top Categories by Confidence</h4>
                            <div class="top-categories-list" id="topCategoriesList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Category Cards Dashboard -->
                    <div class="pricing-brain-section">
                        <h3 class="section-title">What I've Learned About Your Pricing</h3>
                        <p class="section-subtitle">Categories where you've corrected quotes or I've detected pricing patterns</p>
                        <div class="category-cards-grid" id="categoryCardsGrid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <!-- Empty state -->
                        <div class="empty-state" id="categoriesEmptyState" style="display: none;">
                            <div class="empty-icon"></div>
                            <h3>Your Pricing Brain is learning</h3>
                            <p>Generate a few quotes and the AI will start learning your pricing patterns.</p>
                            <p class="subtext">Every correction you make teaches the AI how YOU price jobs.</p>
                            <button class="cta-button" onclick="showAppSection('newQuote')">Generate a Quote to Start Learning</button>
                        </div>
                    </div>
                </div> <!-- End Pricing Brain Tab Content -->
            </div>
        </div>
    </main>

    <!-- Mobile Bottom Navigation -->
    <div class="mobile-nav" id="mobileNav" style="display: none;">
        <button class="mobile-nav-btn active" id="mobileNewQuoteBtn" onclick="showAppSection('newQuote')">
            <span class="mobile-nav-icon"></span>
            <span class="mobile-nav-label">New Quote</span>
        </button>
        <button class="mobile-nav-btn" id="mobileMyQuotesBtn" onclick="showAppSection('myQuotes')">
            <span class="mobile-nav-icon"></span>
            <span class="mobile-nav-label">My Quotes</span>
        </button>
        <button class="mobile-nav-btn" id="mobileAccountBtn" onclick="showAppSection('account')">
            <span class="mobile-nav-icon"></span>
            <span class="mobile-nav-label">Account</span>
        </button>
    </div>

    <!-- Upgrade Modal -->
    <div class="modal-overlay" id="upgradeModal" style="display: none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closeUpgradeModal()">&times;</button>
            <div class="modal-icon"></div>
            <h2 class="modal-title">Quote Limit Reached</h2>
            <p class="modal-subtitle">
                You've used all your quotes for this month. Upgrade to continue generating quotes and keep your business moving.
            </p>
            <div class="pricing-grid" id="modalPricingGrid">
                <!-- Will be populated same as main pricing grid -->
            </div>
            <p style="text-align: center; margin-top: 24px; font-size: 0.875rem; color: var(--text-secondary);">
                Need more? Contact us for enterprise pricing.
            </p>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal-overlay" id="editCategoryModal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeEditCategoryModal()">&times;</button>
            <h2 class="modal-title">Edit Category</h2>
            <p class="modal-subtitle" id="categoryModalSubtitle">
                Review and adjust pricing knowledge for this category
            </p>

            <form id="editCategoryForm" onsubmit="saveCategoryChanges(event)" style="margin-top: 24px;">
                <!-- Category Name -->
                <div class="form-group">
                    <label for="editCategoryName">Category Name</label>
                    <input type="text" id="editCategoryName" required style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem;">
                </div>

                <!-- Pattern-Based Hints (instant, no API cost) -->
                <div style="margin-top: 24px;">
                    <h4 style="font-family: var(--font-serif); font-size: 1.125rem; margin-bottom: 8px;">Pattern-Based Adjustments</h4>
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 16px;">What I've learned from your corrections</p>
                    <div id="patternHintsContainer" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 16px; min-height: 80px;">
                        <!-- Will show learned patterns from stored corrections -->
                    </div>
                </div>

                <!-- AI Analysis Section (on-demand, Haiku) -->
                <div style="margin-top: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <h4 style="font-family: var(--font-serif); font-size: 1.125rem; margin-bottom: 4px;">AI Analysis</h4>
                            <p style="font-size: 0.875rem; color: var(--text-secondary);">Get AI suggestions based on your patterns</p>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="runAIAnalysis()" id="analyzeBtn">
                            Analyze with AI
                        </button>
                    </div>
                    <div id="aiAnalysisContainer" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 16px; min-height: 80px; display: none;">
                        <!-- AI analysis results will appear here -->
                    </div>
                </div>

                <!-- Rate Modifiers -->
                <div class="form-group" style="margin-top: 24px;">
                    <label for="editRateModifier">Rate Modifier (%)</label>
                    <input type="number" id="editRateModifier" step="0.1" placeholder="0" style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem;">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Positive to increase, negative to decrease rates for this category</p>
                </div>

                <!-- Learned Rules (editable textarea) -->
                <div class="form-group" style="margin-top: 24px;">
                    <label for="editLearnedRules">Learned Rules (one per line)</label>
                    <textarea id="editLearnedRules" rows="4" placeholder="No rules yet" style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem; resize: vertical;"></textarea>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="confirmDeleteCategory()" style="flex: 1; background: var(--error); color: white;">Delete Category</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditCategoryModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveCategoryBtn" style="flex: 1;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Customer Modal -->
    <div class="modal-overlay" id="editCustomerModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeEditCustomerModal()">&times;</button>
            <h2 class="modal-title">Edit Customer Information</h2>
            <p class="modal-subtitle">
                Update customer details for this quote.
            </p>
            <form id="editCustomerForm" onsubmit="saveCustomerInfo(event)" style="margin-top: 24px;">
                <div class="form-group autocomplete-container">
                    <label for="editCustomerName">Customer Name</label>
                    <input type="text" id="editCustomerName" placeholder="John Smith" autocomplete="off" style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem;">
                    <div id="customerAutocomplete" class="autocomplete-dropdown" style="display: none;"></div>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label for="editCustomerAddress">Customer Address</label>
                    <input type="text" id="editCustomerAddress" placeholder="123 Main St, City, ST 12345" style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem;">
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label for="editCustomerPhone">Customer Phone</label>
                    <input type="tel" id="editCustomerPhone" placeholder="(555) 123-4567" style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem;">
                </div>
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditCustomerModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveCustomerBtn" style="flex: 1;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Global Settings Modal -->
    <div class="modal-overlay" id="editGlobalSettingsModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeEditGlobalSettingsModal()">&times;</button>
            <h2 class="modal-title">Edit Global Pricing Settings</h2>
            <p class="modal-subtitle">
                Update your base rates and pricing configuration
            </p>
            <form id="editGlobalSettingsForm" onsubmit="saveGlobalSettings(event)" style="margin-top: 24px;">
                <div class="form-group">
                    <label for="editLaborRate">Labor Rate ($/hr)</label>
                    <input type="number" id="editLaborRate" step="0.01" min="0" placeholder="85.00" style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem;">
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label for="editHelperRate">Helper Rate ($/hr)</label>
                    <input type="number" id="editHelperRate" step="0.01" min="0" placeholder="45.00" style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem;">
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label for="editMaterialMarkup">Material Markup (%)</label>
                    <input type="number" id="editMaterialMarkup" step="0.1" min="0" max="100" placeholder="20.0" style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem;">
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label for="editMinimumJob">Minimum Job ($)</label>
                    <input type="number" id="editMinimumJob" step="0.01" min="0" placeholder="500.00" style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem;">
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label for="editPricingNotes">Pricing Notes</label>
                    <textarea id="editPricingNotes" rows="3" placeholder="Additional pricing guidance or rules..." style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditGlobalSettingsModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveGlobalSettingsBtn" style="flex: 1;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Share Quote Modal -->
    <div class="modal-overlay" id="shareModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeShareModal()">&times;</button>
            <h2 class="modal-title">Share Quote</h2>
            <p class="modal-subtitle">Send this quote to your customer</p>

            <!-- Share Tabs -->
            <div class="account-tabs" style="margin: 24px 0 24px 0;">
                <button class="account-tab-btn active" id="shareEmailTabBtn" onclick="showShareTab('email')">Email</button>
                <button class="account-tab-btn" id="shareLinkTabBtn" onclick="showShareTab('link')">Copy Link</button>
            </div>

            <!-- Email Tab -->
            <div id="shareEmailTab" class="account-tab-content active">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="shareRecipientEmail">Customer Email</label>
                    <input type="email" id="shareRecipientEmail" placeholder="customer@example.com" style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem;">
                </div>
                <div class="form-group" style="margin-bottom: 24px;">
                    <label for="shareMessage">Message (optional)</label>
                    <textarea id="shareMessage" rows="4" placeholder="Add a personal message to your customer..." style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-sans); font-size: 1rem; resize: vertical;"></textarea>
                </div>
                <button class="btn btn-primary" onclick="sendShareEmail()" id="sendShareEmailBtn" style="width: 100%;">Send Email</button>
            </div>

            <!-- Copy Link Tab -->
            <div id="shareLinkTab" class="account-tab-content">
                <p style="margin-bottom: 16px; color: var(--text-secondary); font-size: 0.9375rem;">Share this link with your customer to view the quote online</p>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <input type="text" id="shareUrl" readonly style="background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; flex: 1; font-family: var(--font-mono); font-size: 0.875rem;">
                    <button class="btn btn-primary" onclick="copyShareLink()" id="copyLinkBtn">Copy</button>
                </div>
                <div id="copySuccessMessage" style="display: none; color: var(--success); font-size: 0.875rem; text-align: center; margin-top: 8px;">
                     Link copied to clipboard!
                </div>
            </div>

            <!-- Referral Banner -->
            <div style="background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(124, 58, 237, 0.03)); border: 1px solid rgba(124, 58, 237, 0.2); border-radius: 8px; padding: 12px 16px; margin-top: 24px; display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                <div style="flex: 1;">
                    <div style="font-size: 0.875rem; color: var(--text-primary); margin-bottom: 2px;">
                        Know another contractor?
                    </div>
                    <div style="font-size: 0.8125rem; color: var(--text-secondary);">
                        Share your code: <span id="shareModalReferralCode" style="font-family: var(--font-mono); color: var(--text-primary); font-weight: 600;">Loading...</span>
                    </div>
                </div>
                <button onclick="copyShareModalReferralCode()" id="copyShareModalCodeBtn" style="background: var(--accent); color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 0.8125rem; font-weight: 500; transition: all 0.2s ease; white-space: nowrap;">
                    Copy
                </button>
            </div>
        </div>
    </div>

    <!-- Issue Reporter FAB -->
    <button class="issue-fab" onclick="openIssueModal()" title="Report an issue">?</button>

    <!-- Issue Reporter Modal -->
    <div class="issue-modal" id="issueModal">
        <div class="issue-modal-content">
            <div id="issueFormView">
                <h3>
                    Report an Issue
                    <button class="close-btn" onclick="closeIssueModal()">&times;</button>
                </h3>
                <form class="issue-form" onsubmit="submitIssue(event)">
                    <div class="form-group">
                        <label>What's the problem?</label>
                        <input type="text" id="issueTitle" placeholder="Brief description" required>
                    </div>

                    <div class="form-group">
                        <label>Tell us more</label>
                        <textarea id="issueDescription" placeholder="What happened? What did you expect?" required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Category</label>
                            <select id="issueCategory">
                                <option value="bug">Bug</option>
                                <option value="ui_issue">Display Issue</option>
                                <option value="pricing_issue">Pricing Issue</option>
                                <option value="feature_request">Feature Request</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Severity</label>
                            <select id="issueSeverity">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Steps to reproduce (optional)</label>
                        <textarea id="issueSteps" placeholder="1. Go to...&#10;2. Click on...&#10;3. See error"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">Submit</button>
                </form>
            </div>

            <div id="issueSuccessView" class="issue-success" style="display: none;">
                <div class="checkmark"></div>
                <h3>Thanks for reporting!</h3>
                <p>
                    We'll look into this.<br>
                    Issue ID: <strong id="submittedIssueId"></strong>
                </p>
                <button class="btn btn-secondary" onclick="closeIssueModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- First Quote Celebration Modal -->
    <div class="modal-overlay celebration-modal" id="celebrationModal" style="display: none;">
        <div class="modal-content celebration-content">
            <button class="modal-close" onclick="closeCelebrationModal()">&times;</button>
            <div class="celebration-confetti" id="confetti"></div>

            <!-- Celebration Header -->
            <div class="celebration-icon"></div>
            <h2 class="modal-title">You created your first quote!</h2>

            <!-- Social Proof Badge -->
            <div class="celebration-social-proof">
                <span></span>
                <span id="celebrationSocialProof">You're in the first 100 beta testers!</span>
            </div>

            <p class="modal-subtitle">
                You just saved yourself hours of manual work. The more you use Quoted, the smarter it gets.
            </p>

            <!-- Progress Indicator -->
            <div class="celebration-progress">
                <div class="celebration-progress-icon"></div>
                <div class="celebration-progress-text">
                    <div class="celebration-progress-label">Your AI is Learning</div>
                    <div class="celebration-progress-value">Building your pricing intelligence</div>
                </div>
            </div>

            <!-- Primary CTA: Share Quote -->
            <button class="btn btn-primary celebration-primary-cta" onclick="shareFirstQuote()">
                 Share Your First Quote
            </button>

            <!-- Referral Section (Secondary) -->
            <div class="celebration-referral-section" style="background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(124, 58, 237, 0.05)); border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 12px; padding: 20px; margin: 16px 0;">
                <h3 style="margin: 0 0 8px 0; font-size: 1rem; color: var(--text-primary); font-family: var(--font-serif);">
                     Invite Friends, Earn Free Months
                </h3>
                <p style="color: var(--text-secondary); margin: 0 0 16px 0; font-size: 0.875rem;">
                    You get <strong style="color: var(--text-primary);">1 free month</strong>, they get <strong style="color: var(--text-primary);">14 extra days</strong>
                </p>

                <!-- Referral Code Display -->
                <div style="background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                    <div style="flex: 1;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em;">Your Referral Code</div>
                        <div id="celebrationReferralCode" style="font-family: var(--font-mono); font-size: 1.125rem; color: var(--text-primary); font-weight: 600;">Loading...</div>
                    </div>
                    <button onclick="copyCelebrationReferralCode()" id="copyCelebrationCodeBtn" style="background: var(--accent); color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s ease; white-space: nowrap;">
                        Copy Code
                    </button>
                </div>

                <!-- Share Buttons -->
                <div style="display: flex; gap: 8px;">
                    <button onclick="shareCelebrationReferralLink()" style="flex: 1; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; padding: 10px; cursor: pointer; font-size: 0.875rem; color: var(--text-primary); font-family: var(--font-sans); transition: all 0.2s ease;">
                         Share Link
                    </button>
                    <button onclick="copyCelebrationReferralLink()" style="flex: 1; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; padding: 10px; cursor: pointer; font-size: 0.875rem; color: var(--text-primary); font-family: var(--font-sans); transition: all 0.2s ease;">
                         Copy Link
                    </button>
                </div>
            </div>

            <!-- Tertiary Actions -->
            <div class="celebration-actions">
                <button class="btn btn-secondary" onclick="viewQuoteDetails()">View Quote</button>
                <button class="btn btn-secondary" onclick="closeCelebrationAndCreate()">Create Another</button>
            </div>
        </div>
    </div>

    <!-- First Quote Activation Modal -->
    <div id="first-quote-modal" class="modal-overlay" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content first-quote-modal-content">
            <div class="first-quote-icon"></div>
            <h2>You're all set up!</h2>
            <p class="first-quote-subtitle">Your pricing profile is ready. Let's generate your first quote.</p>

            <div class="first-quote-options">
                <button class="first-quote-option" onclick="startFirstQuote('voice')">
                    <span class="option-icon"></span>
                    <span class="option-text">
                        <strong>Record a job description</strong>
                        <small>Speak naturally, like you're explaining it to a colleague</small>
                    </span>
                </button>

                <button class="first-quote-option" onclick="startFirstQuote('text')">
                    <span class="option-icon"></span>
                    <span class="option-text">
                        <strong>Type an example</strong>
                        <small>We'll pre-fill a sample job for you to try</small>
                    </span>
                </button>
            </div>

            <button class="first-quote-skip" onclick="closeFirstQuoteModal()">
                I'll explore on my own
            </button>
        </div>
    </div>

    <!-- Testimonial Collection Modal (DISC-010) -->
    <div id="testimonialModal" class="modal-overlay" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeTestimonialModal()">&times;</button>

            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                <h2 class="modal-title" style="margin-bottom: 8px;">How's Quoted working for you?</h2>
                <p class="modal-subtitle">You've generated a few quotes. We'd love your feedback!</p>
            </div>

            <!-- Star Rating -->
            <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 12px; font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Your Rating</label>
                <div id="starRating" style="display: flex; gap: 12px; justify-content: center; font-size: 2rem;">
                    <span class="star" data-rating="1" onclick="setTestimonialRating(1)"></span>
                    <span class="star" data-rating="2" onclick="setTestimonialRating(2)"></span>
                    <span class="star" data-rating="3" onclick="setTestimonialRating(3)"></span>
                    <span class="star" data-rating="4" onclick="setTestimonialRating(4)"></span>
                    <span class="star" data-rating="5" onclick="setTestimonialRating(5)"></span>
                </div>
            </div>

            <!-- Testimonial Text -->
            <div style="margin-bottom: 24px;">
                <label for="testimonialText" style="display: block; margin-bottom: 8px; font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">What would you tell a fellow contractor about Quoted?</label>
                <textarea
                    id="testimonialText"
                    placeholder="1-2 sentences about your experience..."
                    style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: var(--font-sans); font-size: 0.9375rem; resize: vertical;"
                    maxlength="500"
                ></textarea>
                <div style="text-align: right; font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                    <span id="testimonialCharCount">0</span>/500
                </div>
            </div>

            <!-- Optional Attribution -->
            <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 12px; font-size: 0.875rem; color: var(--text-secondary);">
                    <input type="checkbox" id="includeAttribution" onchange="toggleAttribution()" style="margin-right: 8px;">
                    Include my name and company (optional)
                </label>
                <div id="attributionFields" style="display: none; margin-top: 12px; padding: 16px; background: var(--bg-elevated); border-radius: 8px; border: 1px solid var(--border);">
                    <input
                        type="text"
                        id="testimonialName"
                        placeholder="Your name"
                        style="width: 100%; padding: 10px; margin-bottom: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: var(--font-sans);"
                    >
                    <input
                        type="text"
                        id="testimonialCompany"
                        placeholder="Company name"
                        style="width: 100%; padding: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: var(--font-sans);"
                    >
                </div>
            </div>

            <!-- Submit Button -->
            <button
                id="submitTestimonialBtn"
                class="btn btn-primary"
                onclick="submitTestimonial()"
                style="width: 100%; margin-bottom: 12px;"
                disabled
            >
                Submit Feedback
            </button>

            <button
                class="btn btn-secondary"
                onclick="closeTestimonialModal()"
                style="width: 100%;"
            >
                Maybe Later
            </button>
        </div>
    </div>

    <!-- Draft Recovery Modal (DISC-032) -->
    <div id="draftRecoveryModal" class="modal-overlay" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeDraftRecoveryModal()">&times;</button>

            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                <h2 class="modal-title" style="margin-bottom: 8px;">Unsaved Quote Found</h2>
                <p class="modal-subtitle">
                    You have an unsaved quote from <strong id="draftTimeAgo"></strong>
                </p>
            </div>

            <!-- Draft Preview -->
            <div style="margin-bottom: 24px;">
                <div style="background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Draft Preview</label>
                    <p id="draftPreview" style="color: var(--text-secondary); font-size: 0.9375rem; margin: 0; line-height: 1.5; font-style: italic;"></p>
                </div>
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 12px; flex-direction: column;">
                <button
                    class="btn btn-primary"
                    onclick="restoreDraft()"
                    style="width: 100%;"
                >
                    Restore Draft
                </button>
                <button
                    class="btn btn-secondary"
                    onclick="discardDraft()"
                    style="width: 100%;"
                >
                    Discard & Start Fresh
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:8000/api'
            : window.location.origin + '/api';

        // State
        let authToken = localStorage.getItem('quoted_token');
        let currentUser = JSON.parse(localStorage.getItem('quoted_user') || 'null');
        let currentQuoteId = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let lastInputMethod = null; // Track whether last quote was voice or text
        let autosaveInterval = null; // Autosave interval timer

        // ========== DRAFT AUTOSAVE (DISC-032) ==========

        const AUTOSAVE_KEY = 'quoted_draft';
        const AUTOSAVE_INTERVAL_MS = 10000; // 10 seconds

        // Save current quote state to localStorage
        function saveDraft() {
            try {
                const jobDescription = document.getElementById('jobDescription').value.trim();
                const transcriptionText = document.getElementById('transcriptionText').value.trim();

                // Only save if there's actual content
                if (!jobDescription && !transcriptionText) {
                    return;
                }

                const draft = {
                    timestamp: Date.now(),
                    transcription: transcriptionText,
                    jobDescription: jobDescription,
                    currentQuoteId: currentQuoteId,
                };

                // If we have a generated quote, save its data
                if (currentQuoteId) {
                    const quoteResult = document.getElementById('quoteResult');
                    if (quoteResult.classList.contains('active')) {
                        draft.quoteData = {
                            id: currentQuoteId,
                            jobDescription: document.getElementById('jobDescriptionDisplay').textContent,
                            confidence: document.getElementById('confidenceBadge').textContent,
                            notes: document.getElementById('notesContent').textContent,
                            total: document.getElementById('totalAmount').textContent,
                        };
                    }
                }

                localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(draft));

                // Track autosave
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('draft_autosaved', {
                        has_quote_data: !!draft.quoteData,
                        has_transcription: !!draft.transcription,
                        has_job_description: !!draft.jobDescription,
                    });
                }
                {% endif %}
            } catch (err) {
                console.error('Failed to save draft:', err);
            }
        }

        // Load draft from localStorage
        function loadDraft() {
            try {
                const draftJson = localStorage.getItem(AUTOSAVE_KEY);
                if (!draftJson) return null;

                const draft = JSON.parse(draftJson);

                // Check if draft is not too old (24 hours)
                const age = Date.now() - draft.timestamp;
                const MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours

                if (age > MAX_AGE) {
                    clearDraft();
                    return null;
                }

                return draft;
            } catch (err) {
                console.error('Failed to load draft:', err);
                return null;
            }
        }

        // Clear saved draft
        function clearDraft() {
            localStorage.removeItem(AUTOSAVE_KEY);
        }

        // Start autosave interval
        function startAutosave() {
            if (autosaveInterval) return; // Already running

            autosaveInterval = setInterval(() => {
                saveDraft();
            }, AUTOSAVE_INTERVAL_MS);
        }

        // Stop autosave interval
        function stopAutosave() {
            if (autosaveInterval) {
                clearInterval(autosaveInterval);
                autosaveInterval = null;
            }
        }

        // Show draft recovery modal
        function showDraftRecoveryModal(draft) {
            const age = Date.now() - draft.timestamp;
            const minutes = Math.floor(age / 60000);
            const hours = Math.floor(minutes / 60);

            let timeAgo;
            if (hours > 0) {
                timeAgo = `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else {
                timeAgo = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            }

            document.getElementById('draftTimeAgo').textContent = timeAgo;

            // Preview content
            const preview = draft.transcription || draft.jobDescription || '';
            const previewText = preview.length > 100 ? preview.substring(0, 100) + '...' : preview;
            document.getElementById('draftPreview').textContent = previewText;

            document.getElementById('draftRecoveryModal').style.display = 'flex';

            // Track recovery modal shown
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('draft_recovery_shown', {
                    age_minutes: minutes,
                    has_quote_data: !!draft.quoteData,
                });
            }
            {% endif %}
        }

        // Restore draft
        function restoreDraft() {
            const draft = loadDraft();
            if (!draft) {
                closeDraftRecoveryModal();
                return;
            }

            // Restore transcription and job description
            if (draft.transcription) {
                document.getElementById('transcriptionText').value = draft.transcription;
            }
            if (draft.jobDescription) {
                document.getElementById('jobDescription').value = draft.jobDescription;
            }

            // Close modal
            closeDraftRecoveryModal();

            // Track recovery
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('draft_recovered', {
                    had_quote_data: !!draft.quoteData,
                });
            }
            {% endif %}

            // Show success message
            showToast('Draft restored successfully', 'success');
        }

        // Discard draft
        function discardDraft() {
            clearDraft();
            closeDraftRecoveryModal();

            // Track discard
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('draft_discarded');
            }
            {% endif %}
        }

        // Close draft recovery modal
        function closeDraftRecoveryModal() {
            document.getElementById('draftRecoveryModal').style.display = 'none';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check voice support
            checkVoiceSupport();

            // Check for referral code in URL
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                localStorage.setItem('referral_code', refCode);
            }

            if (authToken && currentUser) {
                showAppView();

                // Check for saved draft (DISC-032)
                const draft = loadDraft();
                if (draft) {
                    // Show recovery modal after a brief delay to let UI settle
                    setTimeout(() => {
                        showDraftRecoveryModal(draft);
                    }, 500);
                }
            } else {
                showAuthView();
            }
        });

        // DISC-036: Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            // Ignore if user is typing in input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                // Allow Cmd/Ctrl+Enter in textarea for generate
                if (e.target.id === 'jobDescription' && (e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    e.preventDefault();
                    const generateBtn = document.getElementById('generateBtn');
                    if (generateBtn && !generateBtn.disabled) {
                        generateBtn.click();
                    }
                }
                return;
            }

            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const modifier = isMac ? e.metaKey : e.ctrlKey;

            // Cmd/Ctrl + N: New Quote
            if (modifier && e.key === 'n') {
                e.preventDefault();
                if (currentView === 'quotes' || currentView === 'quoteDetail') {
                    switchToView('app');
                    clearQuoteForm();
                }
            }

            // Cmd/Ctrl + E: Edit current quote (if in detail view)
            else if (modifier && e.key === 'e') {
                e.preventDefault();
                if (currentView === 'quoteDetail' && currentQuoteId) {
                    toggleEditMode();
                }
            }

            // Cmd/Ctrl + D: Download PDF (if quote is visible)
            else if (modifier && e.key === 'd') {
                e.preventDefault();
                if (currentView === 'quoteDetail' && currentQuoteId) {
                    const pdfBtn = document.querySelector('#quoteDetailView .btn-secondary');
                    if (pdfBtn) pdfBtn.click();
                } else if (document.getElementById('quoteResult').classList.contains('active')) {
                    const pdfBtn = document.getElementById('downloadPdfBtn');
                    if (pdfBtn) pdfBtn.click();
                }
            }

            // Cmd/Ctrl + S: Save (if in edit mode)
            else if (modifier && e.key === 's') {
                e.preventDefault();
                if (isEditMode && currentView === 'quoteDetail') {
                    saveQuoteChanges();
                }
            }

            // Cmd/Ctrl + ?: Show keyboard shortcuts help
            else if (modifier && (e.key === '?' || e.key === '/')) {
                e.preventDefault();
                showKeyboardShortcutsModal();
            }
        });

        function showKeyboardShortcutsModal() {
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const modKey = isMac ? '' : 'Ctrl';

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);z-index:1000;display:flex;align-items:center;justify-content:center;';

            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.cssText = 'max-width:500px;width:90%;background:var(--bg-card);border-radius:16px;padding:32px;border:1px solid var(--border);';

            const title = document.createElement('h2');
            title.style.cssText = 'font-family:var(--font-serif);font-size:1.75rem;margin-bottom:24px;';
            title.textContent = 'Keyboard Shortcuts';
            modalContent.appendChild(title);

            const shortcutsGrid = document.createElement('div');
            shortcutsGrid.style.cssText = 'display:grid;gap:16px;';

            const shortcuts = [
                { label: 'New Quote', key: modKey + '+N' },
                { label: 'Edit Quote', key: modKey + '+E' },
                { label: 'Download PDF', key: modKey + '+D' },
                { label: 'Save Changes', key: modKey + '+S' },
                { label: 'Generate Quote', key: modKey + '+Enter' },
                { label: 'Show Shortcuts', key: modKey + '+?' }
            ];

            shortcuts.forEach(shortcut => {
                const row = document.createElement('div');
                row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-elevated);border-radius:8px;';

                const label = document.createElement('span');
                label.textContent = shortcut.label;
                row.appendChild(label);

                const kbd = document.createElement('kbd');
                kbd.style.cssText = 'background:var(--bg-secondary);padding:4px 12px;border-radius:4px;font-family:monospace;font-size:0.875rem;border:1px solid var(--border);';
                kbd.textContent = shortcut.key;
                row.appendChild(kbd);

                shortcutsGrid.appendChild(row);
            });

            modalContent.appendChild(shortcutsGrid);

            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn btn-primary';
            closeBtn.style.cssText = 'width:100%;margin-top:24px;';
            closeBtn.textContent = 'Got it';
            closeBtn.onclick = () => modal.remove();
            modalContent.appendChild(closeBtn);

            modal.appendChild(modalContent);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            document.body.appendChild(modal);

            // Track shortcut help view
            if (window.posthog) {
                posthog.capture('keyboard_shortcuts_viewed');
            }
        }

        // Auth tab switching
        function showAuthTab(tab) {
            document.getElementById('loginTab').classList.toggle('active', tab === 'login');
            document.getElementById('registerTab').classList.toggle('active', tab === 'register');
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
            hideAuthMessage();
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');

            btn.disabled = true;
            btn.textContent = 'Signing in...';

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Login failed');
                }

                authToken = data.access_token;
                localStorage.setItem('quoted_token', authToken);

                await fetchUserInfo();
                showAppView();

            } catch (err) {
                showAuthMessage(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        }

        // Handle registration
        async function handleRegister(e) {
            e.preventDefault();
            const btn = document.getElementById('registerBtn');

            // Include referral code if present
            const referralCode = localStorage.getItem('referral_code');

            const data = {
                email: document.getElementById('registerEmail').value,
                password: document.getElementById('registerPassword').value,
                business_name: document.getElementById('registerBusiness').value,
                owner_name: document.getElementById('registerName').value || null,
                phone: document.getElementById('registerPhone').value || null,
                referral_code: referralCode || null,
            };

            btn.disabled = true;
            btn.textContent = 'Creating account...';

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Registration failed');
                }

                authToken = result.access_token;
                localStorage.setItem('quoted_token', authToken);

                await fetchUserInfo();
                showAppView();

            } catch (err) {
                showAuthMessage(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        }

        // Fetch user info
        async function fetchUserInfo() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` },
                });

                if (response.ok) {
                    currentUser = await response.json();
                    localStorage.setItem('quoted_user', JSON.stringify(currentUser));
                } else {
                    console.error('fetchUserInfo failed:', response.status);
                    // Clear invalid auth state
                    if (response.status === 401) {
                        logout();
                    }
                    throw new Error('Failed to fetch user info');
                }
            } catch (err) {
                console.error('fetchUserInfo error:', err);
                throw err;
            }
        }

        // Logout
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('quoted_token');
            localStorage.removeItem('quoted_user');
            showAuthView();
        }

        // View switching
        function showAuthView() {
            document.getElementById('authView').classList.add('active');
            document.getElementById('appView').classList.remove('active');
            document.getElementById('navRight').style.display = 'none';
            document.getElementById('mobileNav').classList.remove('active');
        }

        async function showAppView() {
            document.getElementById('authView').classList.remove('active');
            document.getElementById('appView').classList.add('active');
            document.getElementById('navRight').style.display = 'flex';
            document.getElementById('appNav').style.display = 'flex';
            document.getElementById('mobileNav').classList.add('active');

            // Reset nav buttons to default (New Quote active)
            document.getElementById('newQuoteNavBtn').classList.add('active');
            document.getElementById('myQuotesNavBtn').classList.remove('active');
            document.getElementById('mobileNewQuoteBtn').classList.add('active');
            document.getElementById('mobileMyQuotesBtn').classList.remove('active');
            document.getElementById('mobileAccountBtn').classList.remove('active');

            // Hide detail views
            document.getElementById('myQuotesSection').style.display = 'none';
            document.getElementById('quoteDetailView').style.display = 'none';

            // Ensure we have user info
            if (!currentUser) {
                try {
                    await fetchUserInfo();
                } catch (err) {
                    console.error('Failed to fetch user info:', err);
                    showAuthView();
                    return;
                }
            }

            if (currentUser) {
                document.getElementById('businessNameDisplay').textContent = currentUser.business_name || currentUser.email;
            }

            // Check pricing model
            try {
                if (!currentUser?.contractor_id) {
                    throw new Error('No contractor ID');
                }

                const response = await fetch(`${API_BASE}/contractors/${currentUser.contractor_id}/pricing`, {
                    headers: { 'Authorization': `Bearer ${authToken}` },
                });

                if (response.ok) {
                    const pricing = await response.json();
                    const hasPricing = pricing && pricing.pricing_knowledge && Object.keys(pricing.pricing_knowledge).length > 0;

                    if (!hasPricing) {
                        document.getElementById('onboardingNotice').style.display = 'block';
                        document.getElementById('inputSection').style.display = 'none';

                        // Show industry selection if no trade selected yet
                        if (!currentUser.primary_trade || currentUser.primary_trade === 'general') {
                            showIndustrySelection();
                        }
                    } else {
                        document.getElementById('onboardingNotice').style.display = 'none';
                        document.getElementById('inputSection').style.display = 'block';
                    }
                } else {
                    document.getElementById('onboardingNotice').style.display = 'block';
                    document.getElementById('inputSection').style.display = 'none';

                    // Show industry selection if no trade selected yet
                    if (!currentUser.primary_trade || currentUser.primary_trade === 'general') {
                        showIndustrySelection();
                    }
                }
            } catch (err) {
                console.error('Error checking pricing model:', err);
                document.getElementById('onboardingNotice').style.display = 'block';
                document.getElementById('inputSection').style.display = 'none';

                // Show industry selection if no trade selected yet
                if (!currentUser.primary_trade || currentUser.primary_trade === 'general') {
                    showIndustrySelection();
                }
            }

            // Check if we should show first quote activation modal
            checkFirstQuoteActivation();
        }

        // Auth message
        function showAuthMessage(message, type) {
            const el = document.getElementById('authMessage');
            el.textContent = message;
            el.className = 'message active ' + type;
        }

        function hideAuthMessage() {
            document.getElementById('authMessage').classList.remove('active');
        }

        // Voice support detection and fallback handling
        let voiceSilenceTimeout = null;
        let hasRecordedAudio = false;

        // Check voice support on page load
        function checkVoiceSupport() {
            const hasMediaDevices = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            const hasMediaRecorder = typeof MediaRecorder !== 'undefined';
            const isSupported = hasMediaDevices && hasMediaRecorder;

            const badge = document.getElementById('browserBadge');
            const badgeText = document.getElementById('browserBadgeText');
            const warning = document.getElementById('voiceWarning');

            if (!isSupported) {
                // Voice not supported - show warning
                warning.classList.add('active');
                badge.style.display = 'inline-flex';
                badge.classList.add('limited');
                badgeText.textContent = 'Text Only';

                // Track unsupported browser
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('voice_api_unsupported', {
                        has_media_devices: hasMediaDevices,
                        has_media_recorder: hasMediaRecorder,
                        user_agent: navigator.userAgent
                    });
                }
                {% endif %}

                return false;
            } else {
                // Voice supported
                badge.style.display = 'inline-flex';
                badge.classList.add('compatible');
                badgeText.textContent = 'Voice Ready';
                return true;
            }
        }

        // Show fallback link (subtle or prominent)
        function showVoiceFallback(prominent = false) {
            const fallbackLink = document.getElementById('voiceFallbackLink');
            fallbackLink.classList.add('active');

            if (prominent) {
                fallbackLink.classList.add('prominent');
                fallbackLink.textContent = ' Voice issue detected. Switch to text ';
            }

            // Track fallback shown
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('voice_fallback_shown', {
                    prominent: prominent,
                    has_recorded_audio: hasRecordedAudio
                });
            }
            {% endif %}
        }

        // Switch to text input
        function switchToTextInput() {
            const textarea = document.getElementById('jobDescription');
            textarea.focus();
            textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Track fallback used
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('voice_fallback_used');
            }
            {% endif %}
        }

        // Start silence detection during recording
        function startSilenceDetection() {
            // Clear any existing timeout
            if (voiceSilenceTimeout) {
                clearTimeout(voiceSilenceTimeout);
            }

            // After 10 seconds of recording without stopping, show fallback
            voiceSilenceTimeout = setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    showVoiceFallback(false);
                }
            }, 10000);
        }

        // Stop silence detection
        function stopSilenceDetection() {
            if (voiceSilenceTimeout) {
                clearTimeout(voiceSilenceTimeout);
                voiceSilenceTimeout = null;
            }
        }

        // Get supported audio MIME type for recording (iOS Safari compatibility)
        function getSupportedAudioMimeType() {
            const types = [
                'audio/webm',
                'audio/webm;codecs=opus',
                'audio/mp4',
                'audio/mp4;codecs=mp4a.40.2',
                'audio/ogg;codecs=opus'
            ];

            for (const type of types) {
                if (MediaRecorder.isTypeSupported(type)) {
                    return type;
                }
            }

            // Fallback - let browser choose
            return '';
        }

        // Recording
        async function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            const btnText = document.getElementById('recordBtnText');
            const instructions = document.getElementById('recordInstructions');

            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                btn.classList.remove('recording');
                btnText.textContent = 'Record';
                instructions.textContent = 'Processing...';
                stopSilenceDetection();
                hasRecordedAudio = true;
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const mimeType = getSupportedAudioMimeType();
                    const options = mimeType ? { mimeType } : {};
                    mediaRecorder = new MediaRecorder(stream, options);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (e) => {
                        audioChunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: mimeType || 'audio/webm' });
                        await sendAudioForTranscription(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                        stopSilenceDetection();
                    };

                    // Handle MediaRecorder errors
                    mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorder error:', event);
                        showVoiceFallback(true);

                        // Track error
                        {% if posthog_api_key %}
                        if (window.posthog) {
                            posthog.capture('voice_error', {
                                error_type: 'mediarecorder_error',
                                error_name: event.error?.name || 'unknown'
                            });
                        }
                        {% endif %}
                    };

                    mediaRecorder.start();
                    btn.classList.add('recording');
                    btnText.textContent = 'Stop';
                    instructions.textContent = 'Recording... Click again when done';

                    // Start silence detection
                    startSilenceDetection();

                    // Track voice input method
                    lastInputMethod = 'voice';
                    {% if posthog_api_key %}
                    if (window.posthog) {
                        posthog.capture('quote_input_method', {
                            method: 'voice'
                        });
                    }
                    {% endif %}
                } catch (err) {
                    console.error('Microphone error:', err);
                    showError('Could not access microphone. Please allow access and try again.');
                    showVoiceFallback(true);

                    // Track error
                    {% if posthog_api_key %}
                    if (window.posthog) {
                        posthog.capture('voice_error', {
                            error_type: 'microphone_access',
                            error_name: err.name || 'unknown',
                            error_message: err.message
                        });
                    }
                    {% endif %}
                }
            }
        }

        // Send audio for transcription only (step 1 of voice flow)
        async function sendAudioForTranscription(audioBlob) {
            showLoading(true, 'Transcribing...');

            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                const response = await fetch(`${API_BASE}/quotes/transcribe`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData,
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to transcribe audio');
                }

                const result = await response.json();
                showTranscriptionPreview(result.text);

                // Track transcription complete
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('transcription_complete', {
                        duration: result.duration,
                        text_length: result.text?.length || 0
                    });
                }
                {% endif %}
            } catch (err) {
                console.error('Error:', err);
                showError(err.message);
                // Only reset to input section on error
                document.getElementById('loadingSection').classList.remove('active');
                document.getElementById('inputSection').style.display = 'block';
            }
            // Always reset instructions
            document.getElementById('recordInstructions').textContent = 'Click to start recording your voice note';
        }

        // Show transcription preview for review/edit
        function showTranscriptionPreview(text) {
            document.getElementById('loadingSection').classList.remove('active');
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('transcriptionPreview').style.display = 'block';
            document.getElementById('transcriptionText').value = text;
            document.getElementById('transcriptionText').focus();
        }

        // Re-record: go back to input section
        function reRecord() {
            document.getElementById('transcriptionPreview').style.display = 'none';
            document.getElementById('inputSection').style.display = 'block';
            document.getElementById('transcriptionText').value = '';

            // Track re-record
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('transcription_rerecord');
            }
            {% endif %}
        }

        // Generate quote from reviewed/edited transcription
        async function generateFromTranscription() {
            const transcription = document.getElementById('transcriptionText').value.trim();

            if (!transcription) {
                showError('Please enter or record a job description');
                return;
            }

            // Hide preview, populate the main textarea, and generate
            document.getElementById('transcriptionPreview').style.display = 'none';
            document.getElementById('jobDescription').value = transcription;

            // Use existing generateQuote function
            await generateQuote();
        }

        // Generate quote from text
        async function generateQuote() {
            const transcription = document.getElementById('jobDescription').value.trim();

            if (!transcription) {
                showError('Please enter a job description');
                return;
            }

            // Track text input method
            lastInputMethod = 'text';
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('quote_input_method', {
                    method: 'text'
                });
            }
            {% endif %}

            // Check if this is first quote attempt
            const isFirstQuoteAttempt = currentBillingStatus?.quotes_used === 0;

            // Track first quote attempt
            {% if posthog_api_key %}
            if (window.posthog && isFirstQuoteAttempt) {
                posthog.capture('first_quote_attempt');
            }
            {% endif %}

            showLoading(true);

            try {
                const response = await fetch(`${API_BASE}/quotes/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({
                        transcription: transcription,
                        contractor_id: currentUser?.contractor_id || 'default',
                    }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate quote');
                }

                const quote = await response.json();
                displayQuote(quote);

                // Track quote generation
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('quote_generated', {
                        quote_id: quote.id,
                        total: quote.total,
                        input_method: lastInputMethod || 'text'
                    });

                    // Track first quote milestone
                    if (isFirstQuoteAttempt) {
                        posthog.capture('first_quote_generated', {
                            quote_id: quote.id,
                            total: quote.total,
                            input_method: lastInputMethod || 'text',
                            onboarding_path: currentUser?.onboarding_path || 'unknown'
                        });

                        // Track if this is from try-first path (DISC-019)
                        if (currentUser?.onboarding_path === 'try_first') {
                            posthog.capture('try_first_quote_generated', {
                                quote_id: quote.id,
                                total: quote.total,
                                input_method: lastInputMethod || 'text'
                            });
                        }
                    }
                }
                {% endif %}
            } catch (err) {
                console.error('Error:', err);
                showError(err.message);
            } finally {
                showLoading(false);
            }
        }

        // Create line item element
        function createLineItemElement(item) {
            const itemEl = document.createElement('div');
            itemEl.className = 'line-item';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'line-item-info';

            const nameDiv = document.createElement('div');
            nameDiv.className = 'line-item-name';
            nameDiv.textContent = item.name || '';

            const descDiv = document.createElement('div');
            descDiv.className = 'line-item-desc';
            descDiv.textContent = item.description || '';

            infoDiv.appendChild(nameDiv);
            infoDiv.appendChild(descDiv);

            const amountDiv = document.createElement('div');
            amountDiv.className = 'line-item-amount';
            amountDiv.textContent = '$' + (item.amount || 0).toLocaleString();

            itemEl.appendChild(infoDiv);
            itemEl.appendChild(amountDiv);

            return itemEl;
        }

        // Display quote
        function displayQuote(quote) {
            currentQuoteId = quote.id;

            document.getElementById('jobDescriptionDisplay').textContent =
                quote.job_description || 'No description provided';

            // DISC-035: Fetch confidence indicator for this job type
            updateConfidenceBadge(quote.job_type, 'confidenceBadge');

            const lineItemsContainer = document.getElementById('lineItems');
            lineItemsContainer.textContent = '';

            if (quote.line_items && quote.line_items.length > 0) {
                quote.line_items.forEach(item => {
                    const itemEl = createLineItemElement(item);
                    lineItemsContainer.appendChild(itemEl);
                });
            }

            document.getElementById('totalAmount').textContent =
                '$' + (quote.subtotal || 0).toLocaleString();

            if (quote.notes) {
                document.getElementById('notesContent').textContent = quote.notes;
                document.getElementById('quoteNotes').style.display = 'block';
            } else {
                document.getElementById('quoteNotes').style.display = 'none';
            }

            if (quote.transcription) {
                document.getElementById('transcriptionDisplay').textContent = quote.transcription;
                document.getElementById('transcriptionDisplay').style.display = 'block';
            } else {
                document.getElementById('transcriptionDisplay').style.display = 'none';
            }

            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('quoteResult').classList.add('active');
            hideError();

            // Scroll to quote result, accounting for fixed nav
            setTimeout(() => {
                const quoteResult = document.getElementById('quoteResult');
                if (quoteResult) {
                    quoteResult.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);

            // DISC-018: Show grace quote modal if this was a grace quote
            if (quote.billing_info?.is_grace_quote) {
                showGraceQuoteModal(quote.billing_info.grace_remaining);
            }

            // DISC-018: Update warning banner based on billing info
            if (quote.billing_info) {
                updateTrialWarning(quote.billing_info);

                // Only mark celebration pending for first quote (quotes_used == 1)
                if (quote.billing_info.quotes_used === 1) {
                    markCelebrationPending();
                }
            }
        }

        // DISC-035: Update confidence badge
        async function updateConfidenceBadge(jobType, badgeElementId) {
            const badge = document.getElementById(badgeElementId);
            if (!badge || !jobType) {
                // No badge element or no job type, hide badge
                if (badge) badge.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/pricing-brain/${encodeURIComponent(jobType)}/confidence`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch confidence');
                }

                const confidenceInfo = await response.json();

                // Update badge text and class
                badge.textContent = confidenceInfo.confidence_label;
                badge.className = 'confidence-badge confidence-' + confidenceInfo.confidence_level;
                badge.style.display = 'inline-block';
                badge.title = confidenceInfo.description;  // Tooltip for more detail
            } catch (err) {
                console.error('Failed to update confidence badge:', err);
                // Fallback: show generic "Learning" badge
                badge.textContent = 'Learning';
                badge.className = 'confidence-badge confidence-medium';
                badge.style.display = 'inline-block';
            }
        }

        // DISC-018: Update trial warning banner
        function updateTrialWarning(billingInfo) {
            const banner = document.getElementById('trialWarningBanner');
            const icon = document.getElementById('trialWarningIcon');
            const message = document.getElementById('trialWarningMessage');

            if (!billingInfo.warning_level) {
                banner.classList.remove('active', 'soft', 'urgent', 'grace');
                return;
            }

            // Track warning shown
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('trial_warning_shown', {
                    level: billingInfo.warning_level,
                    quotes_remaining: billingInfo.quotes_remaining,
                    grace_remaining: billingInfo.grace_remaining
                });
            }
            {% endif %}

            banner.classList.remove('soft', 'urgent', 'grace');
            banner.classList.add('active', billingInfo.warning_level);

            if (billingInfo.warning_level === 'soft') {
                icon.textContent = '';
                message.textContent = `You have ${billingInfo.quotes_remaining} quotes remaining in your trial.`;
            } else if (billingInfo.warning_level === 'urgent') {
                icon.textContent = '';
                message.textContent = `Trial ending soon! Only ${billingInfo.quotes_remaining} quotes left. Upgrade now to keep quoting.`;
            } else if (billingInfo.warning_level === 'grace') {
                icon.textContent = '';
                message.textContent = `Trial limit reached. ${billingInfo.grace_remaining} grace quotes remaining (with watermark).`;
            }
        }

        // DISC-018: Show grace quote modal
        function showGraceQuoteModal(graceRemaining) {
            const message = graceRemaining > 1
                ? `This quote has a "TRIAL EXPIRED" watermark. You have ${graceRemaining} grace quotes remaining. Upgrade now to remove watermarks and continue quoting.`
                : `This is your last grace quote with a watermark. Upgrade now to continue generating quotes.`;

            if (confirm(message + '\n\nGo to upgrade page?')) {
                showAccountView();
                showAccountTab('billing');
            }

            // Track grace quote modal shown
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('grace_quote_modal_shown', {
                    grace_remaining: graceRemaining
                });
            }
            {% endif %}
        }

        // Download PDF
        async function downloadPdf() {
            if (!currentQuoteId) {
                showError('No quote to download');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/quotes/${currentQuoteId}/pdf`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                });

                if (!response.ok) {
                    throw new Error('Failed to generate PDF');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'quote_' + currentQuoteId + '.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // Clear draft after successful download (DISC-032)
                clearDraft();
            } catch (err) {
                console.error('Error:', err);
                showError(err.message);
            }
        }

        // Edit current quote (from new quote result view)
        function editCurrentQuote() {
            if (currentQuoteId) {
                // Clear the quote result state
                const quoteResult = document.getElementById('quoteResult');
                quoteResult.classList.remove('active');
                quoteResult.style.display = '';
                // Open the edit detail view
                openQuoteDetail(currentQuoteId);
            }
        }

        // New quote
        function newQuote() {
            currentQuoteId = null;
            document.getElementById('jobDescription').value = '';
            document.getElementById('transcriptionText').value = '';
            document.getElementById('inputSection').style.display = 'block';
            document.getElementById('transcriptionPreview').style.display = 'none';
            const quoteResult = document.getElementById('quoteResult');
            quoteResult.classList.remove('active');
            quoteResult.style.display = '';  // Clear inline style, let CSS control
            hideError();
            resetFeedbackForm();
            // Clear draft when starting new quote (DISC-032)
            clearDraft();
        }

        // ========== CELEBRATION MODAL ==========

        function markCelebrationPending() {
            // Only mark pending if user hasn't celebrated yet
            const hasSeenCelebration = localStorage.getItem('quoted_has_celebrated');
            if (!hasSeenCelebration) {
                localStorage.setItem('quoted_celebration_pending', 'true');
            }
        }

        function checkAndShowCelebration() {
            // Check if celebration is pending (first quote was just created)
            const isPending = localStorage.getItem('quoted_celebration_pending');
            const hasSeenCelebration = localStorage.getItem('quoted_has_celebrated');

            if (isPending && !hasSeenCelebration) {
                // Clear pending flag and mark as celebrated
                localStorage.removeItem('quoted_celebration_pending');
                localStorage.setItem('quoted_has_celebrated', 'true');

                // Show celebration modal after a brief moment
                setTimeout(() => {
                    showCelebrationModal();
                }, 300);
            }
        }

        async function showCelebrationModal() {
            const modal = document.getElementById('celebrationModal');
            modal.style.display = 'flex';

            // Create confetti
            createConfetti();

            // Load referral code
            await loadCelebrationReferralCode();

            // Update social proof message
            updateCelebrationSocialProof();

            // Track celebration shown
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('celebration_shown', {
                    is_first_quote: true
                });
                posthog.capture('celebration_referral_viewed');
            }
            {% endif %}
        }

        function closeCelebrationModal() {
            const modal = document.getElementById('celebrationModal');
            modal.style.display = 'none';

            // Clear confetti
            document.getElementById('confetti').innerHTML = '';

            // Track dismissal
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('celebration_dismissed', {
                    method: 'close_button'
                });
            }
            {% endif %}
        }

        function closeCelebrationAndCreate() {
            // Track action
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('celebration_dismissed', {
                    method: 'create_another'
                });
            }
            {% endif %}

            closeCelebrationModal();
            // Navigate to New Quote section
            showAppSection('newQuote');
        }

        function viewQuoteDetails() {
            // Track action
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('celebration_dismissed', {
                    method: 'view_quote'
                });
            }
            {% endif %}

            closeCelebrationModal();
            // Stay on My Quotes section (already there)
        }

        async function shareFirstQuote() {
            // Track share click
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('celebration_share_clicked', {
                    is_first_quote: true
                });
            }
            {% endif %}

            // Get most recent quote to share
            try {
                const response = await fetch(`${API_BASE}/quotes`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const quotes = await response.json();
                    if (quotes && quotes.length > 0) {
                        const latestQuote = quotes[0];
                        const shareText = `I just created my first quote with Quoted! \n\nProject: ${latestQuote.project_name}\nTotal: $${latestQuote.total.toLocaleString()}\n\nQuoted uses AI to help contractors create professional quotes in seconds. Check it out!`;

                        // Try native share if available
                        if (navigator.share) {
                            try {
                                await navigator.share({
                                    title: 'My First Quote on Quoted',
                                    text: shareText
                                });
                                {% if posthog_api_key %}
                                if (window.posthog) {
                                    posthog.capture('celebration_share_completed', {
                                        method: 'native_share',
                                        is_first_quote: true
                                    });
                                }
                                {% endif %}
                            } catch (err) {
                                if (err.name !== 'AbortError') {
                                    console.error('Share failed:', err);
                                }
                            }
                        } else {
                            // Fallback: copy to clipboard
                            await navigator.clipboard.writeText(shareText);
                            alert('Quote details copied to clipboard! Share it with your network.');
                            {% if posthog_api_key %}
                            if (window.posthog) {
                                posthog.capture('celebration_share_completed', {
                                    method: 'clipboard',
                                    is_first_quote: true
                                });
                            }
                            {% endif %}
                        }
                    }
                }
            } catch (error) {
                console.error('Error sharing quote:', error);
                alert('Unable to share quote. Please try again.');
            }
        }

        function updateCelebrationSocialProof() {
            // Placeholder for beta counter integration
            // For now, use static message
            const socialProofElement = document.getElementById('celebrationSocialProof');
            if (socialProofElement) {
                socialProofElement.textContent = "You're in the first 100 beta testers!";
            }
        }

        function createConfetti() {
            const confettiContainer = document.getElementById('confetti');
            const colors = ['#7c3aed', '#fbbf24', '#4ade80', '#60a5fa', '#f87171'];
            const confettiCount = 25;  // Reduced for cleaner look

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                // Position only on edges (left 20% or right 20%)
                const leftOrRight = Math.random() < 0.5;
                confetti.style.left = leftOrRight ? (Math.random() * 20) + '%' : (80 + Math.random() * 20) + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                confettiContainer.appendChild(confetti);
            }
        }

        // ========== REFERRAL FUNCTIONS ==========

        let cachedReferralData = null;

        async function loadCelebrationReferralCode() {
            try {
                const response = await fetch(`${API_BASE}/referral/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    cachedReferralData = data;

                    // Extract code from shareable_link (format: https://quoted.com/?ref=CODE)
                    const referralCode = data.shareable_link ? data.shareable_link.split('=')[1] : 'ERROR';
                    document.getElementById('celebrationReferralCode').textContent = referralCode;
                } else {
                    document.getElementById('celebrationReferralCode').textContent = 'ERROR';
                }
            } catch (error) {
                console.error('Error loading referral code:', error);
                document.getElementById('celebrationReferralCode').textContent = 'ERROR';
            }
        }

        function copyCelebrationReferralCode() {
            const codeElement = document.getElementById('celebrationReferralCode');
            const code = codeElement.textContent;

            navigator.clipboard.writeText(code).then(() => {
                const btn = document.getElementById('copyCelebrationCodeBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';

                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);

                // Track analytics
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('referral_code_copied', {
                        source: 'celebration_modal'
                    });
                }
                {% endif %}
            });
        }

        function copyCelebrationReferralLink() {
            if (!cachedReferralData) return;

            const link = cachedReferralData.shareable_link;
            navigator.clipboard.writeText(link).then(() => {
                showLearningToast('Referral link copied!', '');

                // Track analytics
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('referral_link_copied', {
                        source: 'celebration_modal'
                    });
                }
                {% endif %}
            });
        }

        function shareCelebrationReferralLink() {
            if (!cachedReferralData) return;

            const link = cachedReferralData.shareable_link;
            const subject = 'Try Quoted - AI Quote Generator for Contractors';
            const body = `Hey! I've been using Quoted to generate professional quotes in seconds. You should check it out - use my code to get 14 days free (instead of 7): ${link}`;

            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

            // Track analytics
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('referral_shared', {
                    source: 'celebration_modal',
                    method: 'email'
                });
            }
            {% endif %}
        }

        async function loadShareModalReferralCode() {
            try {
                const response = await fetch(`${API_BASE}/referral/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();

                    // Extract code from shareable_link
                    const referralCode = data.shareable_link ? data.shareable_link.split('=')[1] : 'ERROR';
                    document.getElementById('shareModalReferralCode').textContent = referralCode;
                } else {
                    document.getElementById('shareModalReferralCode').textContent = 'ERROR';
                }
            } catch (error) {
                console.error('Error loading referral code:', error);
                document.getElementById('shareModalReferralCode').textContent = 'ERROR';
            }
        }

        function copyShareModalReferralCode() {
            const codeElement = document.getElementById('shareModalReferralCode');
            const code = codeElement.textContent;

            navigator.clipboard.writeText(code).then(() => {
                const btn = document.getElementById('copyShareModalCodeBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';

                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);

                // Track analytics
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('referral_code_copied', {
                        source: 'share_modal'
                    });
                }
                {% endif %}
            });
        }

        // ========== ONBOARDING ==========

        let onboardingSessionId = null;
        let chatMediaRecorder = null;
        let chatAudioChunks = [];
        let messageCount = 0;
        let selectedIndustry = null;

        // Industry data
        const industries = [
            // Construction
            { key: "deck_builder", display_name: "Deck Builder", icon: "", category: "Construction" },
            { key: "roofer", display_name: "Roofer", icon: "", category: "Construction" },
            { key: "concrete", display_name: "Concrete", icon: "", category: "Construction" },
            { key: "framing", display_name: "Framing", icon: "", category: "Construction" },
            { key: "masonry", display_name: "Masonry", icon: "", category: "Construction" },
            { key: "fence_installer", display_name: "Fence Installer", icon: "", category: "Construction" },

            // Finishing
            { key: "painter", display_name: "Painter", icon: "", category: "Finishing" },
            { key: "flooring", display_name: "Flooring", icon: "", category: "Finishing" },
            { key: "tile", display_name: "Tile Installer", icon: "", category: "Finishing" },
            { key: "drywall", display_name: "Drywall", icon: "", category: "Finishing" },
            { key: "cabinet_maker", display_name: "Cabinet Maker", icon: "", category: "Finishing" },

            // Electrical & Plumbing
            { key: "electrician", display_name: "Electrician", icon: "", category: "Electrical" },
            { key: "plumber", display_name: "Plumber", icon: "", category: "Plumbing" },
            { key: "hvac", display_name: "HVAC", icon: "", category: "HVAC" },

            // Outdoor
            { key: "landscaper", display_name: "Landscaper", icon: "", category: "Outdoor" },
            { key: "pool_spa", display_name: "Pool & Spa", icon: "", category: "Outdoor" },
            { key: "tree_service", display_name: "Tree Service", icon: "", category: "Outdoor" },

            // Installation & Exterior
            { key: "window_door", display_name: "Window & Door", icon: "", category: "Installation" },
            { key: "siding", display_name: "Siding", icon: "", category: "Exterior" },
            { key: "gutters", display_name: "Gutters", icon: "", category: "Exterior" },
            { key: "insulation", display_name: "Insulation", icon: "", category: "Installation" },
            { key: "garage_door", display_name: "Garage Door", icon: "", category: "Installation" },

            // Cleaning & Organization
            { key: "pressure_washing", display_name: "Pressure Washing", icon: "", category: "Cleaning" },
            { key: "closet_organizer", display_name: "Closet Organizer", icon: "", category: "Organization" },

            // Freelance & Creative
            { key: "graphic_designer", display_name: "Graphic Designer", icon: "", category: "Freelance & Creative" },
            { key: "web_developer", display_name: "Web Developer", icon: "", category: "Freelance & Creative" },
            { key: "writer", display_name: "Writer", icon: "", category: "Freelance & Creative" },
            { key: "photographer", display_name: "Photographer", icon: "", category: "Freelance & Creative" },
            { key: "videographer", display_name: "Videographer", icon: "", category: "Freelance & Creative" },

            // Event Services
            { key: "dj", display_name: "DJ", icon: "", category: "Event Services" },
            { key: "caterer", display_name: "Caterer", icon: "", category: "Event Services" },
            { key: "event_planner", display_name: "Event Planner", icon: "", category: "Event Services" },
            { key: "florist", display_name: "Florist", icon: "", category: "Event Services" },
            { key: "wedding_coordinator", display_name: "Wedding Coordinator", icon: "", category: "Event Services" },

            // Personal Services
            { key: "personal_trainer", display_name: "Personal Trainer", icon: "", category: "Personal Services" },
            { key: "tutor", display_name: "Tutor", icon: "", category: "Personal Services" },
            { key: "coach", display_name: "Coach", icon: "", category: "Personal Services" },
            { key: "consultant", display_name: "Consultant", icon: "", category: "Personal Services" },
            { key: "music_teacher", display_name: "Music Teacher", icon: "", category: "Personal Services" },

            // General
            { key: "general_contractor", display_name: "General Contractor", icon: "", category: "General" },
            { key: "other", display_name: "Other", icon: "", category: "Other" }
        ];

        function showIndustrySelection() {
            document.getElementById('industrySelection').style.display = 'block';
            document.getElementById('onboardingIntro').style.display = 'none';
            document.getElementById('quickSetupForm').style.display = 'none';
            document.getElementById('onboardingChat').classList.remove('active');

            // Track that user viewed industry selection
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('industry_selection_viewed');
            }
            {% endif %}

            // Populate industry grid
            const grid = document.getElementById('industryGrid');
            grid.innerHTML = '';
            industries.forEach(industry => {
                const card = document.createElement('div');
                card.className = 'industry-card';
                card.dataset.industry = industry.key;

                const icon = document.createElement('span');
                icon.className = 'industry-icon';
                icon.textContent = industry.icon;

                const name = document.createElement('div');
                name.className = 'industry-name';
                name.textContent = industry.display_name;

                card.appendChild(icon);
                card.appendChild(name);
                card.onclick = () => selectIndustry(industry.key, industry.display_name);
                grid.appendChild(card);
            });
        }

        function selectIndustry(key, displayName) {
            selectedIndustry = { key, displayName };

            // Update UI
            document.querySelectorAll('.industry-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-industry="${key}"]`).classList.add('selected');

            // Show/hide "Other" input
            const otherInput = document.getElementById('industryOtherInput');
            if (key === 'other') {
                otherInput.classList.add('active');
                document.getElementById('industryOtherText').focus();
            } else {
                otherInput.classList.remove('active');
            }

            // Enable continue button
            document.getElementById('industryContinueBtn').disabled = false;
        }

        async function continueFromIndustrySelection() {
            if (!selectedIndustry) return;

            // If "Other" is selected, get the custom text
            let industryToSave = selectedIndustry.key;
            if (selectedIndustry.key === 'other') {
                const customIndustry = document.getElementById('industryOtherText').value.trim();
                if (!customIndustry) {
                    alert('Please enter your trade or industry');
                    return;
                }
                industryToSave = customIndustry;
            }

            // Track industry selection
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('industry_selected', { industry: industryToSave });
            }
            {% endif %}

            try {
                // Save industry to contractor profile
                const response = await fetch(`${API_BASE}/contractors/industry`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({ industry: industryToSave }),
                });

                if (!response.ok) {
                    throw new Error('Failed to save industry');
                }

                // Update current user
                currentUser.primary_trade = industryToSave;

                // Show onboarding intro
                showOnboardingIntro();
            } catch (err) {
                console.error('Error saving industry:', err);
                // Continue anyway to not block onboarding
                showOnboardingIntro();
            }
        }

        function showOnboardingIntro() {
            document.getElementById('industrySelection').style.display = 'none';
            document.getElementById('onboardingIntro').style.display = 'block';
            document.getElementById('quickSetupForm').style.display = 'none';
            document.getElementById('onboardingChat').classList.remove('active');
        }

        // Template-guided quick setup functions
        function renderDynamicFormFields(template) {
            const container = document.getElementById('dynamicFormFields');
            // Clear existing - safe method
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            const approach = template.recommended_approach;
            const primaryPricing = template.primary_pricing || {};
            const additionalRates = template.additional_rates || [];

            // Render fields based on recommended approach
            if (approach === 'hourly_plus_materials' || approach === 'hourly') {
                // Hourly-based industries (electrician, plumber, handyman)
                renderFormField(container, {
                    id: 'hourlyRate',
                    label: primaryPricing.label || 'Hourly Labor Rate ($)',
                    value: primaryPricing.suggested_default || 85,
                    placeholder: primaryPricing.suggested_default || 85,
                    hint: primaryPricing.base_rate_range ? `Typical range: $${primaryPricing.base_rate_range[0]}-${primaryPricing.base_rate_range[1]}` : null
                });

                const serviceCallMin = additionalRates.find(r => r.name === 'service_call_minimum' || r.name === 'minimum_charge');
                if (serviceCallMin) {
                    renderFormField(container, {
                        id: 'minimumJob',
                        label: serviceCallMin.label || 'Service Call Minimum ($)',
                        value: serviceCallMin.suggested || 500,
                        placeholder: serviceCallMin.suggested || 500,
                        hint: serviceCallMin.range ? `Typical range: $${serviceCallMin.range[0]}-${serviceCallMin.range[1]}` : null
                    });
                }

                const materialMarkup = additionalRates.find(r => r.name === 'material_markup');
                if (materialMarkup) {
                    renderFormField(container, {
                        id: 'materialMarkup',
                        label: materialMarkup.label || 'Material Markup (%)',
                        value: materialMarkup.suggested || 20,
                        placeholder: materialMarkup.suggested || 20,
                        hint: materialMarkup.range ? `Typical range: ${materialMarkup.range[0]}-${materialMarkup.range[1]}%` : null
                    });
                }

            } else if (approach === 'per_linear_foot') {
                // Linear foot industries (cabinet_maker)
                renderFormField(container, {
                    id: 'baseRatePerLF',
                    label: primaryPricing.label || 'Base Rate per Linear Foot ($)',
                    value: primaryPricing.suggested_default || 500,
                    placeholder: primaryPricing.suggested_default || 500,
                    hint: primaryPricing.base_rate_range ? `Typical range: $${primaryPricing.base_rate_range[0]}-${primaryPricing.base_rate_range[1]}` : null
                });

                renderFormField(container, {
                    id: 'minimumJob',
                    label: 'Minimum Project Amount ($)',
                    value: 2000,
                    placeholder: 2000,
                    hint: 'Minimum charge for any cabinet project'
                });

            } else if (approach === 'per_square_foot') {
                // Square foot industries (painter, flooring, concrete, deck_builder, tile, drywall)
                renderFormField(container, {
                    id: 'baseRatePerSqFt',
                    label: primaryPricing.label || 'Rate per Square Foot ($)',
                    value: primaryPricing.suggested_default || 10,
                    placeholder: primaryPricing.suggested_default || 10,
                    hint: primaryPricing.base_rate_range ? `Typical range: $${primaryPricing.base_rate_range[0]}-${primaryPricing.base_rate_range[1]}` : null
                });

                renderFormField(container, {
                    id: 'minimumJob',
                    label: 'Minimum Project Amount ($)',
                    value: 500,
                    placeholder: 500,
                    hint: 'Minimum charge for any project'
                });

            } else if (approach === 'per_square') {
                // Per square industries (roofer - 100 sq ft)
                renderFormField(container, {
                    id: 'baseRatePerSquare',
                    label: primaryPricing.label || 'Price per Square (100 sq ft)',
                    value: primaryPricing.suggested_default || 450,
                    placeholder: primaryPricing.suggested_default || 450,
                    hint: primaryPricing.base_rate_range ? `Typical range: $${primaryPricing.base_rate_range[0]}-${primaryPricing.base_rate_range[1]}` : null
                });

                renderFormField(container, {
                    id: 'minimumJob',
                    label: 'Emergency Repair Minimum ($)',
                    value: 500,
                    placeholder: 500,
                    hint: 'Minimum charge for emergency repairs'
                });

            } else if (approach === 'per_unit') {
                // Per unit industries (window_door)
                renderFormField(container, {
                    id: 'baseRatePerUnit',
                    label: primaryPricing.label || 'Rate per Unit ($)',
                    value: primaryPricing.suggested_default || 450,
                    placeholder: primaryPricing.suggested_default || 450,
                    hint: primaryPricing.base_rate_range ? `Typical range: $${primaryPricing.base_rate_range[0]}-${primaryPricing.base_rate_range[1]}` : null
                });

                renderFormField(container, {
                    id: 'minimumJob',
                    label: 'Minimum Job ($)',
                    value: 400,
                    placeholder: 400,
                    hint: 'Minimum charge for any job'
                });

            } else if (approach === 'percentage_markup') {
                // Percentage-based (general_contractor)
                renderFormField(container, {
                    id: 'projectManagementFee',
                    label: primaryPricing.label || 'Project Management Fee (%)',
                    value: primaryPricing.suggested_default || 15,
                    placeholder: primaryPricing.suggested_default || 15,
                    hint: primaryPricing.base_rate_range ? `Typical range: ${primaryPricing.base_rate_range[0]}-${primaryPricing.base_rate_range[1]}%` : null
                });

                const hourlyRate = additionalRates.find(r => r.name === 'hourly_rate');
                if (hourlyRate) {
                    renderFormField(container, {
                        id: 'hourlyRate',
                        label: hourlyRate.label || 'Hourly Rate (small jobs)',
                        value: hourlyRate.suggested || 95,
                        placeholder: hourlyRate.suggested || 95,
                        hint: hourlyRate.range ? `Typical range: $${hourlyRate.range[0]}-${hourlyRate.range[1]}` : null
                    });
                }

            } else {
                // Mixed or fallback - use default hourly fields
                renderDefaultFormFields();
            }
        }

        function renderFormField(container, config) {
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';

            const label = document.createElement('label');
            label.textContent = config.label + (config.optional ? ' (optional)' : '');
            formGroup.appendChild(label);

            const input = document.createElement('input');
            input.type = 'number';
            input.id = config.id;
            input.placeholder = config.placeholder || '';
            input.value = config.value || '';
            if (config.step) input.step = config.step;
            formGroup.appendChild(input);

            if (config.hint) {
                const hint = document.createElement('small');
                hint.id = config.id + 'Hint';
                hint.style.color = 'var(--text-muted)';
                hint.style.fontSize = '0.8rem';
                hint.style.marginTop = '4px';
                hint.style.display = 'block';
                hint.textContent = config.hint;
                formGroup.appendChild(hint);
            }

            container.appendChild(formGroup);
        }

        function renderDefaultFormFields() {
            const container = document.getElementById('dynamicFormFields');
            // Clear existing - safe method
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            renderFormField(container, {
                id: 'hourlyRate',
                label: 'Hourly Labor Rate ($)',
                value: 85,
                placeholder: 85
            });

            renderFormField(container, {
                id: 'materialMarkup',
                label: 'Material Markup (%)',
                value: 20,
                placeholder: 20
            });

            renderFormField(container, {
                id: 'minimumJob',
                label: 'Minimum Job Amount ($)',
                value: 500,
                placeholder: 500
            });
        }

        async function loadPricingTemplate(industryKey) {
            try {
                const response = await fetch(`${API_BASE}/onboarding/templates/${industryKey}`);
                if (!response.ok) {
                    // No template available, hide guidance and show default fields
                    document.getElementById('templateGuidance').style.display = 'none';
                    document.getElementById('pricingTipsSection').style.display = 'none';
                    renderDefaultFormFields();
                    return;
                }

                const template = await response.json();

                // Show and populate recommended approach
                document.getElementById('templateGuidance').style.display = 'block';
                document.getElementById('templateApproach').textContent = template.approach_description;

                // Render dynamic form fields based on approach
                renderDynamicFormFields(template);

                // Populate pricing tips (safe DOM method - no XSS risk)
                if (template.pricing_tips && template.pricing_tips.length > 0) {
                    const tipsList = document.getElementById('pricingTipsList');
                    tipsList.textContent = ''; // Clear existing
                    template.pricing_tips.forEach(tip => {
                        const li = document.createElement('li');
                        li.textContent = tip; // Use textContent for safety
                        tipsList.appendChild(li);
                    });
                    document.getElementById('pricingTipsSection').style.display = 'block';
                }

            } catch (error) {
                console.error('Error loading pricing template:', error);
                // Silently fail - show default fields
                renderDefaultFormFields();
            }
        }

        function onPrimaryTradeChange() {
            const selectedTrade = document.getElementById('primaryTrade').value;
            if (selectedTrade && selectedTrade !== 'other') {
                loadPricingTemplate(selectedTrade);
            } else {
                // Hide template guidance for "other"
                document.getElementById('templateGuidance').style.display = 'none';
                document.getElementById('pricingTipsSection').style.display = 'none';
                renderDefaultFormFields();
            }
        }

        function togglePricingTips() {
            const content = document.getElementById('pricingTipsContent');
            const chevron = document.getElementById('tipsChevron');
            const isHidden = content.style.display === 'none';

            content.style.display = isHidden ? 'block' : 'none';
            chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
        }

                async function showQuickSetup() {
            document.getElementById('industrySelection').style.display = 'none';
            document.getElementById('onboardingIntro').style.display = 'none';
            document.getElementById('quickSetupForm').style.display = 'block';
            document.getElementById('onboardingChat').classList.remove('active');

            // Track onboarding path selection
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('onboarding_path_selected', { path: 'quick_setup' });
                posthog.capture('onboarding_started', { onboarding_type: 'quick_setup' });
            }
            {% endif %}

            // Load template if industry is selected
            if (selectedIndustry && selectedIndustry.key !== 'other') {
                document.getElementById('primaryTrade').value = selectedIndustry.key;
                await loadPricingTemplate(selectedIndustry.key);
            }
        }

        async function startOnboardingInterview() {
            document.getElementById('industrySelection').style.display = 'none';
            document.getElementById('onboardingIntro').style.display = 'none';
            document.getElementById('quickSetupForm').style.display = 'none';
            document.getElementById('onboardingChat').classList.add('active');

            document.getElementById('chatMessages').innerHTML = '';
            messageCount = 0;

            // Track onboarding path selection
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('onboarding_path_selected', { path: 'interview' });
                posthog.capture('onboarding_started', { onboarding_type: 'interview' });
            }
            {% endif %}

            addTypingIndicator();

            try {
                // Ensure we have user info before proceeding
                if (!currentUser) {
                    await fetchUserInfo();
                }

                const contractorName = currentUser?.business_name || currentUser?.email || 'Contractor';

                const response = await fetch(`${API_BASE}/onboarding/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({
                        contractor_name: contractorName,
                        primary_trade: 'general',
                    }),
                });

                if (!response.ok) {
                    throw new Error('Failed to start interview');
                }

                const session = await response.json();
                onboardingSessionId = session.session_id;

                removeTypingIndicator();
                addChatMessage('assistant', session.initial_message);

            } catch (err) {
                console.error('Interview error:', err);
                removeTypingIndicator();
                addChatMessage('assistant', "Having trouble starting. Please try again or use Quick Setup.");
            }
        }

        async function handleTryFirst() {
            try {
                // Show loading state
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.disabled = true;

                // Clear button and set loading text safely
                while (btn.firstChild) {
                    btn.removeChild(btn.firstChild);
                }
                const loadingSpan = document.createElement('span');
                loadingSpan.style.display = 'flex';
                loadingSpan.style.alignItems = 'center';
                loadingSpan.style.gap = '8px';
                loadingSpan.style.justifyContent = 'center';
                loadingSpan.textContent = 'Creating your pricing model...';
                btn.appendChild(loadingSpan);

                // Call try-first endpoint
                const response = await fetch(`${API_BASE}/onboarding/try-first`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to activate try-first mode');
                }

                const result = await response.json();

                // Track try-first quote generation event
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('try_first_activated', {
                        primary_trade: currentUser?.primary_trade,
                    });
                }
                {% endif %}

                // Hide onboarding
                document.getElementById('onboardingIntro').style.display = 'none';

                // Show success message if showNotification exists, otherwise use alert
                const successMessage = result.message || 'Ready to generate your first quote! You can customize pricing anytime from Settings.';
                if (typeof showNotification === 'function') {
                    showNotification(successMessage, 'success');
                } else {
                    alert(successMessage);
                }

                // Switch to quotes tab immediately
                setTimeout(() => {
                    switchTab('quotes');
                }, 500);

            } catch (err) {
                console.error('Error activating try-first:', err);
                alert(err.message || 'Failed to set up pricing. Please try again or choose a different onboarding option.');

                // Restore button - use a safer approach
                const btn = event.target.closest('button');
                if (btn) {
                    btn.disabled = false;
                    // Recreate button content safely
                    while (btn.firstChild) {
                        btn.removeChild(btn.firstChild);
                    }
                    const span = document.createElement('span');
                    span.style.display = 'flex';
                    span.style.alignItems = 'center';
                    span.style.gap = '8px';
                    span.style.justifyContent = 'center';
                    span.textContent = 'Try a Quote Now';

                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.setAttribute('width', '16');
                    svg.setAttribute('height', '16');
                    svg.setAttribute('viewBox', '0 0 24 24');
                    svg.setAttribute('fill', 'none');
                    svg.setAttribute('stroke', 'currentColor');
                    svg.setAttribute('stroke-width', '2');

                    const path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path1.setAttribute('d', 'M5 12h14');
                    const path2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path2.setAttribute('d', 'M12 5l7 7-7 7');

                    svg.appendChild(path1);
                    svg.appendChild(path2);
                    span.appendChild(svg);
                    btn.appendChild(span);
                }
            }
        }

        function addChatMessage(role, content) {
            const container = document.getElementById('chatMessages');
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message ' + role;

            const roleLabel = document.createElement('div');
            roleLabel.className = 'role';
            roleLabel.textContent = role === 'assistant' ? 'quoted.it' : 'You';

            const contentEl = document.createElement('div');
            contentEl.textContent = content;

            msgEl.appendChild(roleLabel);
            msgEl.appendChild(contentEl);
            container.appendChild(msgEl);

            container.scrollTop = container.scrollHeight;

            if (role === 'user') {
                messageCount++;
                if (messageCount >= 2) {
                    document.getElementById('finishInterviewBtn').style.display = 'inline-block';
                }
            }

            return msgEl;
        }

        function addTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const indicator = document.createElement('div');
            indicator.className = 'chat-message assistant';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || !onboardingSessionId) return;

            input.value = '';
            document.getElementById('chatSendBtn').disabled = true;

            addChatMessage('user', message);
            addTypingIndicator();

            try {
                const response = await fetch(`${API_BASE}/onboarding/${onboardingSessionId}/continue`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({ message }),
                });

                if (!response.ok) {
                    throw new Error('Failed to continue');
                }

                const session = await response.json();
                const messages = session.messages;
                const lastMessage = messages[messages.length - 1];

                removeTypingIndicator();

                if (lastMessage && lastMessage.role === 'assistant') {
                    addChatMessage('assistant', lastMessage.content);
                }

            } catch (err) {
                console.error('Chat error:', err);
                removeTypingIndicator();
                addChatMessage('assistant', "Having trouble. Please try again.");
            } finally {
                document.getElementById('chatSendBtn').disabled = false;
            }
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function toggleChatVoice() {
            const btn = document.getElementById('chatVoiceBtn');

            if (chatMediaRecorder && chatMediaRecorder.state === 'recording') {
                chatMediaRecorder.stop();
                btn.classList.remove('recording');
                btn.innerHTML = '<span></span>';
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const mimeType = getSupportedAudioMimeType();
                    const options = mimeType ? { mimeType } : {};
                    chatMediaRecorder = new MediaRecorder(stream, options);
                    chatAudioChunks = [];

                    chatMediaRecorder.ondataavailable = (e) => {
                        chatAudioChunks.push(e.data);
                    };

                    chatMediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(chatAudioChunks, { type: mimeType || 'audio/webm' });
                        stream.getTracks().forEach(track => track.stop());

                        // Show placeholder while transcribing
                        const placeholderMsg = addChatMessage('user', '[Transcribing voice message...]');

                        try {
                            // Send audio for transcription
                            const formData = new FormData();
                            formData.append('audio', audioBlob, 'voice.webm');

                            const response = await fetch(`${API_BASE}/quotes/transcribe`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${authToken}`,
                                },
                                body: formData,
                            });

                            if (!response.ok) {
                                throw new Error('Transcription failed');
                            }

                            const result = await response.json();
                            const transcribedText = result.text;

                            // Update placeholder with actual text
                            if (placeholderMsg) {
                                placeholderMsg.querySelector('div:last-child').textContent = transcribedText;
                            }

                            // Send transcribed message to interview
                            if (onboardingSessionId && transcribedText) {
                                addTypingIndicator();

                                const continueResponse = await fetch(`${API_BASE}/onboarding/${onboardingSessionId}/continue`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${authToken}`,
                                    },
                                    body: JSON.stringify({ message: transcribedText }),
                                });

                                if (continueResponse.ok) {
                                    const session = await continueResponse.json();
                                    const messages = session.messages;
                                    const lastMessage = messages[messages.length - 1];

                                    removeTypingIndicator();

                                    if (lastMessage && lastMessage.role === 'assistant') {
                                        addChatMessage('assistant', lastMessage.content);
                                    }
                                } else {
                                    removeTypingIndicator();
                                }
                            }
                        } catch (err) {
                            console.error('Voice transcription error:', err);
                            if (placeholderMsg) {
                                placeholderMsg.querySelector('div:last-child').textContent = '[Voice transcription failed - please type your message]';
                            }
                        }
                    };

                    chatMediaRecorder.start();
                    btn.classList.add('recording');
                    btn.innerHTML = '<span></span>';
                } catch (err) {
                    console.error('Microphone error:', err);
                    showError('Could not access microphone');
                }
            }
        }

        async function finishInterview() {
            if (!onboardingSessionId) return;

            document.getElementById('finishInterviewBtn').disabled = true;
            document.getElementById('finishInterviewBtn').textContent = 'Saving...';

            addTypingIndicator();

            try {
                const response = await fetch(`${API_BASE}/onboarding/${onboardingSessionId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                    },
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to complete');
                }

                const pricingModel = await response.json();

                removeTypingIndicator();
                addChatMessage('assistant', "Your pricing is saved. You're ready to start quoting!");

                // Track onboarding completion
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('onboarding_completed', {
                        onboarding_type: 'interview',
                        onboarding_path: 'interview'  // DISC-007
                    });
                }
                {% endif %}

                // Set flag for first quote activation modal
                localStorage.setItem('just_completed_onboarding', 'true');

                setTimeout(async () => {
                    await savePricingToContractor(pricingModel);
                    document.getElementById('onboardingNotice').style.display = 'none';
                    document.getElementById('inputSection').style.display = 'block';
                }, 2000);

            } catch (err) {
                console.error('Complete error:', err);
                removeTypingIndicator();
                addChatMessage('assistant', "Need more info. Tell me about your hourly rate or typical pricing.");
                document.getElementById('finishInterviewBtn').disabled = false;
                document.getElementById('finishInterviewBtn').textContent = 'Finish & Save';
            }
        }

        async function savePricingToContractor(pricingModel) {
            // Pricing model is saved by the /complete endpoint on the backend
            // This function is kept for logging and potential future enhancements
            console.log('Pricing model saved by backend:', pricingModel);
        }

        async function completeQuickSetup() {
            const primaryTrade = document.getElementById('primaryTrade').value;

            // Collect all form field values dynamically
            const formData = {
                contractor_name: '',
                primary_trade: primaryTrade,
            };

            // Try to get values from different possible field IDs
            const getValue = (id) => {
                const el = document.getElementById(id);
                return el ? parseFloat(el.value) || null : null;
            };

            // Hourly-based fields
            const hourlyRate = getValue('hourlyRate');
            const helperRate = getValue('helperRate');
            const materialMarkup = getValue('materialMarkup');

            // Per-unit fields
            const baseRatePerLF = getValue('baseRatePerLF');
            const baseRatePerSqFt = getValue('baseRatePerSqFt');
            const baseRatePerSquare = getValue('baseRatePerSquare');
            const baseRatePerUnit = getValue('baseRatePerUnit');
            const tearOffPerSquare = getValue('tearOffPerSquare');

            // General contractor fields
            const projectManagementFee = getValue('projectManagementFee');

            // Common fields
            const minimumJob = getValue('minimumJob');

            // Build the request data based on what fields are present
            if (hourlyRate) {
                formData.labor_rate = hourlyRate;
            } else if (baseRatePerLF) {
                formData.base_rate_per_lf = baseRatePerLF;
            } else if (baseRatePerSqFt) {
                formData.base_rate_per_sqft = baseRatePerSqFt;
            } else if (baseRatePerSquare) {
                formData.base_rate_per_square = baseRatePerSquare;
            } else if (baseRatePerUnit) {
                formData.base_rate_per_unit = baseRatePerUnit;
            } else if (projectManagementFee) {
                formData.project_management_fee = projectManagementFee;
            }

            // Add optional fields if present
            if (helperRate) formData.helper_rate = helperRate;
            if (materialMarkup) formData.material_markup = materialMarkup;
            if (minimumJob) formData.minimum_job = minimumJob;
            if (tearOffPerSquare) formData.tear_off_per_square = tearOffPerSquare;

            try {
                // Ensure we have user info before proceeding
                if (!currentUser) {
                    await fetchUserInfo();
                }

                // Get contractor name with safe fallback
                formData.contractor_name = currentUser?.business_name || currentUser?.email || 'Contractor';

                const response = await fetch(`${API_BASE}/onboarding/quick`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify(formData),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Setup failed');
                }

                await fetchUserInfo();

                // Track onboarding completion
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('onboarding_completed', {
                        onboarding_type: 'quick_setup',
                        onboarding_path: 'quick_setup'  // DISC-007
                    });
                }
                {% endif %}

                document.getElementById('onboardingNotice').style.display = 'none';
                document.getElementById('inputSection').style.display = 'block';

            } catch (err) {
                console.error('Quick setup error:', err);
                showError('Setup failed: ' + err.message);
            }
        }

        // UI helpers
        let loadingMessageInterval = null;
        const loadingMessages = [
            { text: 'Generating your quote...', sub: 'Analyzing your pricing model' },
            { text: 'Building line items...', sub: 'Applying learned adjustments' },
            { text: 'Calculating totals...', sub: 'Checking similar past quotes' },
            { text: 'Almost there...', sub: 'Finalizing your estimate' }
        ];

        function showLoading(show, message = 'Generating your quote...') {
            document.getElementById('inputSection').style.display = show ? 'none' : 'block';
            document.getElementById('transcriptionPreview').style.display = 'none';

            // Clear any inline style that might override the CSS class
            const loadingSection = document.getElementById('loadingSection');
            if (show) {
                loadingSection.style.display = '';  // Clear inline style so CSS .active works
            }
            loadingSection.classList.toggle('active', show);
            document.getElementById('loadingText').textContent = message;

            // Clear any existing interval
            if (loadingMessageInterval) {
                clearInterval(loadingMessageInterval);
                loadingMessageInterval = null;
            }

            if (show && message !== 'Transcribing...') {
                let messageIndex = 0;
                const loadingText = document.getElementById('loadingText');
                const loadingSubtext = document.getElementById('loadingSubtext');

                // Cycle through messages
                loadingMessageInterval = setInterval(() => {
                    messageIndex = (messageIndex + 1) % loadingMessages.length;
                    loadingText.textContent = loadingMessages[messageIndex].text;
                    loadingSubtext.textContent = loadingMessages[messageIndex].sub;
                }, 2500);
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('active');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('active');
        }

        // Issue Reporter
        function openIssueModal() {
            document.getElementById('issueModal').classList.add('active');
            document.getElementById('issueFormView').style.display = 'block';
            document.getElementById('issueSuccessView').style.display = 'none';
            window.currentIssuePageUrl = window.location.href;
        }

        function closeIssueModal() {
            document.getElementById('issueModal').classList.remove('active');
            document.getElementById('issueTitle').value = '';
            document.getElementById('issueDescription').value = '';
            document.getElementById('issueSteps').value = '';
            document.getElementById('issueCategory').value = 'bug';
            document.getElementById('issueSeverity').value = 'medium';
        }

        async function submitIssue(event) {
            event.preventDefault();

            const issueData = {
                title: document.getElementById('issueTitle').value,
                description: document.getElementById('issueDescription').value,
                category: document.getElementById('issueCategory').value,
                severity: document.getElementById('issueSeverity').value,
                steps_to_reproduce: document.getElementById('issueSteps').value || null,
                page_url: window.currentIssuePageUrl || window.location.href,
                browser_info: navigator.userAgent,
                error_message: window.lastJsError || null
            };

            try {
                const response = await fetch(`${API_BASE}/issues/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(issueData)
                });

                if (!response.ok) {
                    throw new Error('Failed to submit');
                }

                const result = await response.json();

                document.getElementById('issueFormView').style.display = 'none';
                document.getElementById('issueSuccessView').style.display = 'block';
                document.getElementById('submittedIssueId').textContent = result.id.substring(0, 8);

            } catch (err) {
                console.error('Issue submit error:', err);
                alert('Failed to submit. Please try again.');
            }
        }

        // ========================================
        // Feedback System (Enhancement 4)
        // ========================================

        // Feedback state
        let feedbackState = {
            overallRating: null,
            pricingDirection: 'about_right',
            issues: [],
            submitted: false
        };

        // Initialize star rating click handlers
        document.addEventListener('DOMContentLoaded', () => {
            const starContainer = document.getElementById('starRating');
            if (starContainer) {
                starContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('star')) {
                        const rating = parseInt(e.target.dataset.rating);
                        setStarRating(rating);
                    }
                });
            }
        });

        function toggleFeedback() {
            const content = document.getElementById('feedbackContent');
            const toggle = document.getElementById('feedbackToggle');

            if (content.style.display === 'none' || !content.style.display) {
                content.style.display = 'block';
                toggle.textContent = '';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        function setStarRating(rating) {
            feedbackState.overallRating = rating;
            const stars = document.querySelectorAll('#starRating .star');

            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function setPricingDirection(direction) {
            feedbackState.pricingDirection = direction;

            // Update button states
            const buttons = document.querySelectorAll('.pricing-btn');
            buttons.forEach(btn => {
                if (btn.dataset.direction === direction) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function updateIssues(checkbox) {
            const value = checkbox.value;

            if (checkbox.checked) {
                if (!feedbackState.issues.includes(value)) {
                    feedbackState.issues.push(value);
                }
            } else {
                feedbackState.issues = feedbackState.issues.filter(i => i !== value);
            }
        }

        async function submitFeedback() {
            if (!currentQuoteId) {
                console.error('No quote ID for feedback');
                return;
            }

            if (feedbackState.submitted) {
                showFeedbackStatus('Feedback already submitted', 'info');
                return;
            }

            const feedbackText = document.getElementById('feedbackText')?.value || '';

            const feedbackData = {
                overall_rating: feedbackState.overallRating,
                pricing_direction: feedbackState.pricingDirection,
                issues: feedbackState.issues.length > 0 ? feedbackState.issues : null,
                feedback_text: feedbackText || null
            };

            // Remove null values
            Object.keys(feedbackData).forEach(key => {
                if (feedbackData[key] === null) {
                    delete feedbackData[key];
                }
            });

            try {
                const response = await fetch(`${API_BASE}/quotes/${currentQuoteId}/feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(feedbackData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to submit feedback');
                }

                feedbackState.submitted = true;
                showFeedbackStatus('Thank you for your feedback!', 'success');

                // Collapse feedback section after success
                setTimeout(() => {
                    toggleFeedback();
                }, 1500);

            } catch (err) {
                console.error('Feedback submit error:', err);
                showFeedbackStatus('Failed to submit: ' + err.message, 'error');
            }
        }

        function showFeedbackStatus(message, type) {
            const statusEl = document.getElementById('feedbackStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = 'feedback-status ' + type;

                // Clear after a few seconds
                setTimeout(() => {
                    statusEl.textContent = '';
                    statusEl.className = 'feedback-status';
                }, 3000);
            }
        }

        function resetFeedbackForm() {
            feedbackState = {
                overallRating: null,
                pricingDirection: 'about_right',
                issues: [],
                submitted: false
            };

            // Reset stars
            document.querySelectorAll('#starRating .star').forEach(star => {
                star.classList.remove('active');
            });

            // Reset pricing buttons
            document.querySelectorAll('.pricing-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.direction === 'about_right');
            });

            // Reset checkboxes
            document.querySelectorAll('.issue-checkboxes input').forEach(cb => {
                cb.checked = false;
            });

            // Reset text
            const feedbackText = document.getElementById('feedbackText');
            if (feedbackText) feedbackText.value = '';

            // Reset status
            const statusEl = document.getElementById('feedbackStatus');
            if (statusEl) {
                statusEl.textContent = '';
                statusEl.className = 'feedback-status';
            }

            // Collapse feedback section
            const content = document.getElementById('feedbackContent');
            const toggle = document.getElementById('feedbackToggle');
            if (content) content.style.display = 'none';
            if (toggle) toggle.textContent = '+';
        }

        // ========================================
        // End Feedback System
        // ========================================

        // ========================================
        // Quote History & Editing System
        // ========================================

        // Quote history state
        let quotesCache = [];
        let currentDetailQuote = null;
        let originalQuoteState = null;
        let editedLineItems = [];
        let hasUnsavedChanges = false;

        // App section navigation
        function showAppSection(section) {
            // Update desktop nav buttons
            document.getElementById('newQuoteNavBtn').classList.toggle('active', section === 'newQuote');
            document.getElementById('myQuotesNavBtn').classList.toggle('active', section === 'myQuotes');
            document.getElementById('accountNavBtn').classList.toggle('active', section === 'account');

            // Update mobile nav buttons
            document.getElementById('mobileNewQuoteBtn').classList.toggle('active', section === 'newQuote');
            document.getElementById('mobileMyQuotesBtn').classList.toggle('active', section === 'myQuotes');
            document.getElementById('mobileAccountBtn').classList.toggle('active', section === 'account');

            // Hide all sections
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('quoteResult').style.display = 'none';
            document.getElementById('myQuotesSection').style.display = 'none';
            document.getElementById('quoteDetailView').style.display = 'none';
            document.getElementById('onboardingNotice').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('accountSection').style.display = 'none';

            if (section === 'newQuote') {
                // Check if quote result is active (user just generated a quote)
                const quoteResult = document.getElementById('quoteResult');
                if (quoteResult.classList.contains('active')) {
                    // Show the quote result, not the input section
                    quoteResult.style.display = 'block';
                } else {
                    checkAndShowInputSection();
                }
                // Start autosave when in New Quote section (DISC-032)
                startAutosave();
            } else if (section === 'myQuotes') {
                document.getElementById('myQuotesSection').style.display = 'block';
                loadQuotes();
                // Check if first quote celebration should show
                checkAndShowCelebration();
                // Stop autosave when leaving New Quote section (DISC-032)
                stopAutosave();
            } else if (section === 'account') {
                document.getElementById('accountSection').style.display = 'block';
                loadBillingStatus();
                // Stop autosave when leaving New Quote section (DISC-032)
                stopAutosave();
            }
        }

        async function checkAndShowInputSection() {
            try {
                if (!currentUser?.contractor_id) {
                    document.getElementById('onboardingNotice').style.display = 'block';
                    return;
                }

                const response = await fetch(`${API_BASE}/contractors/${currentUser.contractor_id}/pricing`, {
                    headers: { 'Authorization': `Bearer ${authToken}` },
                });

                if (response.ok) {
                    const pricing = await response.json();
                    const hasPricing = pricing && pricing.pricing_knowledge && Object.keys(pricing.pricing_knowledge).length > 0;
                    document.getElementById('onboardingNotice').style.display = hasPricing ? 'none' : 'block';
                    document.getElementById('inputSection').style.display = hasPricing ? 'block' : 'none';
                } else {
                    document.getElementById('onboardingNotice').style.display = 'block';
                }
            } catch (err) {
                console.error('Error checking pricing:', err);
                document.getElementById('onboardingNotice').style.display = 'block';
            }
        }

        // Load quotes from backend
        async function loadQuotes() {
            const listEl = document.getElementById('quoteList');
            const emptyEl = document.getElementById('quoteEmpty');
            const loadingEl = document.getElementById('quoteLoadingState');
            const countEl = document.getElementById('quoteCount');

            listEl.style.display = 'none';
            emptyEl.style.display = 'none';
            loadingEl.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/quotes/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` },
                });

                if (!response.ok) {
                    throw new Error('Failed to load quotes');
                }

                const data = await response.json();
                quotesCache = data.quotes || [];

                countEl.textContent = `${quotesCache.length} quote${quotesCache.length !== 1 ? 's' : ''}`;

                loadingEl.style.display = 'none';
                if (quotesCache.length > 0) {
                    renderQuoteList(quotesCache);
                    listEl.style.display = 'flex';
                } else {
                    emptyEl.style.display = 'block';
                }

                // Check if we should show testimonial modal (after 3rd quote)
                checkAndShowTestimonialModal();

            } catch (err) {
                console.error('Error loading quotes:', err);
                loadingEl.style.display = 'none';
                emptyEl.style.display = 'block';
            }
        }

        // Render quote list using safe DOM methods
        function renderQuoteList(quotes) {
            const listEl = document.getElementById('quoteList');
            listEl.textContent = '';

            quotes.forEach(quote => {
                const item = document.createElement('div');
                item.className = 'quote-list-item';

                const customerName = quote.customer_name || 'Unnamed Customer';
                const jobType = quote.job_type ? quote.job_type.replace(/_/g, ' ') : 'General';
                const total = quote.total || quote.subtotal || 0;
                const createdAt = quote.created_at ? new Date(quote.created_at).toLocaleDateString() : 'Unknown date';
                const lineItemCount = quote.line_items ? quote.line_items.length : 0;
                const wasEdited = quote.was_edited ? ' (edited)' : '';

                // Main clickable area
                const clickableArea = document.createElement('div');
                clickableArea.style.flex = '1';
                clickableArea.style.cursor = 'pointer';
                clickableArea.onclick = () => openQuoteDetail(quote.id);

                // Header row
                const header = document.createElement('div');
                header.className = 'quote-list-item-header';

                const title = document.createElement('div');
                title.className = 'quote-list-item-title';
                title.textContent = customerName + wasEdited;

                const amount = document.createElement('div');
                amount.className = 'quote-list-item-amount';
                amount.textContent = '$' + total.toLocaleString();

                header.appendChild(title);
                header.appendChild(amount);

                // Meta row
                const meta = document.createElement('div');
                meta.className = 'quote-list-item-meta';

                const jobSpan = document.createElement('span');
                jobSpan.textContent = jobType;

                const itemsSpan = document.createElement('span');
                itemsSpan.textContent = lineItemCount + ' item' + (lineItemCount !== 1 ? 's' : '');

                const dateSpan = document.createElement('span');
                dateSpan.textContent = createdAt;

                meta.appendChild(jobSpan);
                meta.appendChild(itemsSpan);
                meta.appendChild(dateSpan);

                clickableArea.appendChild(header);
                clickableArea.appendChild(meta);

                // Actions row (DISC-038: Duplicate button)
                const actions = document.createElement('div');
                actions.className = 'quote-list-item-actions';
                actions.style.display = 'flex';
                actions.style.gap = '8px';
                actions.style.marginTop = '8px';
                actions.style.paddingTop = '8px';
                actions.style.borderTop = '1px solid var(--border)';

                const duplicateBtn = document.createElement('button');
                duplicateBtn.className = 'btn-icon';
                duplicateBtn.title = 'Duplicate this quote';
                duplicateBtn.textContent = '';
                duplicateBtn.onclick = (e) => {
                    e.stopPropagation();
                    duplicateQuoteFromList(quote.id);
                };

                actions.appendChild(duplicateBtn);

                item.appendChild(clickableArea);
                item.appendChild(actions);
                listEl.appendChild(item);
            });
        }

        // Open quote detail view
        async function openQuoteDetail(quoteId) {
            document.getElementById('myQuotesSection').style.display = 'none';
            document.getElementById('quoteDetailView').style.display = 'block';

            // Scroll to quote detail view, accounting for fixed nav
            // Use setTimeout to ensure DOM is updated before scrolling
            setTimeout(() => {
                const quoteDetailView = document.getElementById('quoteDetailView');
                if (quoteDetailView) {
                    quoteDetailView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);

            let quote = quotesCache.find(q => q.id === quoteId);
            if (!quote) {
                try {
                    const response = await fetch(`${API_BASE}/quotes/${quoteId}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` },
                    });
                    if (response.ok) {
                        quote = await response.json();
                    }
                } catch (err) {
                    console.error('Error fetching quote:', err);
                    backToQuoteList();
                    return;
                }
            }

            if (!quote) {
                backToQuoteList();
                return;
            }

            currentDetailQuote = quote;
            originalQuoteState = {
                line_items: JSON.parse(JSON.stringify(quote.line_items || [])),
                job_description: quote.job_description,
                total: quote.total || quote.subtotal || 0
            };
            editedLineItems = JSON.parse(JSON.stringify(quote.line_items || []));
            hasUnsavedChanges = false;

            document.getElementById('detailQuoteTitle').textContent = quote.customer_name || 'Quote Details';
            document.getElementById('detailJobDescription').textContent = quote.job_description || '';
            document.getElementById('detailTotalAmount').textContent = '$' + (quote.total || quote.subtotal || 0).toLocaleString();

            // Update customer info display
            document.getElementById('customerNameDisplay').textContent = quote.customer_name || '';
            document.getElementById('customerAddressDisplay').textContent = quote.customer_address || '';
            document.getElementById('customerPhoneDisplay').textContent = quote.customer_phone || '';

            // DISC-035: Update confidence badge based on category
            updateConfidenceBadge(quote.job_type, 'detailConfidenceBadge');

            if (quote.notes) {
                document.getElementById('detailQuoteNotes').style.display = 'block';
                document.getElementById('detailNotesContent').textContent = quote.notes;
            } else {
                document.getElementById('detailQuoteNotes').style.display = 'none';
            }

            renderEditableLineItems(editedLineItems);

            document.getElementById('editModeBanner').classList.remove('active');
            document.getElementById('saveChangesSection').classList.remove('active');
            document.getElementById('saveChangesBtn').disabled = true;
            document.getElementById('correctionNotes').value = '';
            document.getElementById('changesSummary').textContent = 'No changes made';
        }

        // Render editable line items using safe DOM methods
        function renderEditableLineItems(lineItems) {
            const container = document.getElementById('detailLineItems');
            container.textContent = '';

            lineItems.forEach((item, index) => {
                const lineItemEl = document.createElement('div');
                lineItemEl.className = 'line-item editable';
                lineItemEl.dataset.index = index;

                const editGroup = document.createElement('div');
                editGroup.className = 'line-item-edit-group';

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'line-item-name-input';
                nameInput.value = item.name || item.description || '';
                nameInput.placeholder = 'Item name';
                nameInput.oninput = function() { trackLineItemChange(index, 'name', this.value); };

                const descInput = document.createElement('input');
                descInput.type = 'text';
                descInput.className = 'line-item-desc-input';
                descInput.value = item.details || '';
                descInput.placeholder = 'Description (optional)';
                descInput.oninput = function() { trackLineItemChange(index, 'details', this.value); };

                editGroup.appendChild(nameInput);
                editGroup.appendChild(descInput);

                const amountInput = document.createElement('input');
                amountInput.type = 'number';
                amountInput.className = 'line-item-amount-input';
                amountInput.value = item.amount || 0;
                amountInput.min = '0';
                amountInput.step = '1';
                amountInput.oninput = function() { trackLineItemChange(index, 'amount', this.value); };

                lineItemEl.appendChild(editGroup);
                lineItemEl.appendChild(amountInput);
                container.appendChild(lineItemEl);
            });
        }

        // Track changes to line items
        function trackLineItemChange(index, field, value) {
            if (field === 'amount') {
                editedLineItems[index].amount = parseFloat(value) || 0;
                updateTotalFromLineItems();
            } else if (field === 'name') {
                editedLineItems[index].name = value;
                editedLineItems[index].description = value;
            } else if (field === 'details') {
                editedLineItems[index].details = value;
            }
            checkForChanges();
        }

        function updateTotalFromLineItems() {
            const newTotal = editedLineItems.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            document.getElementById('detailTotalAmount').textContent = '$' + Math.round(newTotal).toLocaleString();
        }

        function checkForChanges() {
            const original = originalQuoteState;
            const edited = editedLineItems;
            let changes = [];
            let totalDiff = 0;

            for (let i = 0; i < edited.length; i++) {
                const origItem = original.line_items[i] || {};
                const editItem = edited[i] || {};

                const origAmount = parseFloat(origItem.amount) || 0;
                const editAmount = parseFloat(editItem.amount) || 0;

                if (origAmount !== editAmount) {
                    const diff = editAmount - origAmount;
                    totalDiff += diff;
                    const itemName = editItem.name || editItem.description || 'Item ' + (i + 1);
                    changes.push(itemName + ': $' + origAmount + ' -> $' + editAmount + ' (' + (diff >= 0 ? '+' : '') + '$' + diff + ')');
                }

                if ((origItem.name || origItem.description) !== (editItem.name || editItem.description)) {
                    changes.push('Renamed: "' + (origItem.name || origItem.description) + '" -> "' + (editItem.name || editItem.description) + '"');
                }
            }

            hasUnsavedChanges = changes.length > 0;

            const editBanner = document.getElementById('editModeBanner');
            const saveSection = document.getElementById('saveChangesSection');
            const saveBtn = document.getElementById('saveChangesBtn');
            const summary = document.getElementById('changesSummary');

            if (hasUnsavedChanges) {
                editBanner.classList.add('active');
                saveSection.classList.add('active');
                saveBtn.disabled = false;

                let summaryText = changes.join('\n');
                if (totalDiff !== 0) {
                    summaryText += '\n\nTotal change: ' + (totalDiff >= 0 ? '+' : '') + '$' + Math.round(totalDiff).toLocaleString();
                }
                summary.textContent = summaryText;
            } else {
                editBanner.classList.remove('active');
                saveSection.classList.remove('active');
                saveBtn.disabled = true;
                summary.textContent = 'No changes made';
            }
        }

        async function saveQuoteChanges() {
            if (!currentDetailQuote || !hasUnsavedChanges) return;

            const saveBtn = document.getElementById('saveChangesBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            const correctionNotes = document.getElementById('correctionNotes').value;

            try {
                const response = await fetch(`${API_BASE}/quotes/${currentDetailQuote.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        line_items: editedLineItems,
                        correction_notes: correctionNotes || null
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save changes');
                }

                const updatedQuote = await response.json();

                const cacheIndex = quotesCache.findIndex(q => q.id === currentDetailQuote.id);
                if (cacheIndex >= 0) {
                    quotesCache[cacheIndex] = updatedQuote;
                }

                currentDetailQuote = updatedQuote;
                originalQuoteState = {
                    line_items: JSON.parse(JSON.stringify(updatedQuote.line_items || [])),
                    job_description: updatedQuote.job_description,
                    total: updatedQuote.total || updatedQuote.subtotal || 0
                };
                hasUnsavedChanges = false;

                saveBtn.textContent = 'Saved!';
                document.getElementById('editModeBanner').classList.remove('active');
                document.getElementById('saveChangesSection').classList.remove('active');

                showLearningToast();

                // Track quote edit
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('quote_edited', {
                        quote_id: currentDetailQuote.id,
                        had_correction_notes: !!correctionNotes
                    });
                }
                {% endif %}

                setTimeout(() => {
                    saveBtn.textContent = 'Save Changes';
                    saveBtn.disabled = true;
                }, 2000);

            } catch (err) {
                console.error('Error saving changes:', err);
                saveBtn.textContent = 'Save Changes';
                saveBtn.disabled = false;
                alert('Failed to save changes: ' + err.message);
            }
        }

        function showLearningToast(message, iconEmoji) {
            let toast = document.getElementById('learningToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'learningToast';
                toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:rgba(34,197,94,0.95);color:white;padding:12px 24px;border-radius:8px;font-size:0.875rem;z-index:1000;opacity:0;transition:opacity 0.3s ease;display:flex;align-items:center;gap:8px;';
                document.body.appendChild(toast);
            }

            toast.textContent = '';
            const icon = document.createElement('span');
            icon.style.fontSize = '1.1rem';
            icon.textContent = iconEmoji || '';
            const text = document.createElement('span');
            text.textContent = message || 'AI learning from your correction...';
            toast.appendChild(icon);
            toast.appendChild(text);
            toast.style.opacity = '1';

            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        }

        function cancelQuoteEdit() {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Are you sure you want to cancel?')) {
                    return;
                }
            }
            backToQuoteList();
        }

        function backToQuoteList() {
            currentDetailQuote = null;
            originalQuoteState = null;
            editedLineItems = [];
            hasUnsavedChanges = false;

            document.getElementById('quoteDetailView').style.display = 'none';
            document.getElementById('myQuotesSection').style.display = 'block';
        }

        async function downloadDetailPdf() {
            if (!currentDetailQuote) return;

            if (hasUnsavedChanges) {
                if (confirm('You have unsaved changes. Save before downloading PDF?')) {
                    await saveQuoteChanges();
                }
            }

            try {
                const response = await fetch(`${API_BASE}/quotes/${currentDetailQuote.id}/pdf`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                });

                if (!response.ok) {
                    throw new Error('Failed to generate PDF');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'quote_' + currentDetailQuote.id.substring(0, 8) + '.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

            } catch (err) {
                console.error('PDF download error:', err);
                alert('Failed to download PDF: ' + err.message);
            }
        }

        // ========================================
        // DISC-038: Quote Duplication Functions
        // ========================================

        // Duplicate quote from detail view
        async function duplicateQuote() {
            if (!currentDetailQuote) return;

            try {
                // Track duplication click event
                if (typeof posthog !== 'undefined') {
                    posthog.capture('quote_duplicate_clicked', {
                        source_quote_id: currentDetailQuote.id,
                        source: 'detail_view'
                    });
                }

                const response = await fetch(`${API_BASE}/quotes/${currentDetailQuote.id}/duplicate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to duplicate quote');
                }

                const newQuote = await response.json();

                // Show success message
                showToast('Quote duplicated successfully! Opening for editing...', 'success');

                // Refresh quotes cache
                await loadQuotes();

                // Open the new quote for editing
                setTimeout(() => {
                    openQuoteDetail(newQuote.id);
                }, 500);

            } catch (err) {
                console.error('Duplication error:', err);
                showToast('Failed to duplicate quote: ' + err.message, 'error');
            }
        }

        // Duplicate quote from list view
        async function duplicateQuoteFromList(quoteId) {
            try {
                // Track duplication click event
                if (typeof posthog !== 'undefined') {
                    posthog.capture('quote_duplicate_clicked', {
                        source_quote_id: quoteId,
                        source: 'list_view'
                    });
                }

                const response = await fetch(`${API_BASE}/quotes/${quoteId}/duplicate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to duplicate quote');
                }

                const newQuote = await response.json();

                // Show success message
                showToast('Quote duplicated successfully! Opening for editing...', 'success');

                // Refresh quotes list
                await loadQuotes();

                // Open the new quote for editing
                setTimeout(() => {
                    openQuoteDetail(newQuote.id);
                }, 500);

            } catch (err) {
                console.error('Duplication error:', err);
                showToast('Failed to duplicate quote: ' + err.message, 'error');
            }
        }

        // ========================================
        // End Quote History & Editing System
        // ========================================

        // ========================================
        // Billing & Subscription System
        // ========================================

        let billingPeriod = 'monthly';
        let currentBillingStatus = null;
        let pricingPlans = [];

        // Load billing status
        async function loadBillingStatus() {
            try {
                // Fetch billing status
                const statusResponse = await fetch(`${API_BASE}/billing/status`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (statusResponse.ok) {
                    currentBillingStatus = await statusResponse.json();
                    updateBillingUI(currentBillingStatus);
                }

                // Fetch pricing plans
                const plansResponse = await fetch(`${API_BASE}/billing/plans`);
                if (plansResponse.ok) {
                    const data = await plansResponse.json();
                    pricingPlans = data.plans || [];
                    renderPricingCards();
                }
            } catch (err) {
                console.error('Failed to load billing status:', err);
            }
        }

        // Update billing UI with status data
        function updateBillingUI(status) {
            // Update usage widget
            const quotesUsed = status.quotes_used || 0;
            const quotesLimit = status.quotes_limit || 75;
            const quotesRemaining = Math.max(0, quotesLimit - quotesUsed);
            const usagePercent = Math.min(100, (quotesUsed / quotesLimit) * 100);

            document.getElementById('currentPlan').textContent = `${status.plan_tier || 'Starter'} Plan`.toUpperCase();
            document.getElementById('usageStats').textContent = `${quotesUsed} / ${quotesLimit}`;
            document.getElementById('usageDetails').textContent = `${quotesRemaining} quote${quotesRemaining !== 1 ? 's' : ''} remaining this month`;

            const usageBarFill = document.getElementById('usageBarFill');
            usageBarFill.style.width = `${usagePercent}%`;

            // Color coding
            usageBarFill.classList.remove('warning', 'critical');
            if (usagePercent >= 90) {
                usageBarFill.classList.add('critical');
            } else if (usagePercent >= 80) {
                usageBarFill.classList.add('warning');
            }

            // Trial banner
            const trialBanner = document.getElementById('trialBanner');
            if (status.trial_ends_at && !status.stripe_subscription_id) {
                const trialEnd = new Date(status.trial_ends_at);
                const daysLeft = Math.ceil((trialEnd - new Date()) / (1000 * 60 * 60 * 24));

                if (daysLeft > 0) {
                    document.getElementById('trialDaysLeft').textContent = `${daysLeft} day${daysLeft !== 1 ? 's' : ''} remaining`;
                    trialBanner.style.display = 'flex';
                } else {
                    trialBanner.style.display = 'none';
                }
            } else {
                trialBanner.style.display = 'none';
            }

            // Billing info grid (for active subscriptions)
            const billingInfoGrid = document.getElementById('billingInfoGrid');
            const manageSubscription = document.getElementById('manageSubscription');

            if (status.stripe_subscription_id) {
                billingInfoGrid.style.display = 'grid';
                manageSubscription.style.display = 'block';

                // Next billing date
                if (status.billing_cycle_start) {
                    const nextBilling = new Date(status.billing_cycle_start);
                    nextBilling.setMonth(nextBilling.getMonth() + 1);
                    document.getElementById('nextBillingDate').textContent = nextBilling.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                }

                // Plan type
                const interval = status.billing_interval === 'year' ? 'Annual' : 'Monthly';
                document.getElementById('planType').textContent = `${status.plan_tier} (${interval})`;

                // Current period
                if (status.billing_cycle_start) {
                    const cycleStart = new Date(status.billing_cycle_start);
                    const cycleEnd = new Date(status.billing_cycle_start);
                    cycleEnd.setMonth(cycleEnd.getMonth() + 1);
                    document.getElementById('currentPeriod').textContent =
                        `${cycleStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${cycleEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                }
            } else {
                billingInfoGrid.style.display = 'none';
                manageSubscription.style.display = 'none';
            }
        }

        // Render pricing cards using safe DOM methods
        function renderPricingCards() {
            const pricingGrid = document.getElementById('pricingGrid');
            const modalPricingGrid = document.getElementById('modalPricingGrid');

            if (!pricingGrid || pricingPlans.length === 0) return;

            // Clear existing content
            pricingGrid.textContent = '';
            if (modalPricingGrid) modalPricingGrid.textContent = '';

            pricingPlans.forEach(plan => {
                const card = createPricingCard(plan);
                pricingGrid.appendChild(card);
                if (modalPricingGrid) {
                    const modalCard = createPricingCard(plan);
                    modalPricingGrid.appendChild(modalCard);
                }
            });
        }

        // Create a pricing card element (safe DOM construction)
        function createPricingCard(plan) {
            // Map API fields to expected names
            const tier = plan.name || plan.tier;
            const monthlyPrice = plan.price_monthly || plan.monthly_price;
            const annualPrice = plan.annual_price || Math.round(monthlyPrice * 10); // 2 months free
            const isFeatured = tier === 'Pro';
            const price = billingPeriod === 'annual' ? annualPrice : monthlyPrice;
            const quotesPerMonth = plan.quotes_per_month;
            const overagePrice = (plan.overage_price ?? plan.overage_price_per_quote ?? 0).toFixed(2);

            const card = document.createElement('div');
            card.className = `pricing-card ${isFeatured ? 'featured' : ''}`;

            // Plan name
            const nameEl = document.createElement('div');
            nameEl.className = 'plan-name';
            nameEl.textContent = tier;
            card.appendChild(nameEl);

            // Price
            const priceEl = document.createElement('div');
            priceEl.className = 'plan-price';

            const currency = document.createElement('span');
            currency.className = 'currency';
            currency.textContent = '$';
            priceEl.appendChild(currency);

            priceEl.appendChild(document.createTextNode(price));

            const period = document.createElement('span');
            period.className = 'period';
            period.textContent = `/${billingPeriod === 'annual' ? 'yr' : 'mo'}`;
            priceEl.appendChild(period);

            card.appendChild(priceEl);

            // Annual note
            if (billingPeriod === 'annual') {
                const annualNote = document.createElement('div');
                annualNote.className = 'plan-annual-note';
                const savings = (monthlyPrice * 12 - annualPrice).toFixed(0);
                annualNote.textContent = `$${annualPrice}/year (save $${savings})`;
                card.appendChild(annualNote);
            }

            // Features list
            const featuresList = document.createElement('ul');
            featuresList.className = 'plan-features';

            const isUnlimited = quotesPerMonth >= 999999;
            const features = [
                { text: isUnlimited ? 'Unlimited quotes' : `${quotesPerMonth} quotes`, bold: true, suffix: isUnlimited ? '' : ' per month' },
                ...(isUnlimited ? [] : [{ text: `$${overagePrice} per extra quote`, bold: false }]),
                { text: 'PDF export', bold: false },
                { text: 'Learning system', bold: false },
                { text: 'Email support', bold: false }
            ];

            features.forEach(feature => {
                const li = document.createElement('li');
                if (feature.bold) {
                    const strong = document.createElement('strong');
                    strong.textContent = feature.text;
                    li.appendChild(strong);
                    if (feature.suffix) {
                        li.appendChild(document.createTextNode(feature.suffix));
                    }
                } else {
                    li.textContent = feature.text;
                }
                featuresList.appendChild(li);
            });

            card.appendChild(featuresList);

            // CTA button
            const btn = document.createElement('button');
            btn.className = `btn ${isFeatured ? 'btn-primary' : 'btn-secondary'}`;
            btn.textContent = `Choose ${tier}`;
            btn.onclick = () => startCheckout(plan.id || tier.toLowerCase(), billingPeriod);
            card.appendChild(btn);

            return card;
        }

        // Toggle billing period
        function toggleBillingPeriod(period) {
            billingPeriod = period;
            document.getElementById('monthlyBtn').classList.toggle('active', period === 'monthly');
            document.getElementById('annualBtn').classList.toggle('active', period === 'annual');
            renderPricingCards();
        }

        // Start Stripe checkout
        async function startCheckout(planTier, interval) {
            // Track upgrade button click
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('upgrade_clicked', {
                    plan_tier: planTier,
                    billing_interval: interval
                });
            }
            {% endif %}

            try {
                const response = await fetch(`${API_BASE}/billing/create-checkout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        plan_tier: planTier,
                        billing_interval: interval,
                        success_url: window.location.origin + '/?checkout=success',
                        cancel_url: window.location.origin + '/?checkout=cancelled'
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create checkout session');
                }

                const data = await response.json();

                // Redirect to Stripe Checkout
                if (data.checkout_url) {
                    window.location.href = data.checkout_url;
                } else {
                    throw new Error('No checkout URL returned');
                }
            } catch (err) {
                console.error('Checkout error:', err);
                showError('Failed to start checkout: ' + err.message);
            }
        }

        // Open Stripe customer portal
        async function openCustomerPortal() {
            try {
                const response = await fetch(`${API_BASE}/billing/portal`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to open portal');
                }

                const data = await response.json();

                if (data.portal_url) {
                    window.location.href = data.portal_url;
                } else {
                    throw new Error('No portal URL returned');
                }
            } catch (err) {
                console.error('Portal error:', err);
                showError('Failed to open billing portal: ' + err.message);
            }
        }

        // Show upgrade section (from trial banner)
        function showUpgradeSection() {
            document.getElementById('pricingSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Single-click upgrade from trial banner
        async function upgradeFromBanner() {
            // Track banner click
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('trial_banner_upgrade_clicked');
            }
            {% endif %}

            // Default to Professional monthly (most common choice)
            await startCheckout('Professional', 'month');
        }

        // Upgrade from quote limit warning
        async function upgradeFromQuoteLimitWarning() {
            // Track warning click
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('quote_limit_warning_upgrade_clicked');
            }
            {% endif %}

            // Default to Professional monthly
            await startCheckout('Professional', 'month');
        }

        // Quick upgrade from modal
        async function quickUpgrade(planTier, interval) {
            // Track quick upgrade click
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('quote_limit_modal_upgrade_clicked', {
                    plan_tier: planTier,
                    interval: interval
                });
            }
            {% endif %}

            await startCheckout(planTier, interval);
        }

        // Upgrade modal
        function showUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'flex';
            loadBillingStatus(); // Refresh pricing in modal

            // Track upgrade modal view
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('upgrade_modal_viewed');
                posthog.capture('quote_limit_modal_shown'); // Legacy event name
            }
            {% endif %}
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'none';
        }

        // Referral functions
        async function loadReferralStats() {
            try {
                const response = await fetch(`${API_BASE}/referral/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('referral-count').textContent = data.referral_count || 0;
                    document.getElementById('referral-credits').textContent = data.referral_credits || 0;
                    // API returns shareable_link, not referral_link
                    document.getElementById('referral-link').value = data.shareable_link || 'Error loading link';

                    // Update email signature text (DISC-021)
                    const signatureText = `PS: I use Quoted for instant voice quotes - Try it free: ${data.shareable_link || 'Error loading link'}`;
                    const emailSignatureEl = document.getElementById('email-signature-text');
                    if (emailSignatureEl) {
                        emailSignatureEl.value = signatureText;
                    }
                } else {
                    console.error('Failed to load referral stats');
                    document.getElementById('referral-link').value = 'Error loading link';
                }
            } catch (error) {
                console.error('Error loading referral stats:', error);
                document.getElementById('referral-link').value = 'Error loading link';
            }
        }

        function copyReferralLink() {
            const link = document.getElementById('referral-link');
            navigator.clipboard.writeText(link.value).then(() => {
                showLearningToast('Referral link copied!', '');
                // Track analytics
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('referral_link_copied');
                }
                {% endif %}
            }).catch(err => {
                console.error('Failed to copy:', err);
                showError('Failed to copy link');
            });
        }

        function shareViaEmail() {
            const link = document.getElementById('referral-link').value;
            const subject = encodeURIComponent('Try Quoted - Voice-to-Quote for Contractors');
            const body = encodeURIComponent(`I've been using Quoted to generate quotes in seconds using just my voice. You should try it!\n\n${link}\n\nYou'll get 14 days free (double the normal trial).`);
            window.open(`mailto:?subject=${subject}&body=${body}`);
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('referral_shared', { method: 'email' });
            }
            {% endif %}
        }

        function shareViaSMS() {
            const link = document.getElementById('referral-link').value;
            const text = encodeURIComponent(`Try Quoted - I use it to generate quotes in seconds with my voice. You get 14 days free: ${link}`);
            window.open(`sms:?body=${text}`);
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('referral_shared', { method: 'sms' });
            }
            {% endif %}
        }

        // Email Signature Referral Hack (DISC-021)
        function copyEmailSignature() {
            const signatureText = document.getElementById('email-signature-text');
            navigator.clipboard.writeText(signatureText.value).then(() => {
                showLearningToast('Signature copied! Paste into your email client.', '');
                // Track analytics
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('referral_signature_copied');
                }
                {% endif %}
            }).catch(err => {
                console.error('Failed to copy:', err);
                showError('Failed to copy signature');
            });
        }

        // ========================================
        // Logo Management (DISC-016)
        // ========================================

        async function loadCurrentLogo() {
            try {
                const response = await fetch(`${API_BASE}/contractors/logo`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.has_logo && data.logo_data) {
                        document.getElementById('logoPreview').src = data.logo_data;
                        document.getElementById('logoPreviewSection').style.display = 'block';
                        document.getElementById('noLogoMessage').style.display = 'none';
                    } else {
                        document.getElementById('logoPreviewSection').style.display = 'none';
                        document.getElementById('noLogoMessage').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading logo:', error);
            }
        }

        async function handleLogoFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Reset messages
            document.getElementById('logoUploadError').style.display = 'none';
            document.getElementById('logoUploadSuccess').style.display = 'none';
            document.getElementById('logoFileName').textContent = file.name;

            // Validate file size (2MB)
            const maxSize = 2 * 1024 * 1024;
            if (file.size > maxSize) {
                document.getElementById('logoUploadError').textContent = `File too large. Maximum size is 2MB, got ${(file.size / 1024 / 1024).toFixed(2)}MB`;
                document.getElementById('logoUploadError').style.display = 'block';
                event.target.value = '';
                return;
            }

            // Validate file type
            if (!['image/png', 'image/jpeg'].includes(file.type)) {
                document.getElementById('logoUploadError').textContent = 'Invalid file type. Only PNG and JPG are allowed.';
                document.getElementById('logoUploadError').style.display = 'block';
                event.target.value = '';
                return;
            }

            // Upload logo
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/contractors/logo`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('logoUploadSuccess').textContent = 'Logo uploaded successfully!';
                    document.getElementById('logoUploadSuccess').style.display = 'block';

                    // Update preview
                    if (data.logo_data) {
                        document.getElementById('logoPreview').src = data.logo_data;
                        document.getElementById('logoPreviewSection').style.display = 'block';
                        document.getElementById('noLogoMessage').style.display = 'none';
                    }

                    // Track analytics
                    {% if posthog_api_key %}
                    if (window.posthog) {
                        posthog.capture('logo_uploaded');
                    }
                    {% endif %}
                } else {
                    const error = await response.json();
                    document.getElementById('logoUploadError').textContent = error.detail || 'Failed to upload logo';
                    document.getElementById('logoUploadError').style.display = 'block';
                }
            } catch (error) {
                console.error('Error uploading logo:', error);
                document.getElementById('logoUploadError').textContent = 'Network error. Please try again.';
                document.getElementById('logoUploadError').style.display = 'block';
            }

            // Reset file input
            event.target.value = '';
        }

        async function removeLogo() {
            if (!confirm('Are you sure you want to remove your logo?')) return;

            try {
                const response = await fetch(`${API_BASE}/contractors/logo`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    document.getElementById('logoPreviewSection').style.display = 'none';
                    document.getElementById('noLogoMessage').style.display = 'block';
                    document.getElementById('logoFileName').textContent = '';

                    showLearningToast('Logo removed successfully', '');

                    // Track analytics
                    {% if posthog_api_key %}
                    if (window.posthog) {
                        posthog.capture('logo_removed');
                    }
                    {% endif %}
                } else {
                    showError('Failed to remove logo');
                }
            } catch (error) {
                console.error('Error removing logo:', error);
                showError('Network error. Please try again.');
            }
        }

        // Close modal on outside click
        document.getElementById('upgradeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUpgradeModal();
            }
        });

        // Edit Customer Modal Functions
        function openEditCustomerModal() {
            if (!currentDetailQuote) return;

            // Pre-fill form with current values
            document.getElementById('editCustomerName').value = currentDetailQuote.customer_name || '';
            document.getElementById('editCustomerAddress').value = currentDetailQuote.customer_address || '';
            document.getElementById('editCustomerPhone').value = currentDetailQuote.customer_phone || '';

            document.getElementById('editCustomerModal').style.display = 'flex';
        }

        function closeEditCustomerModal() {
            document.getElementById('editCustomerModal').style.display = 'none';
            // Hide autocomplete dropdown when modal closes
            document.getElementById('customerAutocomplete').style.display = 'none';
        }

        // ========================================
        // Customer Autocomplete (DISC-022)
        // ========================================
        let customerAutocompleteTimeout = null;
        let customerAutocompleteCache = [];
        let customerAutocompleteUsed = false;

        // Setup autocomplete on customer name field
        function setupCustomerAutocomplete() {
            const nameInput = document.getElementById('editCustomerName');
            const dropdown = document.getElementById('customerAutocomplete');

            if (!nameInput || !dropdown) return;

            // Handle input with debounce
            nameInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();

                // Clear existing timeout
                if (customerAutocompleteTimeout) {
                    clearTimeout(customerAutocompleteTimeout);
                }

                // Hide dropdown if empty query
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                // Debounce API call (300ms)
                customerAutocompleteTimeout = setTimeout(async () => {
                    await fetchCustomerSuggestions(query);
                }, 300);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!nameInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });

            // Handle keyboard navigation
            nameInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                const activeItem = dropdown.querySelector('.autocomplete-item.active');
                let currentIndex = -1;

                if (activeItem) {
                    currentIndex = Array.from(items).indexOf(activeItem);
                }

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    const nextIndex = Math.min(currentIndex + 1, items.length - 1);
                    if (items[nextIndex]) {
                        items.forEach(item => item.classList.remove('active'));
                        items[nextIndex].classList.add('active');
                        items[nextIndex].scrollIntoView({ block: 'nearest' });
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    const prevIndex = Math.max(currentIndex - 1, 0);
                    if (items[prevIndex]) {
                        items.forEach(item => item.classList.remove('active'));
                        items[prevIndex].classList.add('active');
                        items[prevIndex].scrollIntoView({ block: 'nearest' });
                    }
                } else if (e.key === 'Enter') {
                    if (activeItem && dropdown.style.display !== 'none') {
                        e.preventDefault();
                        activeItem.click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Fetch customer suggestions from API
        async function fetchCustomerSuggestions(query) {
            const dropdown = document.getElementById('customerAutocomplete');

            try {
                const response = await fetch(`${API_BASE}/quotes/customers?q=${encodeURIComponent(query)}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const customers = await response.json();
                    customerAutocompleteCache = customers;
                    renderCustomerSuggestions(customers);
                } else {
                    dropdown.style.display = 'none';
                }
            } catch (err) {
                console.error('Error fetching customer suggestions:', err);
                dropdown.style.display = 'none';
            }
        }

        // Render customer suggestions in dropdown
        function renderCustomerSuggestions(customers) {
            const dropdown = document.getElementById('customerAutocomplete');

            if (customers.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-empty">No previous customers found</div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = customers.map(customer => {
                const details = [];
                if (customer.phone) details.push(customer.phone);
                if (customer.email) details.push(customer.email);

                return `
                    <div class="autocomplete-item" data-customer='${JSON.stringify(customer)}'>
                        <div class="autocomplete-item-name">${customer.name || 'Unnamed Customer'}</div>
                        ${details.length > 0 ? `<div class="autocomplete-item-details">${details.join('  ')}</div>` : ''}
                    </div>
                `;
            }).join('');

            dropdown.style.display = 'block';

            // Add click handlers
            dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function() {
                    selectCustomer(JSON.parse(this.dataset.customer));
                });
            });
        }

        // Select a customer from autocomplete
        function selectCustomer(customer) {
            // Fill all customer fields
            document.getElementById('editCustomerName').value = customer.name || '';
            document.getElementById('editCustomerPhone').value = customer.phone || '';

            // Hide dropdown
            document.getElementById('customerAutocomplete').style.display = 'none';

            // Mark that autocomplete was used
            customerAutocompleteUsed = true;

            // Track autocomplete usage (DISC-022)
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('customer_autocomplete_used', {
                    has_phone: !!customer.phone,
                    has_email: !!customer.email,
                    customer_name: customer.name
                });
            }
            {% endif %}
        }

        // Initialize autocomplete when modal opens
        const originalOpenEditCustomerModal = window.openEditCustomerModal;
        window.openEditCustomerModal = function() {
            originalOpenEditCustomerModal();
            // Reset autocomplete flag when modal opens
            customerAutocompleteUsed = false;
            setupCustomerAutocomplete();
        };

        async function saveCustomerInfo(event) {
            event.preventDefault();

            if (!currentDetailQuote) return;

            const customerData = {
                customer_name: document.getElementById('editCustomerName').value.trim(),
                customer_address: document.getElementById('editCustomerAddress').value.trim(),
                customer_phone: document.getElementById('editCustomerPhone').value.trim()
            };

            const saveBtn = document.getElementById('saveCustomerBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const response = await fetch(`${API_BASE}/quotes/${currentDetailQuote.id}/customer`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(customerData)
                });

                if (response.ok) {
                    const updatedQuote = await response.json();

                    // Track manual entry if autocomplete wasn't used (DISC-022)
                    if (!customerAutocompleteUsed && customerData.customer_name) {
                        {% if posthog_api_key %}
                        if (window.posthog) {
                            posthog.capture('customer_manual_entry', {
                                has_phone: !!customerData.customer_phone,
                                has_address: !!customerData.customer_address,
                                customer_name: customerData.customer_name
                            });
                        }
                        {% endif %}
                    }

                    // Update current quote object
                    currentDetailQuote.customer_name = updatedQuote.customer_name;
                    currentDetailQuote.customer_address = updatedQuote.customer_address;
                    currentDetailQuote.customer_phone = updatedQuote.customer_phone;

                    // Update display
                    document.getElementById('detailQuoteTitle').textContent = updatedQuote.customer_name || 'Quote Details';
                    document.getElementById('customerNameDisplay').textContent = updatedQuote.customer_name || '';
                    document.getElementById('customerAddressDisplay').textContent = updatedQuote.customer_address || '';
                    document.getElementById('customerPhoneDisplay').textContent = updatedQuote.customer_phone || '';

                    // Update quotes cache
                    const cacheIndex = quotesCache.findIndex(q => q.id === currentDetailQuote.id);
                    if (cacheIndex !== -1) {
                        quotesCache[cacheIndex] = { ...quotesCache[cacheIndex], ...updatedQuote };
                    }

                    closeEditCustomerModal();
                } else {
                    const error = await response.json();
                    alert('Failed to update customer info: ' + (error.detail || 'Unknown error'));
                }
            } catch (err) {
                console.error('Error saving customer info:', err);
                alert('Network error. Please try again.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        // Share Quote Functions
        let currentShareUrl = '';

        async function openShareModal() {
            if (!currentDetailQuote) return;

            // Track modal opened
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('share_modal_opened', {
                    quote_id: currentDetailQuote.id
                });
            }
            {% endif %}

            // Pre-fill customer email if available
            const customerEmail = currentDetailQuote.customer_email || '';
            document.getElementById('shareRecipientEmail').value = customerEmail;
            document.getElementById('shareMessage').value = '';

            // Generate share link
            try {
                const response = await fetch(`${API_BASE}/quotes/${currentDetailQuote.id}/share`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentShareUrl = data.share_url;
                    document.getElementById('shareUrl').value = currentShareUrl;
                } else {
                    console.error('Failed to generate share link');
                    currentShareUrl = '';
                }
            } catch (err) {
                console.error('Error generating share link:', err);
            }

            // Reset to email tab
            showShareTab('email');

            // Load referral code
            await loadShareModalReferralCode();

            // Track referral shown
            {% if posthog_api_key %}
            if (window.posthog) {
                posthog.capture('referral_shown_in_share');
            }
            {% endif %}

            // Show modal
            document.getElementById('shareModal').style.display = 'flex';
        }

        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
            document.getElementById('copySuccessMessage').style.display = 'none';
        }

        function showShareTab(tab) {
            // Update tab buttons
            document.getElementById('shareEmailTabBtn').classList.toggle('active', tab === 'email');
            document.getElementById('shareLinkTabBtn').classList.toggle('active', tab === 'link');

            // Update tab content
            document.getElementById('shareEmailTab').classList.toggle('active', tab === 'email');
            document.getElementById('shareLinkTab').classList.toggle('active', tab === 'link');
        }

        async function sendShareEmail() {
            if (!currentDetailQuote) return;

            const recipientEmail = document.getElementById('shareRecipientEmail').value.trim();
            const message = document.getElementById('shareMessage').value.trim();

            if (!recipientEmail) {
                alert('Please enter a customer email address');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(recipientEmail)) {
                alert('Please enter a valid email address');
                return;
            }

            const sendBtn = document.getElementById('sendShareEmailBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            try {
                const response = await fetch(`${API_BASE}/quotes/${currentDetailQuote.id}/share/email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        recipient_email: recipientEmail,
                        message: message
                    })
                });

                if (response.ok) {
                    // Track email sent
                    {% if posthog_api_key %}
                    if (window.posthog) {
                        posthog.capture('share_email_sent', {
                            quote_id: currentDetailQuote.id
                        });
                    }
                    {% endif %}

                    alert('Quote sent successfully!');
                    closeShareModal();
                } else {
                    const error = await response.json();
                    alert('Failed to send email: ' + (error.detail || 'Unknown error'));
                }
            } catch (err) {
                console.error('Error sending share email:', err);
                alert('Network error. Please try again.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Email';
            }
        }

        async function copyShareLink() {
            if (!currentShareUrl) {
                alert('Share link not available');
                return;
            }

            try {
                await navigator.clipboard.writeText(currentShareUrl);

                // Track link copied
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('share_link_copied', {
                        quote_id: currentDetailQuote.id
                    });
                }
                {% endif %}

                // Show success message
                const successMsg = document.getElementById('copySuccessMessage');
                successMsg.style.display = 'block';

                // Hide after 3 seconds
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);
            } catch (err) {
                console.error('Failed to copy link:', err);
                // Fallback for older browsers
                const input = document.getElementById('shareUrl');
                input.select();
                document.execCommand('copy');

                const successMsg = document.getElementById('copySuccessMessage');
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);
            }
        }

        // Close share modal on outside click
        document.getElementById('shareModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeShareModal();
            }
        });

        // Close edit customer modal on outside click
        document.getElementById('editCustomerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditCustomerModal();
            }
        });

        // Handle 402 Payment Required responses globally
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            const response = await originalFetch(...args);

            if (response.status === 402) {
                // Clone response to read error
                const clonedResponse = response.clone();
                try {
                    const errorData = await clonedResponse.json();
                    showError(errorData.detail || 'Quote limit reached. Please upgrade to continue.');

                    // Track quote limit reached
                    {% if posthog_api_key %}
                    if (window.posthog) {
                        posthog.capture('quote_limit_reached');
                    }
                    {% endif %}

                    showUpgradeModal();
                } catch {
                    showError('Quote limit reached. Please upgrade to continue.');

                    // Track quote limit reached
                    {% if posthog_api_key %}
                    if (window.posthog) {
                        posthog.capture('quote_limit_reached');
                    }
                    {% endif %}

                    showUpgradeModal();
                }
            }

            return response;
        };

        // ========================================
        // End Billing & Subscription System
        // ========================================

        // ========================================
        // Pricing Brain Management
        // ========================================

        let currentCategory = null;
        let pricingBrainData = null;

        // Account tab switching
        function showAccountTab(tab) {
            // Update tab buttons
            document.getElementById('billingTabBtn').classList.toggle('active', tab === 'billing');
            document.getElementById('referralTabBtn').classList.toggle('active', tab === 'referral');
            document.getElementById('logoTabBtn').classList.toggle('active', tab === 'logo');
            document.getElementById('pricingBrainTabBtn').classList.toggle('active', tab === 'pricingBrain');

            // Update tab content
            document.getElementById('billingTabContent').classList.toggle('active', tab === 'billing');
            document.getElementById('referralTabContent').classList.toggle('active', tab === 'referral');
            document.getElementById('logoTabContent').classList.toggle('active', tab === 'logo');
            document.getElementById('pricingBrainTabContent').classList.toggle('active', tab === 'pricingBrain');

            // Load data when switching tabs
            if (tab === 'pricingBrain') {
                loadPricingBrain();
            } else if (tab === 'billing') {
                loadBillingStatus();
            } else if (tab === 'logo') {
                loadCurrentLogo();
            } else if (tab === 'referral') {
                loadReferralStats();
                // Track referral signature section view (DISC-021)
                {% if posthog_api_key %}
                if (window.posthog) {
                    posthog.capture('referral_signature_section_viewed');
                }
                {% endif %}
            }
        }

        // Load pricing brain data
        async function loadPricingBrain() {
            try {
                // Fetch learning progress (DISC-008)
                try {
                    const progressResponse = await fetch(`${API_BASE}/learning/progress`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (progressResponse.ok) {
                        const progressData = await progressResponse.json();
                        renderLearningProgress(progressData);
                    }
                } catch (e) {
                    console.error('Failed to load learning progress:', e);
                }

                // Fetch all categories
                const response = await fetch(`${API_BASE}/pricing-brain`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load pricing brain data');
                }

                const categoriesData = await response.json();

                // API returns array of categories directly
                pricingBrainData = { categories: categoriesData };

                // Fetch and render global settings from separate endpoint
                try {
                    const settingsResponse = await fetch(`${API_BASE}/pricing-brain/settings/global`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (settingsResponse.ok) {
                        const globalSettings = await settingsResponse.json();
                        renderGlobalSettings({
                            hourly_rate: globalSettings.labor_rate_hourly,
                            material_markup: globalSettings.material_markup_percent,
                            minimum_job: globalSettings.minimum_job_amount
                        });
                    } else {
                        renderGlobalSettings({});
                    }
                } catch (e) {
                    renderGlobalSettings({});
                }

                // Render category cards
                renderCategoryCards(categoriesData);

            } catch (err) {
                console.error('Failed to load pricing brain:', err);
                showError('Failed to load pricing brain data. Please try again.');
            }
        }

        // Sync categories from existing quotes (for legacy accounts)
        async function syncPricingBrain() {
            const btn = document.getElementById('syncCategoriesBtn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Syncing...';
            }

            try {
                const response = await fetch(`${API_BASE}/pricing-brain/sync`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to sync categories');
                }

                const result = await response.json();

                // Show success message
                if (result.categories_added > 0) {
                    showLearningToast(`Synced ${result.categories_added} categories from your quotes!`, '');
                } else if (result.categories_found && result.categories_found.length === 0) {
                    showLearningToast('No quotes found to sync. Generate some quotes first!', '');
                } else {
                    showLearningToast('Categories already synced - no new categories to add.', '');
                }

                // Reload the pricing brain data
                await loadPricingBrain();

            } catch (err) {
                console.error('Failed to sync pricing brain:', err);
                showError('Failed to sync categories. Please try again.');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Sync Categories from Quotes';
                }
            }
        }

        // Render learning progress (DISC-008)
        function renderLearningProgress(data) {
            const section = document.getElementById('learningProgressSection');

            // Show section if we have data
            if (data && data.total_quotes > 0) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
                return;
            }

            // Update progress percentage
            document.getElementById('learningProgressPercent').textContent = `${data.learning_progress_percent}%`;
            document.getElementById('learningProgressBar').style.width = `${data.learning_progress_percent}%`;

            // Update subtitle based on progress
            let subtitle = '';
            if (data.learning_progress_percent >= 80) {
                subtitle = 'Your AI is highly confident in most categories';
            } else if (data.learning_progress_percent >= 50) {
                subtitle = 'Your AI is learning quickly, keep making corrections';
            } else if (data.learning_progress_percent >= 20) {
                subtitle = 'Your AI is building knowledge, corrections help it learn faster';
            } else {
                subtitle = 'Your AI is just getting started, each correction teaches it';
            }
            document.getElementById('learningProgressSubtitle').textContent = subtitle;

            // Update stats
            document.getElementById('totalQuotesStat').textContent = data.total_quotes;
            document.getElementById('totalCorrectionsStat').textContent = data.total_corrections;
            document.getElementById('categoriesLearnedStat').textContent = `${data.categories_learned}/${data.total_categories}`;

            // Update learning velocity with emoji
            let velocityText = '';
            switch(data.learning_velocity) {
                case 'fast':
                    velocityText = ' Fast';
                    break;
                case 'steady':
                    velocityText = ' Steady';
                    break;
                case 'slow':
                    velocityText = ' Slow';
                    break;
                default:
                    velocityText = ' Starting';
            }
            document.getElementById('learningVelocityStat').textContent = velocityText;

            // Render top categories
            const categoriesList = document.getElementById('topCategoriesList');
            categoriesList.textContent = '';

            if (data.top_categories && data.top_categories.length > 0) {
                data.top_categories.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'category-progress-item';

                    const info = document.createElement('div');
                    info.className = 'category-progress-info';

                    const name = document.createElement('div');
                    name.className = 'category-progress-name';
                    name.textContent = cat.display_name;
                    info.appendChild(name);

                    const meta = document.createElement('div');
                    meta.className = 'category-progress-meta';
                    meta.textContent = `${cat.quotes} quotes, ${cat.corrections} corrections`;
                    info.appendChild(meta);

                    item.appendChild(info);

                    const badge = document.createElement('div');
                    badge.className = 'category-confidence-badge';

                    const confidenceValue = document.createElement('span');
                    confidenceValue.className = 'confidence-value';
                    confidenceValue.textContent = `${cat.confidence}%`;
                    badge.appendChild(confidenceValue);

                    const miniBar = document.createElement('div');
                    miniBar.className = 'confidence-bar-mini';
                    const fill = document.createElement('div');
                    fill.className = 'confidence-bar-fill';
                    fill.style.width = `${cat.confidence}%`;
                    miniBar.appendChild(fill);
                    badge.appendChild(miniBar);

                    item.appendChild(badge);
                    categoriesList.appendChild(item);
                });
            } else {
                const empty = document.createElement('p');
                empty.style.color = 'var(--text-secondary)';
                empty.style.textAlign = 'center';
                empty.textContent = 'No categories learned yet. Generate and correct quotes to start learning.';
                categoriesList.appendChild(empty);
            }
        }

        // Render global settings
        function renderGlobalSettings(settings) {
            const container = document.getElementById('globalSettingsGrid');
            container.textContent = ''; // Clear existing

            const settingsToShow = [
                { label: 'Hourly Rate', value: settings.hourly_rate ? `$${settings.hourly_rate}/hr` : 'Not set' },
                { label: 'Material Markup', value: settings.material_markup ? `${settings.material_markup}%` : 'Not set' },
                { label: 'Minimum Job', value: settings.minimum_job ? `$${settings.minimum_job}` : 'Not set' }
            ];

            settingsToShow.forEach(setting => {
                const item = document.createElement('div');
                item.className = 'global-setting-item';

                const label = document.createElement('div');
                label.className = 'global-setting-label';
                label.textContent = setting.label;
                item.appendChild(label);

                const value = document.createElement('div');
                value.className = 'global-setting-value';
                value.textContent = setting.value;
                item.appendChild(value);

                container.appendChild(item);
            });
        }

        // Render category cards
        function renderCategoryCards(categories) {
            const container = document.getElementById('categoryCardsGrid');
            const emptyState = document.getElementById('categoriesEmptyState');

            container.textContent = ''; // Clear existing

            if (!categories || categories.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            categories.forEach(category => {
                const card = createCategoryCard(category);
                container.appendChild(card);
            });
        }

        // Create a category card element (safe DOM construction)
        function createCategoryCard(category) {
            const card = document.createElement('div');
            card.className = 'category-card';
            card.onclick = () => openEditCategoryModal(category.category);

            // Header with name and confidence badge
            const header = document.createElement('div');
            header.className = 'category-card-header';

            const nameDiv = document.createElement('div');
            const name = document.createElement('div');
            name.className = 'category-name';
            name.textContent = category.display_name || category.category;
            nameDiv.appendChild(name);
            header.appendChild(nameDiv);

            const confidence = category.confidence_level || 'low';
            const badge = document.createElement('div');
            badge.className = `category-badge ${confidence === 'high' ? 'high-confidence' : confidence === 'medium' ? 'medium-confidence' : ''}`;
            badge.textContent = confidence;
            header.appendChild(badge);

            card.appendChild(header);

            // Stats grid
            const stats = document.createElement('div');
            stats.className = 'category-stats';

            const quotesCount = category.quotes_count || 0;
            const rulesCount = (category.learned_rules || []).length;

            // Quote stat
            const quoteStat = document.createElement('div');
            quoteStat.className = 'category-stat';

            const quoteValue = document.createElement('div');
            quoteValue.className = 'category-stat-value';
            quoteValue.textContent = quotesCount;
            quoteStat.appendChild(quoteValue);

            const quoteLabel = document.createElement('div');
            quoteLabel.className = 'category-stat-label';
            quoteLabel.textContent = 'Quotes';
            quoteStat.appendChild(quoteLabel);

            stats.appendChild(quoteStat);

            // Rules stat
            const rulesStat = document.createElement('div');
            rulesStat.className = 'category-stat';

            const rulesValue = document.createElement('div');
            rulesValue.className = 'category-stat-value';
            rulesValue.textContent = rulesCount;
            rulesStat.appendChild(rulesValue);

            const rulesLabel = document.createElement('div');
            rulesLabel.className = 'category-stat-label';
            rulesLabel.textContent = 'Rules';
            rulesStat.appendChild(rulesLabel);

            stats.appendChild(rulesStat);

            card.appendChild(stats);

            // Rules preview (if any)
            if (rulesCount > 0) {
                const rulesPreview = document.createElement('div');
                rulesPreview.className = 'category-rules-preview';

                const rules = category.learned_rules.slice(0, 2);
                rules.forEach(rule => {
                    const p = document.createElement('p');
                    p.textContent = ` ${rule}`;
                    rulesPreview.appendChild(p);
                });

                if (category.learned_rules.length > 2) {
                    const more = document.createElement('p');
                    more.style.fontStyle = 'italic';
                    more.textContent = `+${category.learned_rules.length - 2} more...`;
                    rulesPreview.appendChild(more);
                }

                card.appendChild(rulesPreview);
            }

            return card;
        }

        // Open edit category modal
        async function openEditCategoryModal(categoryName) {
            try {
                // Fetch full category details
                const response = await fetch(`${API_BASE}/pricing-brain/${encodeURIComponent(categoryName)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load category details');
                }

                currentCategory = await response.json();

                // Populate form
                document.getElementById('editCategoryName').value = currentCategory.display_name || currentCategory.category;
                document.getElementById('editRateModifier').value = currentCategory.rate_modifier || 0;
                document.getElementById('editLearnedRules').value = (currentCategory.learned_rules || []).join('\n');

                // Show pattern hints (from stored corrections)
                renderPatternHints(currentCategory);

                // Hide AI analysis initially
                document.getElementById('aiAnalysisContainer').style.display = 'none';

                // Update subtitle
                document.getElementById('categoryModalSubtitle').textContent =
                    `${currentCategory.quotes_count || 0} quotes  ${currentCategory.confidence_level || 'low'} confidence`;

                // Show modal
                document.getElementById('editCategoryModal').style.display = 'flex';

            } catch (err) {
                console.error('Failed to open category modal:', err);
                showError('Failed to load category details. Please try again.');
            }
        }

        // Render pattern hints (instant, no API cost)
        function renderPatternHints(category) {
            const container = document.getElementById('patternHintsContainer');
            container.textContent = ''; // Clear

            const patterns = category.pattern_hints || [];

            if (patterns.length === 0) {
                const empty = document.createElement('p');
                empty.style.color = 'var(--text-muted)';
                empty.style.fontStyle = 'italic';
                empty.textContent = 'No patterns detected yet. Make more corrections to build pattern hints.';
                container.appendChild(empty);
                return;
            }

            patterns.forEach(pattern => {
                const p = document.createElement('p');
                p.style.marginBottom = '8px';
                p.style.color = 'var(--text-secondary)';
                p.textContent = ` ${pattern}`;
                container.appendChild(p);
            });
        }

        // Run AI analysis (on-demand, uses Haiku)
        async function runAIAnalysis() {
            if (!currentCategory) return;

            const analyzeBtn = document.getElementById('analyzeBtn');
            const container = document.getElementById('aiAnalysisContainer');

            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Analyzing...';

            try {
                const response = await fetch(`${API_BASE}/pricing-brain/${encodeURIComponent(currentCategory.category)}/analyze`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error('AI analysis failed');
                }

                const result = await response.json();

                // Show analysis
                container.style.display = 'block';
                container.textContent = ''; // Clear

                const analysis = document.createElement('div');
                analysis.style.whiteSpace = 'pre-wrap';
                analysis.style.color = 'var(--text-secondary)';
                analysis.style.lineHeight = '1.6';
                analysis.textContent = result.analysis || 'No insights available.';
                container.appendChild(analysis);

            } catch (err) {
                console.error('AI analysis error:', err);
                showError('AI analysis failed. Please try again.');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze with AI';
            }
        }

        // Save category changes
        async function saveCategoryChanges(event) {
            event.preventDefault();
            if (!currentCategory) return;

            const saveBtn = document.getElementById('saveCategoryBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const updates = {
                    display_name: document.getElementById('editCategoryName').value.trim(),
                    rate_modifier: parseFloat(document.getElementById('editRateModifier').value) || 0,
                    learned_rules: document.getElementById('editLearnedRules').value
                        .split('\n')
                        .map(rule => rule.trim())
                        .filter(rule => rule.length > 0)
                };

                const response = await fetch(`${API_BASE}/pricing-brain/${encodeURIComponent(currentCategory.category)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(updates)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save changes');
                }

                // Refresh and close
                await loadPricingBrain();
                closeEditCategoryModal();
                showLearningToast('Category updated successfully');

            } catch (err) {
                console.error('Save error:', err);
                showError('Failed to save changes: ' + err.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        // Confirm and delete category
        function confirmDeleteCategory() {
            if (!currentCategory) return;

            const confirmed = confirm(`Are you sure you want to delete the "${currentCategory.display_name || currentCategory.category}" category?\n\nThis will remove all learned patterns and rules for this category. This action cannot be undone.`);

            if (confirmed) {
                deleteCategory();
            }
        }

        // Delete category
        async function deleteCategory() {
            if (!currentCategory) return;

            try {
                const response = await fetch(`${API_BASE}/pricing-brain/${encodeURIComponent(currentCategory.category)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete category');
                }

                // Refresh and close
                await loadPricingBrain();
                closeEditCategoryModal();
                showLearningToast('Category deleted successfully');

            } catch (err) {
                console.error('Delete error:', err);
                showError('Failed to delete category: ' + err.message);
            }
        }

        // Close edit category modal
        function closeEditCategoryModal() {
            document.getElementById('editCategoryModal').style.display = 'none';
            currentCategory = null;
        }

        // Close modal on outside click
        document.getElementById('editCategoryModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditCategoryModal();
            }
        });

        // ========================================
        // End Pricing Brain Management

        // Global Settings Management
        let currentGlobalSettings = null;

        // Open edit global settings modal
        async function openEditGlobalSettingsModal() {
            try {
                // Fetch current settings
                const response = await fetch(`${API_BASE}/pricing-brain/settings/global`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load global settings');
                }

                currentGlobalSettings = await response.json();

                // Populate form with current values
                document.getElementById('editLaborRate').value = currentGlobalSettings.labor_rate_hourly || '';
                document.getElementById('editHelperRate').value = currentGlobalSettings.helper_rate_hourly || '';
                document.getElementById('editMaterialMarkup').value = currentGlobalSettings.material_markup_percent || '';
                document.getElementById('editMinimumJob').value = currentGlobalSettings.minimum_job_amount || '';
                document.getElementById('editPricingNotes').value = currentGlobalSettings.pricing_notes || '';

                // Show modal
                document.getElementById('editGlobalSettingsModal').style.display = 'flex';

            } catch (err) {
                console.error('Failed to open global settings modal:', err);
                showError('Failed to load global settings. Please try again.');
            }
        }

        // Close edit global settings modal
        function closeEditGlobalSettingsModal() {
            document.getElementById('editGlobalSettingsModal').style.display = 'none';
            currentGlobalSettings = null;
        }

        // Save global settings
        async function saveGlobalSettings(event) {
            event.preventDefault();

            const saveBtn = document.getElementById('saveGlobalSettingsBtn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                // Get form values (parse as floats or null)
                const laborRate = document.getElementById('editLaborRate').value;
                const helperRate = document.getElementById('editHelperRate').value;
                const materialMarkup = document.getElementById('editMaterialMarkup').value;
                const minimumJob = document.getElementById('editMinimumJob').value;
                const pricingNotes = document.getElementById('editPricingNotes').value;

                // Validation
                if (materialMarkup && (parseFloat(materialMarkup) < 0 || parseFloat(materialMarkup) > 100)) {
                    showError('Material markup must be between 0 and 100');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    return;
                }

                if (laborRate && parseFloat(laborRate) < 0) {
                    showError('Labor rate must be positive');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    return;
                }

                if (helperRate && parseFloat(helperRate) < 0) {
                    showError('Helper rate must be positive');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    return;
                }

                if (minimumJob && parseFloat(minimumJob) < 0) {
                    showError('Minimum job amount must be positive');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    return;
                }

                // Build update object
                const updateData = {
                    labor_rate_hourly: laborRate ? parseFloat(laborRate) : null,
                    helper_rate_hourly: helperRate ? parseFloat(helperRate) : null,
                    material_markup_percent: materialMarkup ? parseFloat(materialMarkup) : null,
                    minimum_job_amount: minimumJob ? parseFloat(minimumJob) : null,
                    pricing_notes: pricingNotes || null
                };

                // Send update request
                const response = await fetch(`${API_BASE}/pricing-brain/settings/global`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update global settings');
                }

                const updatedSettings = await response.json();

                // Show success message
                showLearningToast('Global settings updated successfully!', '');

                // Update display
                renderGlobalSettings({
                    hourly_rate: updatedSettings.labor_rate_hourly,
                    material_markup: updatedSettings.material_markup_percent,
                    minimum_job: updatedSettings.minimum_job_amount
                });

                // Close modal
                closeEditGlobalSettingsModal();

            } catch (err) {
                console.error('Failed to save global settings:', err);
                showError(err.message || 'Failed to save global settings. Please try again.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        // Close modal on outside click
        document.getElementById('editGlobalSettingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditGlobalSettingsModal();
            }
        });
        // ========================================

        // Error capture
        window.lastJsError = null;
        window.onerror = function(message, source, lineno, colno, error) {
            window.lastJsError = `${message} at ${source}:${lineno}:${colno}`;
        };

        // Close modal on outside click
        document.getElementById('issueModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeIssueModal();
            }
        });

        // ========================================
        // First Quote Activation Flow
        // ========================================
        const SAMPLE_JOB = "Quote for Sarah at 456 Oak Drive - kitchen cabinet refacing, about 20 linear feet of base cabinets and 15 feet of uppers, replacing hinges and adding soft-close, standard white paint finish.";

        function showFirstQuoteModal() {
            const modal = document.getElementById('first-quote-modal');
            if (modal) {
                modal.style.display = 'flex';
                // Track modal view
                if (window.posthog) {
                    posthog.capture('first_quote_modal_shown');
                }
            }
        }

        function closeFirstQuoteModal() {
            const modal = document.getElementById('first-quote-modal');
            if (modal) {
                modal.style.display = 'none';
                // Track skip
                if (window.posthog) {
                    posthog.capture('first_quote_modal_skipped');
                }
            }
            // Mark as seen
            localStorage.setItem('first_quote_modal_seen', 'true');
        }

        function startFirstQuote(method) {
            closeFirstQuoteModal();

            // Track choice
            if (window.posthog) {
                posthog.capture('first_quote_started', { method: method });
            }

            // Navigate to new quote section
            showAppSection('newQuote');

            if (method === 'text') {
                // Pre-fill the text input with sample job
                const textInput = document.getElementById('jobDescription');
                if (textInput) {
                    textInput.value = SAMPLE_JOB;
                    textInput.focus();
                }
            } else if (method === 'voice') {
                // Focus the record button
                const recordBtn = document.getElementById('recordBtn');
                if (recordBtn) {
                    recordBtn.focus();
                }
            }
        }

        // Check if user just completed onboarding and hasn't seen modal
        function checkFirstQuoteActivation() {
            const hasSeenModal = localStorage.getItem('first_quote_modal_seen');
            const justCompletedOnboarding = localStorage.getItem('just_completed_onboarding');

            if (justCompletedOnboarding && !hasSeenModal) {
                // Clear the flag
                localStorage.removeItem('just_completed_onboarding');
                // Show modal after a brief delay
                setTimeout(showFirstQuoteModal, 500);
            }
        }

        // Close modal on backdrop click
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('first-quote-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal || e.target.classList.contains('modal-backdrop')) {
                        closeFirstQuoteModal();
                    }
                });
            }

            // Add event listener for testimonial character count
            const testimonialText = document.getElementById('testimonialText');
            if (testimonialText) {
                testimonialText.addEventListener('input', function() {
                    const count = this.value.length;
                    document.getElementById('testimonialCharCount').textContent = count;
                    updateTestimonialSubmitButton();
                });
            }
        });

        // ============================================================================
        // TESTIMONIAL COLLECTION (DISC-010)
        // ============================================================================

        let selectedTestimonialRating = 0;

        function setTestimonialRating(rating) {
            selectedTestimonialRating = rating;

            // Update star display
            const stars = document.querySelectorAll('#starRating .star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.textContent = '';
                    star.style.color = '#fbbf24'; // Gold color
                } else {
                    star.textContent = '';
                    star.style.color = 'var(--text-secondary)';
                }
            });

            updateTestimonialSubmitButton();
        }

        function toggleAttribution() {
            const checkbox = document.getElementById('includeAttribution');
            const fields = document.getElementById('attributionFields');
            fields.style.display = checkbox.checked ? 'block' : 'none';
        }

        function updateTestimonialSubmitButton() {
            const btn = document.getElementById('submitTestimonialBtn');
            const text = document.getElementById('testimonialText').value.trim();
            const hasRating = selectedTestimonialRating > 0;
            const hasText = text.length >= 10; // Minimum 10 characters

            btn.disabled = !(hasRating && hasText);
        }

        async function submitTestimonial() {
            const btn = document.getElementById('submitTestimonialBtn');
            const text = document.getElementById('testimonialText').value.trim();
            const includeAttr = document.getElementById('includeAttribution').checked;
            const name = includeAttr ? document.getElementById('testimonialName').value.trim() : null;
            const company = includeAttr ? document.getElementById('testimonialCompany').value.trim() : null;

            if (!selectedTestimonialRating || !text) {
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Submitting...';

            try {
                const response = await fetch(`${API_BASE}/testimonials/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        rating: selectedTestimonialRating,
                        quote_text: text,
                        name: name || null,
                        company: company || null
                    })
                });

                if (response.ok) {
                    // Track submission
                    {% if posthog_api_key %}
                    if (window.posthog) {
                        posthog.capture('testimonial_submitted', {
                            rating: selectedTestimonialRating,
                            has_attribution: includeAttr
                        });
                    }
                    {% endif %}

                    // Mark as submitted in localStorage
                    localStorage.setItem('testimonial_submitted', 'true');

                    // Close modal and show thank you
                    closeTestimonialModal();
                    showNotification('Thank you for your feedback!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to submit testimonial', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Submit Feedback';
                }
            } catch (error) {
                console.error('Error submitting testimonial:', error);
                showNotification('Failed to submit testimonial', 'error');
                btn.disabled = false;
                btn.textContent = 'Submit Feedback';
            }
        }

        function closeTestimonialModal() {
            const modal = document.getElementById('testimonialModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function checkAndShowTestimonialModal() {
            // Only show if user hasn't submitted testimonial yet
            const hasSubmitted = localStorage.getItem('testimonial_submitted');
            if (hasSubmitted) {
                return;
            }

            // Check if user already submitted via API (in case they submitted from different device)
            try {
                const response = await fetch(`${API_BASE}/testimonials/check-submitted`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.has_submitted) {
                        localStorage.setItem('testimonial_submitted', 'true');
                        return;
                    }
                }
            } catch (error) {
                console.error('Error checking testimonial status:', error);
                return;
            }

            // Count total quotes generated
            try {
                const response = await fetch(`${API_BASE}/quotes/`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const quotes = await response.json();

                    // Show modal after 3rd quote
                    if (quotes.length === 3) {
                        // Track modal shown
                        {% if posthog_api_key %}
                        if (window.posthog) {
                            posthog.capture('testimonial_modal_shown');
                        }
                        {% endif %}

                        // Show modal after brief delay
                        setTimeout(() => {
                            const modal = document.getElementById('testimonialModal');
                            if (modal) {
                                modal.style.display = 'flex';
                            }
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('Error checking quotes for testimonial trigger:', error);
            }
        }
    </script>
</body>
</html>
